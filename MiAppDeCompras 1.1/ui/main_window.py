# -*- coding: utf-8 -*-
"""Aplicacion de Gestion de Ordenes de Compra Completa

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1girj0-C3ULkEYr2zC4J4w_QRLYAwhvOQ
"""

import sqlite3
import bcrypt
from datetime import datetime, timedelta
import json
import os
import re
import sys
import time
import tempfile # For creating temporary files
import csv # For CSV export
import logging # For logging

# Importaciones necesarias de PyQt5
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QStackedWidget, QDialog, QLabel, QLineEdit, QMessageBox,
    QFormLayout, QDateEdit, QComboBox, QTableWidget, QHeaderView,
    QAbstractItemView, QFileDialog, QProgressDialog, QGroupBox, QDialogButtonBox,
    QTableWidgetItem # IMPORTANT: Add this import!
)
from PyQt5.QtGui import QDoubleValidator, QFont, QDesktopServices
from PyQt5.QtCore import Qt, QDate, QUrl

# Importaciones necesarias de ReportLab para la generación de PDFs
from reportlab.lib import colors
from reportlab.lib.pagesizes import letter
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm

# Asegúrate de tener instaladas las siguientes bibliotecas:
# pip install PyQt5 pdfplumber python-docx reportlab bcrypt

# --- Configuración general de la aplicación ---
# It is recommended to move this to a separate file in a real production environment.
class ConfiguracionAplicacion:
    NOMBRE_BD: str = 'compras.db'
    USUARIO_ADMIN_POR_DEFECTO: str = 'admin'
    CONTRASENA_ADMIN_POR_DEFECTO: str = 'admin123' # IMPORTANT: Change this in a production environment!
    TASA_IVA: float = 0.16 # IVA rate (16%)
    LONGITUD_MINIMA_CONTRASENA: int = 6 # Minimum password length

# Configuración del registro de eventos
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Clase para la gestión de la base de datos ---
class GestorBaseDeDatos:
    """
    Class to manage SQLite database connections and operations.
    Centralizes database handling and improves error management.
    """
    def __init__(self, db_name: str):
        self.db_name = db_name

    def _connect(self) -> sqlite3.Connection:
        """Establishes and returns a database connection."""
        return sqlite3.connect(self.db_name)

    def ejecutar_consulta(self, query: str, params: tuple = ()) -> tuple[bool, str]:
        """Executes an SQL query that modifies the database (INSERT, UPDATE, DELETE)."""
        conn = self._connect()
        cursor = conn.cursor()
        try:
            cursor.execute(query, params)
            conn.commit()
            return True, "Operación exitosa."
        except sqlite3.IntegrityError as e:
            logging.error(f"Database integrity error: {e} - Query: {query} - Parameters: {params}")
            return False, f"Error de integridad: {e}"
        except sqlite3.Error as e:
            logging.error(f"Error en la base de datos: {e} - Query: {query} - Parameters: {params}")
            return False, f"Error en la base de datos: {e}"
        finally:
            conn.close()

    def obtener_uno(self, query: str, params: tuple = ()) -> tuple | None:
        """Executes an SQL query and returns a single row."""
        conn = self._connect()
        cursor = conn.cursor()
        try:
            cursor.execute(query, params)
            return cursor.fetchone()
        except sqlite3.Error as e:
            logging.error(f"Error fetching a row from the database: {e} - Query: {query} - Parameters: {params}")
            return None
        finally:
            conn.close()

    def obtener_todos(self, query: str, params: tuple = ()) -> list[tuple]:
        """Executes an SQL query and returns all rows."""
        conn = self._connect()
        cursor = conn.cursor()
        try:
            cursor.execute(query, params)
            return cursor.fetchall()
        except sqlite3.Error as e:
            logging.error(f"Error fetching all rows from the database: {e} - Query: {query} - Parameters: {params}")
            return []
        finally:
            conn.close()

# Global instance of the database manager
db_manager = GestorBaseDeDatos(ConfiguracionAplicacion.NOMBRE_BD)

def add_column_if_not_exists(cursor: sqlite3.Cursor, table_name: str, column_name: str, column_type: str, default_value: str = None) -> None:
    """Adds a column to a table if it does not exist. (Used only in initialize_db)."""
    cursor.execute(f"PRAGMA table_info({table_name})")
    columns = [col[1] for col in cursor.fetchall()]
    if column_name not in columns:
        try:
            if default_value is not None:
                cursor.execute(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type} DEFAULT '{default_value}'")
                logging.info(f"Column '{column_name}' added to '{table_name}' with default value.")
            else:
                cursor.execute(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type}")
                logging.info(f"Column '{column_name}' added to '{table_name}'.")
        except sqlite3.Error as e:
            logging.error(f"Error adding column {column_name} to {table_name}: {e}")


def inicializar_bd() -> None:
    """
    Initializes the 'compras.db' database and creates the necessary tables
    if they do not exist: 'usuarios', 'ordenes_compra_recibidas', 'ordenes_compra_generadas',
    and 'productos_catalogo'.
    """
    conn = db_manager._connect() # Direct access only for initialization
    cursor = conn.cursor()

    # Table for users
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS usuarios (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            rol TEXT NOT NULL
        )
    ''')

    # Table for received purchase orders (from supplier)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ordenes_compra_recibidas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            numero_orden TEXT UNIQUE NOT NULL,
            fecha_recibida TEXT NOT NULL,
            proveedor_origen TEXT NOT NULL,
            monto_total REAL,
            estado TEXT NOT NULL,
            ruta_archivo_original TEXT,
            ruta_foto TEXT,  -- New column for photo path
            datos_productos_json TEXT
        )
    ''')

    # Table for generated purchase orders (to our supplier)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ordenes_compra_generadas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            numero_orden_generada TEXT UNIQUE NOT NULL,
            fecha_generada TEXT NOT NULL,
            proveedor_destino TEXT NOT NULL,
            monto_total REAL,
            estado TEXT NOT NULL,
            ruta_archivo_generado TEXT,
            ruta_foto TEXT, -- New column for photo path
            orden_recibida_id INTEGER,
            datos_productos_json TEXT,
            fecha_entrega TEXT,
            estado_entrega TEXT DEFAULT 'Pendiente',
            formato_pdf TEXT DEFAULT 'Demoga', -- New column for PDF format
            FOREIGN KEY (orden_recibida_id) REFERENCES ordenes_compra_recibidas(id)
        )
    ''')

    # NEW TABLE: productos_catalogo
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS productos_catalogo (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            edp TEXT UNIQUE NOT NULL,
            numero_cliente TEXT UNIQUE,
            descripcion TEXT NOT NULL,
            costo REAL NOT NULL
        )
    ''')

    conn.commit()

    # Ensure new columns exist to avoid errors if DB already existed
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'fecha_entrega', 'TEXT')
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'estado_entrega', 'TEXT', 'Pendiente')
    add_column_if_not_exists(cursor, 'ordenes_compra_recibidas', 'ruta_foto', 'TEXT') # Add foto column for received
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'ruta_foto', 'TEXT') # Add foto column for generated
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'formato_pdf', 'TEXT', 'Demoga') # Add PDF format column

    # Add indexes for the new products table
    cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_productos_catalogo_edp ON productos_catalogo (edp)')
    cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_productos_catalogo_numero_cliente ON productos_catalogo (numero_cliente)')


    conn.commit()
    conn.close()
    logging.info("Database initialized (or already existed) and columns verified/added.")

# --- Funciones CRUD para el catálogo de productos ---
def agregar_producto_al_catalogo(edp: str, numero_cliente: str, descripcion: str, costo: float) -> tuple[bool, str]:
    """Adds a new product to the catalog."""
    success, message = db_manager.ejecutar_consulta(
        "INSERT INTO productos_catalogo (edp, numero_cliente, descripcion, costo) VALUES (?, ?, ?, ?)",
        (edp, numero_cliente, descripcion, costo)
    )
    if success:
        logging.info(f"Product '{edp}' added to catalog.")
    else:
        logging.error(f"Error adding product '{edp}' to catalog: {message}")
    return success, message

def obtener_todos_los_productos() -> list[dict]:
    """Retrieves all products from the catalog."""
    results = db_manager.obtener_todos("SELECT id, edp, numero_cliente, descripcion, costo FROM productos_catalogo")
    return [{"id": r[0], "edp": r[1], "numero_cliente": r[2], "descripcion": r[3], "costo": r[4]} for r in results]

def obtener_producto_por_id(product_id: int) -> dict | None:
    """Retrieves a product from the catalog by its ID."""
    result = db_manager.obtener_uno("SELECT id, edp, numero_cliente, descripcion, costo FROM productos_catalogo WHERE id = ?", (product_id,))
    if result:
        return {"id": result[0], "edp": result[1], "numero_cliente": result[2], "descripcion": result[3], "costo": result[4]}
    return None

def actualizar_producto_del_catalogo(product_id: int, edp: str, numero_cliente: str, descripcion: str, costo: float) -> tuple[bool, str]:
    """Updates an existing product in the catalog."""
    success, message = db_manager.ejecutar_consulta(
        "UPDATE productos_catalogo SET edp = ?, numero_cliente = ?, descripcion = ?, costo = ? WHERE id = ?",
        (edp, numero_cliente, descripcion, costo, product_id)
    )
    if success:
        logging.info(f"Product with ID {product_id} updated in the catalog.")
    else:
        logging.error(f"Error updating product with ID {product_id}: {message}")
    return success, message

def eliminar_producto_del_catalogo(product_id: int) -> tuple[bool, str]:
    """Deletes a product from the catalog by its ID."""
    success, message = db_manager.ejecutar_consulta("DELETE FROM productos_catalogo WHERE id = ?", (product_id,))
    if success:
        logging.info(f"Product with ID {product_id} deleted from catalog.")
    else:
        logging.error(f"Error deleting product with ID {product_id}: {message}")
    return success, message

def crear_usuario(username: str, password: str, rol: str) -> tuple[bool, str]:
    """
    Creates a new user in the database with a hashed password.
    Returns True and a success message, or False and an error message.
    """
    if len(password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
        return False, f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long."

    hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
    success, message = db_manager.ejecutar_consulta(
        "INSERT INTO usuarios (username, password_hash, rol) VALUES (?, ?, ?)",
        (username, hashed_password, rol)
    )
    if success:
        logging.info(f"User '{username}' created with role '{rol}'.")
        # Self-check password (for debugging only)
        if not bcrypt.checkpw(password.encode('utf-8'), hashed_password.encode('utf-8')):
            logging.warning(f"Contraseña self-check for '{username}' FAILED after creation.")
    else:
        logging.error(f"Error creating user '{username}': {message}")
    return success, message

def obtener_usuario_por_id(user_id: int) -> dict | None:
    """Gets user details by ID."""
    result = db_manager.obtener_uno("SELECT id, username, rol FROM usuarios WHERE id = ?", (user_id,))
    if result:
        return {"id": result[0], "username": result[1], "rol": result[2]}
    return None

def obtener_usuario_por_nombre(username: str) -> dict | None:
    """Gets user details by username."""
    result = db_manager.obtener_uno("SELECT id, username, rol, password_hash FROM usuarios WHERE username = ?", (username,))
    if result:
        return {"id": result[0], "username": result[1], "rol": result[2], "password_hash": result[3]}
    return None

def obtener_todos_los_usuarios() -> list[dict]:
    """Gets all users from the database."""
    results = db_manager.obtener_todos("SELECT id, username, rol FROM usuarios")
    return [{"id": r[0], "username": r[1], "rol": r[2]} for r in results]

def actualizar_usuario(user_id: int, username: str, password: str = None, rol: str = None) -> tuple[bool, str]:
    """Updates user data. Allows updating password and/or role."""
    updates = []
    params = []

    if username:
        updates.append("username = ?")
        params.append(username)
    if password:
        if len(password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            return False, f"La nueva contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long."
        hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
        updates.append("password_hash = ?")
        params.append(hashed_password)
    if rol:
        updates.append("rol = ?")
        params.append(rol)

    if not updates:
        return False, "No hay datos para actualizar."

    update_query = "UPDATE usuarios SET " + ", ".join(updates) + " WHERE id = ?"
    params.append(user_id)

    success, message = db_manager.ejecutar_consulta(update_query, tuple(params))
    if success:
        logging.info(f"User with ID {user_id} updated successfully.")
    else:
        logging.error(f"Error updating user with ID {user_id}: {message}")
    return success, message

def eliminar_usuario(user_id: int) -> tuple[bool, str]:
    """Deletes a user by ID."""
    success, message = db_manager.ejecutar_consulta("DELETE FROM usuarios WHERE id = ?", (user_id,))
    if success:
        logging.info(f"User with ID {user_id} deleted successfully.")
    else:
        logging.error(f"Error deleting user with ID {user_id}: {message}")
    return success, message

def verificar_credenciales(username: str, password: str) -> tuple[bool, str | None]:
    """
    Verifies a user's credentials.
    Returns True and the user's role if credentials are correct, False and None otherwise.
    """
    logging.info(f"Attempting to verify credentials for user: '{username}'")
    user_data = obtener_usuario_por_nombre(username)
    if user_data:
        password_hash_guardado = user_data["password_hash"]
        rol_del_usuario = user_data["rol"]
        logging.info(f"Usuario encontrado. Guardard hash (partial): {password_hash_guardado[:10]}...")
        if bcrypt.checkpw(password.encode('utf-8'), password_hash_guardado.encode('utf-8')):
            logging.info("Contraseña verified successfully.")
            return True, rol_del_usuario
        else:
            logging.warning("Contraseña incorrecta.")
    else:
        logging.warning(f"User '{username}' not found in the database.")
    return False, None

def eliminar_orden_por_id(order_id: int, order_type: str) -> tuple[bool, str]:
    """Deletes a purchase order by its ID and type."""
    table_name = ""
    if order_type == "Recibida":
        table_name = "ordenes_compra_recibidas"
    elif order_type == "Generada":
        table_name = "ordenes_compra_generadas"
    else:
        return False, "Tipo de orden desconocido."

    success, message = db_manager.ejecutar_consulta(f"DELETE FROM {table_name} WHERE id = ?", (order_id,))
    if success:
        logging.info(f"Order '{order_type}' with ID {order_id} deleted successfully.")
    else:
        logging.error(f"Error deleting order '{order_type}' with ID {order_id}: {message}")
    return success, message

def actualizar_estado_entrega_orden(order_id: int, new_status: str) -> tuple[bool, str]:
    """Updates the delivery status of a generated order."""
    success, message = db_manager.ejecutar_consulta("UPDATE ordenes_compra_generadas SET estado_entrega = ? WHERE id = ?", (new_status, order_id))
    if success:
        logging.info(f"Delivery status of generated order ID {order_id} updated to '{new_status}'.")
    else:
        logging.error(f"Error updating delivery status of generated order ID {order_id}: {message}")
    return success, message

def actualizar_orden_en_bd(order_id: int, order_type: str, updated_data: dict) -> tuple[bool, str]:
    """
    Updates a purchase order (received or generated) with new data.
    `updated_data` is a dictionary with the fields to update.
    """
    table_name = ""
    id_field = ""
    if order_type == "Recibida":
        table_name = "ordenes_compra_recibidas"
        id_field = "id"
    elif order_type == "Generada":
        table_name = "ordenes_compra_generadas"
        id_field = "id"
    else:
        return False, "Tipo de orden desconocido for update."

    set_clauses = []
    params = []

    for key, value in updated_data.items():
        if key in ["id", "ruta_foto", "orden_recibida_id"]: # Fields not directly updatable from the dialog or handled separately
            continue
        set_clauses.append(f"{key} = ?")
        params.append(value)

    if not set_clauses:
        return False, "No hay datos para actualizar."

    query = f"UPDATE {table_name} SET {', '.join(set_clauses)} WHERE {id_field} = ?"
    params.append(order_id)

    success, message = db_manager.ejecutar_consulta(query, tuple(params))
    if success:
        logging.info(f"Order {order_type} with ID {order_id} updated successfully.")
    else:
        logging.error(f"Error updating order {order_type} with ID {order_id}: {message}")
    return success, message


def obtener_detalles_orden_recibida(order_id: int) -> dict | None:
    """Gets all details of a received purchase order by its ID."""
    result = db_manager.obtener_uno("SELECT id, numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json FROM ordenes_compra_recibidas WHERE id = ?", (order_id,))
    if result:
        return {
            "id": result[0],
            "numero_orden": result[1],
            "fecha_recibida": result[2],
            "proveedor_origen": result[3],
            "monto_total": result[4],
            "estado": result[5],
            "ruta_archivo_original": result[6],
            "ruta_foto": result[7],
            "datos_productos_json": result[8]
        }
    return None

def obtener_detalles_orden_generada(order_id: int) -> dict | None:
    """Gets all details of a generated purchase order by its ID."""
    result = db_manager.obtener_uno("SELECT id, numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, estado_entrega, formato_pdf FROM ordenes_compra_generadas WHERE id = ?", (order_id,))
    if result:
        formato_pdf_from_db = result[12]
        # Ensure that formato_pdf is one of the expected values, default to 'Demoga' if not
        if formato_pdf_from_db not in ["Demoga", "Emaldo"]:
            formato_pdf_from_db = "Demoga"

        return {
            "id": result[0],
            "numero_orden_generada": result[1],
            "fecha_generada": result[2],
            "proveedor_destino": result[3],
            "monto_total": result[4],
            "estado": result[5],
            "ruta_archivo_generado": result[6],
            "ruta_foto": result[7],
            "orden_recibida_id": result[8],
            "datos_productos_json": result[9],
            "fecha_entrega": result[10],
            "estado_entrega": result[11],
            "formato_pdf": formato_pdf_from_db
        }
    return None

# --- Funciones para analizar PDFs ---

# Month mapping for date parsing (used in parse_date_format and specific parsing functions)
MONTH_MAP = {
    'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
    'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
}

def parse_date_format(date_str: str) -> datetime | None:
    """Tries to parse a date in various formats and returns a datetime object or None."""
    # Convert month abbreviations to numbers before parsing for consistency
    temp_date_str = date_str.upper()
    for abbr, num in MONTH_MAP.items():
        temp_date_str = temp_date_str.replace(abbr, num)

    formats = [
        "%Y-%m-%d",
        "%d-%m-%Y",
        "%m-%d-%Y",
        "%d/%m/%Y",
        "%m/%d/%Y",
        "%Y/%m/%d",
        "%d %m %Y" # For "07 APR 2025" after conversion
    ]
    for fmt in formats:
        try:
            return datetime.strptime(temp_date_str, fmt)
        except ValueError:
            continue
    return None


def parse_mcx_po(content: str) -> dict:
    """
    Parses the MCX_PO_74907_344_0.PDF structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Número de Orden
    num_orden_match = re.search(r'No\.\s*([\w\d-]+)\s*Rev\.0', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha (e.g., "07 APR 2025")
    fecha_match = re.search(r'(\d{2})\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(\d{4})', content)
    if fecha_match:
        day = fecha_match.group(1)
        month_abbr = fecha_match.group(2).upper()
        year = fecha_match.group(3)
        month_num = MONTH_MAP.get(month_abbr, '')
        if all([day, month_num, year]):
            parsed_date = parse_date_format(f"{day} {month_num} {year}")
            if parsed_date:
                data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Supplier Name - Attempt to capture the first line after "PROVEEDOR (SUPPLIER)"
    proveedor_match = re.search(r'PROVEEDOR \(SUPPLIER\)\s*\n\s*([^\n]+)', content, re.IGNORECASE)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip().replace(',', '')

    # Monto Total
    monto_match = re.search(r'TOTAL\s*USD\s*([\d,\.]+)', content)
    if monto_match:
        try:
            data["monto_total"] = float(monto_match.group(1).replace(',', '').strip())
        except ValueError:
            logging.warning(f"Could not parse total amount for MCX_PO: {monto_match.group(1)}")


    # Detalles del Producto (CSV-like rows)
    productos = []
    product_lines_raw = re.findall(
        r'"(\d+)"\s*,\s*'          # LINE
        r'"([\d.]+)"\s*,\s*'        # QTY
        r'"(.*?)"\s*,\s*'           # U.M.
        r'"(.*?)"\s*,\s*'           # CODE
        r'"(.*?)"\s*,\s*'           # DESCRIPTION
        r'"(.*?)"\s*,\s*'           # DATE
        r'"(.*?)"\s*,\s*'           # REQ.
        r'([^,]*?),\s*'             # COT (Handles empty string between commas, non-greedy)
        r'"([\d.]+)"\s*,\s*'        # UNIT PRICE
        r'"([\d.,]+)"',             # TOTAL PRICE
        content
    )

    for line_data in product_lines_raw:
        try:
            line_num = line_data[0].strip()
            qty = float(line_data[1].strip())
            unit = line_data[2].strip()
            code = line_data[3].strip()
            description = line_data[4].strip()
            unit_price = float(line_data[8].replace(',', '').strip())
            total_price = float(line_data[9].replace(',', '').strip())

            productos.append({
                "linea": line_num,
                "cantidad": qty,
                "unidad": unit,
                "codigo": code,
                "descripcion": description,
                "precio_unitario": unit_price,
                "precio_total": total_price
            })
        except ValueError as e:
            logging.warning(f"Error parsing MCX_PO product line (ValueError): {line_data} - {e}")
            continue
        except IndexError as e:
            logging.warning(f"Error parsing MCX_PO product line (IndexError): {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data


def parse_pc002057_emaldo_po(content: str) -> dict:
    """
    Parses the PC002057 EMALDO.pdf structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Supplier
    proveedor_match = re.search(r'SUPPLIER:\s*(.+)', content)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip()

    # Número de Orden
    num_orden_match = re.search(r'NBR:\s*\"?([A-Z0-9]+)\"?', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha (e.g., 23/01/2025)
    fecha_match = re.search(r'DATE:\s*\"?(\d{2}/\d{2}/\d{4})\"?', content)
    if fecha_match:
        parsed_date = parse_date_format(fecha_match.group(1))
        if parsed_date:
            data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Monto Total
    monto_match = re.search(r'Total:\s*([\d,\.]+\s*USD)', content)
    if monto_match:
        try:
            total_str = monto_match.group(1).replace(',', '').replace(' USD', '').strip()
            data["monto_total"] = float(total_str)
        except ValueError:
            logging.warning(f"Could not parse total amount for EMALDO: {monto_match.group(1)}")


    # Detalles del Producto (CSV-like rows)
    productos = []
    # Regex for EMALDO: "PART","CODE","DESCRIPTION","",,"QTY","U.PRICE","VALUE"
    product_lines_raw = re.findall(r'"(\d+)"\s*,\s*"(.*?)"\s*,\s*"(.*?)"\s*,\s*"(.*?)"\s*,\s*"(\d+\.?\d*)"\s*,\s*"(\d+\.?\d*)"\s*,\s*"([\d,\.]+)"', content)

    for line_data in product_lines_raw:
        try:
            part_num = line_data[0]
            code = line_data[1]
            description = line_data[2]
            # line_data[3] is the empty '# PART' field
            qty = float(line_data[4])
            unit_price = float(line_data[5])
            value = float(line_data[6].replace(',', ''))

            productos.append({
                "part_num": part_num,
                "code": code,
                "description": description,
                "quantity": qty,
                "unit_price": unit_price,
                "value": value
            })
        except ValueError as e:
            logging.warning(f"Error parsing EMALDO product line (ValueError): {line_data} - {e}")
            continue
        except IndexError as e:
            logging.warning(f"Error parsing EMALDO product line (IndexError): {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data

def parse_m229420_po(content: str) -> dict:
    """
    Parses the M229420.PDF structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Número de Orden
    num_orden_match = re.search(r'PO NUMBER\\NUMERO PO\s*\"?([A-Z0-9]+)\"?', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha
    fecha_match = re.search(r'DATE FECHA\s*\"?(\d{2}/\d{2}/\d{2})\"?', content)
    if fecha_match:
        day, month, year_short = fecha_match.group(1).split('/')
        # Heuristic for 2-digit years (e.g., 24 -> 2024)
        current_year_last_two_digits = datetime.now().year % 100
        year_full = f"20{year_short}" if int(year_short) <= current_year_last_two_digits else f"19{year_short}"
        parsed_date = parse_date_format(f"{day}/{month}/{year_full}")
        if parsed_date:
            data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Supplier Name
    proveedor_match = re.search(r'R\.F\.C\.:HAS120702332\s*\n\s*([^,\n]+(?:,[^\n]+)*)', content, re.IGNORECASE)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip().replace(',', '')

    # Monto Total (appears on page 2)
    monto_match = re.search(r'Total This PO:\s*\(USD\s*\)\s*([\d,\.]+)', content)
    if monto_match:
        try:
            data["monto_total"] = float(monto_match.group(1).replace(',', '').strip())
        except ValueError:
            logging.warning(f"Could not parse total amount for M229420: {monto_match.group(1)}")


    # Detalles del Producto (Refined Regex)
    productos = []
    product_lines_raw = re.findall(
        r'"(\d+)"\s*,\s*'              # Group 1: Línea number
        r'"([\d\.]+\s*[^\"]+)"\s*,\s*' # Group 2: Cantidad and Unidad (e.g., "500.000 Piezas")
        r'"([\d\.]+\s*per\s*[^\"]+)\s*' # Group 3: Price per Unidad (e.g., "63.22000 per Piezas") - capture up to " per "
        r'(.*?)"\s*,\s*'               # Group 4: Remaining Descripción (after "per Unidad" part, before next quote)
        r'"([\d,\.]+)"',               # Group 5: Precio Total
        content
    )

    for line_data in product_lines_raw:
        try:
            line_num = line_data[0]
            qty_unit_str = line_data[1].strip()
            unit_price_per_str = line_data[2].strip()
            description_remainder = line_data[3].strip()
            total_price = float(line_data[4].replace(',', ''))

            qty_match = re.match(r'([\d\.]+)\s*(.+)', qty_unit_str)
            qty = float(qty_match.group(1)) if qty_match else 0.0
            unit = qty_match.group(2).strip() if qty_match else ""

            unit_price_match = re.match(r'([\d\.]+)', unit_price_per_str)
            unit_price = float(unit_price_match.group(1)) if unit_price_match else 0.0

            full_description = f"{unit_price_per_str} {description_remainder}".strip()

            delivery_date = "N/A" # Placeholder, actual regex needs to capture it if present

            productos.append({
                "linea": line_num,
                "cantidad": qty,
                "unidad": unit,
                "descripcion": full_description,
                "precio_unitario": unit_price,
                "fecha_entrega": delivery_date,
                "precio_total": total_price
            })
        except (ValueError, AttributeError, IndexError) as e:
            logging.warning(f"Error parsing M229420 product line: {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data


# --- Funciones para generar archivos PDF ---
def create_styled_paragraph(text: str, style_id: str = 'Normal', font_size: int = 10, color = colors.black, bold: bool = False, alignment = Qt.AlignLeft) -> Paragraph:
    """Creates a Paragraph with custom styles."""
    styles = getSampleStyleSheet()
    if style_id not in styles:
        styles.add(ParagraphStyle(name=style_id, parent=styles['Normal']))

    current_style = styles[style_id]
    current_style.fontSize = font_size
    current_style.textColor = color
    if bold:
        current_style.fontName = 'Helvetica-Bold'
    else:
        current_style.fontName = 'Helvetica'

    if alignment == Qt.AlignCenter:
        current_style.alignment = 1 # TA_CENTER
    elif alignment == Qt.AlignRight:
        current_style.alignment = 2 # TA_RIGHT
    else:
        current_style.alignment = 0 # TA_LEFT

    return Paragraph(text, current_style)

def create_demoga_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF with Demoga format."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Company Header (Green Section)
    company_info = [
        ["DEMOGA S.A DE C.V.", ""],
        ["DeMoGa Tools. Libertad 22, La Magdalena Ocotitlan, Metepec Estado de Mexico. C.P. 52161 Tel: 722 931 38 79", ""]
    ]
    header_table = Table(company_info, colWidths=[14*cm, 5*cm])
    header_table.setStyle(TableStyle([
        ('BACKGROUND', (0,0), (-1,-1), colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green
        ('TEXTCOLOR', (0,0), (-1,-1), colors.white),
        ('ALIGN', (0,0), (0,0), 'LEFT'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (0,0), 'Helvetica-Bold'),
        ('FONTSIZE', (0,0), (0,0), 16),
        ('FONTNAME', (0,1), (0,1), 'Helvetica'),
        ('FONTSIZE', (0,1), (0,1), 9),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('BOTTOMPADDING', (0,0), (-1,-1), 10),
    ]))
    story.append(header_table)
    story.append(Spacer(1, 0.2*cm))

    # General Company Info (Below Green Header - hardcoded for now, but could be dynamic)
    story.append(create_styled_paragraph("<b>Compañía:</b> INGERSOLL CUTTING TOOLS SA DE CV", font_size=10))
    story.append(create_styled_paragraph("<b>Dirección:</b> Blvd. José Musa de León No. 2127, Col. Los Pinos, C.P. 25198", font_size=10))
    story.append(create_styled_paragraph("<b>Ciudad:</b> Saltillo, Coahuila", font_size=10))
    story.append(create_styled_paragraph("<b>Tel./e-mail:</b> (844) 485 32 21", font_size=10))
    story.append(create_styled_paragraph("<b>At'n:</b> Gerardo Berlanga", font_size=10))
    story.append(Spacer(1, 0.5*cm))

    # PURCHASE ORDER Title and Info
    # Ensure date is in QDate format for toString
    fecha_generada_qdate = QDate.fromString(order_data['fecha_generada'], Qt.ISODate)
    order_title_data = [
        [create_styled_paragraph("<b>PURCHASE ORDER</b>", font_size=14, alignment=Qt.AlignCenter),
         create_styled_paragraph(f"<b>No.</b><br/>{order_data['numero_orden_generada']}", font_size=10, alignment=Qt.AlignRight)],
        [create_styled_paragraph(f"<b>Fecha:</b> {fecha_generada_qdate.toString('dd/MM/yyyy')}", font_size=10), ""]
    ]
    order_title_table = Table(order_title_data, colWidths=[14*cm, 5*cm])
    order_title_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (0,0), 'CENTER'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (1,0), (1,0), 'Helvetica-Bold'),
        ('FONTSIZE', (0,0), (-1,0), 14),
        ('FONTSIZE', (1,0), (1,0), 10),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5),
    ]))
    story.append(order_title_table)
    story.append(Spacer(1, 0.5*cm))

    # Product Table
    products = json.loads(order_data["datos_productos_json"])
    table_data = [
        ["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Ship Fecha", "Precio Unitario (USD)", "Precio Total (USD)"]
    ]

    for i, p in enumerate(products):
        # Ensure date is in QDate format for toString
        fecha_entrega_qdate = QDate.fromString(order_data['fecha_entrega'], Qt.ISODate)
        table_data.append([
            str(i + 1),
            p.get("codigo", ""),
            p.get("numero_cliente", ""),
            p.get("descripcion", p.get("nombre", "")),
            f"{p.get('cantidad', 0):.2f}",
            fecha_entrega_qdate.toString('dd/MM/yyyy'),
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data, colWidths=[1*cm, 2.5*cm, 2.5*cm, 5*cm, 2*cm, 2.5*cm, 2.5*cm, 2.5*cm])
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green header
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 6),
        ('BACKGROUND', (0, 1), (-1, -1), colors.white),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green grid
        ('TEXTCOLOR', (0, 1), (-1, -1), colors.black),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
    ]))
    story.append(product_table)
    story.append(Spacer(1, 0.5*cm))

    # Totals Section
    subtotal = sum(p.get('precio_total', 0.0) for p in products)
    iva = subtotal * ConfiguracionAplicacion.TASA_IVA
    total = subtotal + iva

    totals_data = [
        ["Subtotal", f"{subtotal:.2f}"],
        [f"{ConfiguracionAplicacion.TASA_IVA * 100:.2f}% IVA", f"{iva:.2f}"],
        ["Total", f"{total:.2f}"]
    ]
    totals_table = Table(totals_data, colWidths=[15.5*cm, 3.5*cm])
    totals_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTNAME', (0,-1), (-1,-1), 'Helvetica-Bold'),
        ('LINEBELOW', (0,-2), (-1,-2), 1, colors.black),
        ('LINEBELOW', (0,-1), (-1,-1), 1, colors.black),
        ('FONTSIZE', (0,0), (-1,-1), 10),
    ]))
    story.append(totals_table)
    story.append(Spacer(1, 1*cm))

    # Footer (hardcoded for now, could be dynamic)
    story.append(create_styled_paragraph("Independencia 1319, Metepec, Mexico C.P. 52160", font_size=9, alignment=Qt.AlignCenter))

    try:
        doc.build(story)
        return True, "Demoga PDF generated successfully."
    except Exception as e:
        logging.error(f"Error generating Demoga PDF: {e}", exc_info=True)
        return False, f"Error generating Demoga PDF: {e}"


def create_emaldo_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF with Emaldo format."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Company Header (Emaldo Logo and Info)
    # Replaced Image URL with styled Paragraph for "EMALDO" text.
    emaldo_logo_text = create_styled_paragraph("<b>EMALDO</b>", font_size=20, bold=True, alignment=Qt.AlignLeft,
                                               color=colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)) # Lighter blue
    story.append(emaldo_logo_text)
    story.append(Spacer(1, 0.2*cm)) # Small spacer after the logo text

    header_data = [
        [create_styled_paragraph("<b>INGERSOLL CUTTING TOOLS SA DE CV</b>", font_size=10, bold=True), ""],
        [create_styled_paragraph("Blvd. José Musa de León No. 2127, Col. Los Pinos, C.P. 25198", font_size=9), ""],
        [create_styled_paragraph("Saltillo, Coahuila", font_size=9), ""],
        [create_styled_paragraph("(844) 485 32 21", font_size=9), ""],
        [create_styled_paragraph("Attn: Gerardo Berlanga", font_size=9), ""]
    ]
    header_table = Table(header_data, colWidths=[10*cm, 9*cm])
    header_table.setStyle(TableStyle([
        ('VALIGN', (0,0), (-1,-1), 'TOP'),
        ('TEXTCOLOR', (0,0), (-1,-1), colors.black),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (0,1), (0,1), 'Helvetica-Bold'),
        ('FONTNAME', (0,2), (0,5), 'Helvetica'),
        ('ALIGN', (0,0), (-1,-1), 'LEFT'),
    ]))
    story.append(header_table)
    story.append(Spacer(1, 0.5*cm))

    # PURCHASE ORDER Title and Info
    fecha_generada_qdate = QDate.fromString(order_data['fecha_generada'], Qt.ISODate)
    order_title_data = [
        [create_styled_paragraph("<b>PURCHASE ORDER</b>", font_size=14, bold=True, alignment=Qt.AlignCenter),
         create_styled_paragraph(f"No. POOGM-{order_data['numero_orden_generada']}", font_size=10, alignment=Qt.AlignRight)],
        [create_styled_paragraph(f"Fecha: {fecha_generada_qdate.toString('dd/MM/yyyy')}", font_size=10), ""]
    ]
    order_title_table = Table(order_title_data, colWidths=[14*cm, 5*cm])
    order_title_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (0,0), 'CENTER'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (1,0), (1,0), 'Helvetica'),
        ('FONTSIZE', (0,0), (-1,0), 14),
        ('FONTSIZE', (1,0), (1,0), 10),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5),
    ]))
    story.append(order_title_table)
    story.append(Spacer(1, 0.5*cm))

    # Product Table
    products = json.loads(order_data["datos_productos_json"])
    table_data = [
        ["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Ship Fecha", "Precio Unitario (USD)", "Precio Total (USD)"]
    ]

    for i, p in enumerate(products):
        fecha_entrega_qdate = QDate.fromString(order_data['fecha_entrega'], Qt.ISODate)
        table_data.append([
            str(i + 1),
            p.get("codigo", ""),
            p.get("numero_cliente", ""),
            p.get("descripcion", p.get("nombre", "")),
            f"{p.get('cantidad', 0):.2f}",
            fecha_entrega_qdate.toString('dd/MM/yyyy'),
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data, colWidths=[1*cm, 2.5*cm, 2.5*cm, 5*cm, 2*cm, 2.5*cm, 2.5*cm, 2.5*cm])
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)), # Lighter Blue header
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 6),
        ('BACKGROUND', (0, 1), (-1, -1), colors.white),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)), # Lighter Blue grid
        ('TEXTCOLOR', (0, 1), (-1, -1), colors.black),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
    ]))
    story.append(product_table)
    story.append(Spacer(1, 0.5*cm))

    # Totals Section
    subtotal = sum(p.get('precio_total', 0.0) for p in products)
    iva = subtotal * ConfiguracionAplicacion.TASA_IVA
    total = subtotal + iva

    totals_data = [
        ["Subtotal", f"{subtotal:.2f}"],
        [f"{ConfiguracionAplicacion.TASA_IVA * 100:.2f}% IVA", f"{iva:.2f}"],
        ["Total", f"{total:.2f}"]
    ]
    totals_table = Table(totals_data, colWidths=[15.5*cm, 3.5*cm])
    totals_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTNAME', (0,-1), (-1,-1), 'Helvetica-Bold'),
        ('LINEBELOW', (0,-2), (-1,-2), 1, colors.black),
        ('LINEBELOW', (0,-1), (-1,-1), 1, colors.black),
        ('FONTSIZE', (0,0), (-1,-1), 10),
    ]))
    story.append(totals_table)
    story.append(Spacer(1, 1*cm))

    # Footer (hardcoded for now, could be dynamic)
    story.append(create_styled_paragraph("Independencia 1319, Metepec, Mexico C.P. 52160", font_size=9, alignment=Qt.AlignCenter))

    try:
        doc.build(story)
        return True, "Emaldo PDF generated successfully."
    except Exception as e:
        logging.error(f"Error generating Emaldo PDF: {e}", exc_info=True)
        return False, f"Error generating Emaldo PDF: {e}"


def create_received_order_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF for a received purchase order (generic format)."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Title
    story.append(create_styled_paragraph("<b>Received Purchase Order</b>", font_size=18, bold=True, alignment=Qt.AlignCenter))
    story.append(Spacer(1, 0.5*cm))

    # Order Details
    fecha_recibida_qdate = QDate.fromString(order_data['fecha_recibida'], Qt.ISODate)

    story.append(create_styled_paragraph(f"<b>Número de Orden:</b> {order_data.get('numero_orden', 'N/A')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Fecha de Recepción:</b> {fecha_recibida_qdate.toString('dd/MM/yyyy')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Proveedor de Origen:</b> {order_data.get('proveedor_origen', 'N/A')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Monto Total:</b> ${order_data.get('monto_total', 0.0):.2f} USD", font_size=12))
    story.append(Spacer(1, 0.5*cm))

    # Products Table
    products = json.loads(order_data.get("datos_productos_json", "[]"))
    table_data = [["Product Name", "Cantidad", "Precio Unitario", "Precio Total"]]

    for p in products:
        table_data.append([
            p.get("nombre", p.get("descripcion", "N/A")),
            f"{p.get('cantidad', 0):.2f}",
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data)
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
    ]))
    story.append(product_table)

    try:
        doc.build(story)
        return True, "Received Order PDF generated successfully."
    except Exception as e:
        logging.error(f"Error generating Received Order PDF: {e}", exc_info=True)
        return False, f"Error generating Received Order PDF: {e}"


# --- Part 2: Graphical User Interface (GUI) Classes ---

class DialogoInicioSesion(QDialog):
    """
    Iniciar Sesión dialog for the application.
    Allows the user to enter username and password for authentication.
    """
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Iniciar Sesión - Purchase Management")
        self.setFixedSize(300, 180) # Adjusted size for better viewing
        self.rol_usuario: str | None = None # Stores the authenticated user's role
        self.username_logged_in: str | None = None # Stores the authenticated username
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for login */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        """
        Configures the user interface elements of the login dialog.
        """
        layout = QVBoxLayout()
        layout.setSpacing(10) # Spacing between widgets

        # Title
        title_label = QLabel("Bienvenido")
        title_label.setAlignment(Qt.AlignCenter)
        title_font = QFont()
        title_font.setPointSize(16)
        title_font.setBold(True)
        title_label.setFont(title_font)
        layout.addWidget(title_label)

        # Nombre de usuario field
        layout.addWidget(QLabel("Nombre de usuario:"))
        self.username_input = QLineEdit(self)
        self.username_input.setPlaceholderText("Nombre de usuario")
        layout.addWidget(self.username_input)

        # Contraseña field
        self.password_input = QLineEdit(self)
        self.password_input.setPlaceholderText("Contraseña")
        self.password_input.setEchoMode(QLineEdit.Password) # Hides password
        layout.addWidget(self.password_input)

        # Iniciar Sesión button
        self.login_button = QPushButton("Iniciar Sesión", self)
        self.login_button.clicked.connect(self.attempt_login)
        layout.addWidget(self.login_button)

        self.setLayout(layout)

    def attempt_login(self):
        """
        Attempts to authenticate the user with the entered credentials.
        If successful, accepts the dialog; otherwise, displays a warning.
        """
        username = self.username_input.text()
        password = self.password_input.text()
        logging.info(f"DialogoInicioSesion: Attempting to log in user: '{username}'")

        autenticado, rol = verificar_credenciales(username, password)

        if autenticado:
            self.rol_usuario = rol
            self.username_logged_in = username
            self.accept()
        else:
            QMessageBox.warning(self, "Iniciar Sesión Error", "Incorrect username or password.")
            self.password_input.clear()

class ContraseñaAuthDialog(QDialog):
    """
    Dialog to request password and authorize an action.
    """
    def __init__(self, username: str, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle("Authorization Required")
        self.username = username
        self.setFixedSize(280, 150) # Adjusted size
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Ok */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QDialogButtonBox QPushButton#cancelButton { /* Specific style for Cancelar */
                background-color: #6c757d; /* Grey for Cancelar */
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QVBoxLayout()
        layout.setSpacing(10)

        info_label = QLabel(f"Please enter the password for user '{self.username}' to authorize this action:")
        info_label.setWordWrap(True) # Allows text to wrap to multiple lines
        layout.addWidget(info_label)

        self.password_input = QLineEdit(self)
        self.password_input.setEchoMode(QLineEdit.Password)
        self.password_input.setPlaceholderText("Contraseña")
        layout.addWidget(self.password_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(self.attempt_auth)
        button_box.rejected.connect(self.reject)
        # Assign object names to buttons for specific styling
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addWidget(button_box)

        self.setLayout(layout)

    def attempt_auth(self):
        password = self.password_input.text()
        autenticado, _ = verificar_credenciales(self.username, password)
        if autenticado:
            self.accept()
        else:
            QMessageBox.warning(self, "Authorization Error", "Contraseña incorrecta.")
            self.password_input.clear()

class ResetContraseñaDialog(QDialog):
    """
    Dialog for an administrator to reset another user's password.
    """
    def __init__(self, user_id: int, username_to_reset: str, admin_username: str, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle(f"Reset Contraseña for {username_to_reset}")
        self.user_id = user_id
        self.username_to_reset = username_to_reset
        self.admin_username = admin_username
        self.setFixedSize(350, 220)
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #28a745; /* Green for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #218838;
            }
            QDialogButtonBox QPushButton#cancelButton { /* Specific style for Cancelar */
                background-color: #6c757d; /* Grey for Cancelar */
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {

                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QFormLayout()

        # Insert "Usuario:" label at the top
        layout.addRow("Usuario:", QLabel(self.username_to_reset))

        self.new_password_input = QLineEdit(self)
        self.new_password_input.setEchoMode(QLineEdit.Password)
        self.new_password_input.setPlaceholderText("Enter new password")
        layout.addRow(QLabel("New Contraseña:"), self.new_password_input)

        self.confirm_password_input = QLineEdit(self)
        self.confirm_password_input.setEchoMode(QLineEdit.Password)
        self.confirm_password_input.setPlaceholderText("Confirm new password")
        layout.addRow(QLabel("Confirm Contraseña:"), self.confirm_password_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.reset_password)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton") # Apply style
        layout.addRow(button_box)

        self.setLayout(layout)

    def reset_password(self):
        new_password = self.new_password_input.text()
        confirm_password = self.confirm_password_input.text()

        if not new_password:
            QMessageBox.warning(self, "Empty Contraseña", "New password cannot be empty.")
            return

        if new_password != confirm_password:
            QMessageBox.warning(self, "Contraseñas Do Not Match", "New password and confirmation do not match.")
            return

        if len(new_password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            QMessageBox.warning(self, "Weak Contraseña", f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long.")
            return

        # Authenticate the admin again before performing the reset
        auth_dialog = ContraseñaAuthDialog(self.admin_username, self)
        if auth_dialog.exec_() == QDialog.Accepted:
            success, message = actualizar_usuario(self.user_id, self.username_to_reset, new_password)
            if success:
                QMessageBox.information(self, "Success", f"Contraseña for '{self.username_to_reset}' reset successfully.")
                self.accept()
            else:
                QMessageBox.warning(self, "Reset Error", message)
        else:
            QMessageBox.warning(self, "Authorization Failed", "Not authorized to reset password.")

class ChangeContraseñaDialog(QDialog):
    """
    Dialog for a user to change their own password.
    """
    def __init__(self, user_id: int, username: str, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle("Change Contraseña")
        self.user_id = user_id
        self.username = username
        self.setFixedSize(350, 250)
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QFormLayout()

        layout.addRow("Usuario:", QLabel(self.username))

        self.current_password_input = QLineEdit(self)
        self.current_password_input.setEchoMode(QLineEdit.Password)
        self.current_password_input.setPlaceholderText("Current password")
        layout.addRow("Current Contraseña:", self.current_password_input)

        self.new_password_input = QLineEdit(self)
        self.new_password_input.setEchoMode(QLineEdit.Password)
        self.new_password_input.setPlaceholderText("New password")
        layout.addRow("New Contraseña:", self.new_password_input)

        self.confirm_password_input = QLineEdit(self)
        self.confirm_password_input.setEchoMode(QLineEdit.Password)
        self.confirm_password_input.setPlaceholderText("Confirm new password")
        layout.addRow("Confirmar Nueva:", self.confirm_password_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.change_password)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addRow(button_box)

        self.setLayout(layout)

    def change_password(self):
        current_password = self.current_password_input.text()
        new_password = self.new_password_input.text()
        confirm_password = self.confirm_password_input.text()

        if not current_password or not new_password or not confirm_password:
            QMessageBox.warning(self, "Empty Fields", "Please complete all fields.")
            return

        if new_password != confirm_password:
            QMessageBox.warning(self, "Contraseñas Do Not Match", "New password and confirmation do not match.")
            return

        if len(new_password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            QMessageBox.warning(self, "Weak Contraseña", f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long.")
            return

        # Verify current password
        authenticated, _ = verificar_credenciales(self.username, current_password)
        if not authenticated:
            QMessageBox.warning(self, "Authorization Error", "Current password is incorrect.")
            return

        # Update the password
        success, message = actualizar_usuario(self.user_id, self.username, new_password)
        if success:
            QMessageBox.information(self, "Success", "Contraseña changed successfully.")
            self.accept()
        else:
            QMessageBox.warning(self, "Change Contraseña Error", message)


class LeerOCRecibidasPage(QWidget):
    """
    Page to read and process received purchase orders.
    Allows loading a file (TXT, DOCX, PDF), extracting data and saving it to the database.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.init_ui()
        self.apply_styles()
        self.setAcceptDrops(True)

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e; /* Dark background */
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #007bff; /* Blue */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#saveButton {
                background-color: #28a745; /* Green */
            }
            QPushButton#saveButton:hover {
                background-color: #218838;
            }
            QPushButton#clearButton {
                background-color: #dc3545; /* Red */
            }
            QPushButton#clearButton:hover {
                background-color: #c82333;
            }
            QTextEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
             #dropArea {
                border: 2px dashed #007bff;
                border-radius: 10px;
                background-color: #3a3a3a;
                padding: 20px;
                color: #F0F0F0;
                font-size: 16px;
                text-align: center;
             }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # File Upload Section
        file_input_group = QGroupBox("Cargar Archivo")
        file_layout = QVBoxLayout()

        self.file_path_label = QLabel("Arrastra y suelta un archivo aquí o haz clic para seleccionar.")
        self.file_path_label.setAlignment(Qt.AlignCenter)
        self.file_path_label.setWordWrap(True)
        self.file_path_label.setObjectName("dropArea") # For CSS styles

        self.select_file_button = QPushButton("Seleccionar Archivo")
        self.select_file_button.clicked.connect(self.select_file)

        file_selection_layout = QVBoxLayout()
        file_selection_layout.addWidget(self.file_path_label)
        file_selection_layout.addWidget(self.select_file_button)
        file_layout.addLayout(file_selection_layout)

        file_input_group.setLayout(file_layout)
        main_layout.addWidget(file_input_group)
        main_layout.addSpacing(10)

        # Datos Extraídos Section
        extracted_data_group = QGroupBox("Datos Extraídos")
        extracted_data_layout = QFormLayout()

        self.num_orden_input = QLineEdit()
        extracted_data_layout.addRow("Número de Orden:", self.num_orden_input)

        self.fecha_recibida_input = QDateEdit()
        self.fecha_recibida_input.setCalendarPopup(True)
        self.fecha_recibida_input.setDate(QDate.currentDate())
        extracted_data_layout.addRow("Fecha de Recepción:", self.fecha_recibida_input)

        self.proveedor_origen_input = QLineEdit()
        extracted_data_layout.addRow("Proveedor de Origen:", self.proveedor_origen_input)

        self.monto_total_input = QLineEdit()
        self.monto_total_input.setValidator(QDoubleValidator(0.0, 999999999.0, 2))
        extracted_data_layout.addRow("Monto Total:", self.monto_total_input)

        self.estado_combobox = QComboBox()
        self.estado_combobox.addItems(["Pendiente", "Procesada", "Cancelared"])
        extracted_data_layout.addRow("Estado:", self.estado_combobox)

        extracted_data_group.setLayout(extracted_data_layout)
        main_layout.addWidget(extracted_data_group)
        main_layout.addSpacing(10)

        # Detalles del Producto Section
        products_group = QGroupBox("Detalles del Producto")
        products_layout = QVBoxLayout()

        self.products_table = QTableWidget()
        self.products_table.setColumnCount(7) # Added "Precio Total"
        self.products_table.setHorizontalHeaderLabels(["Línea", "Cantidad", "Unidad", "Código", "Descripción", "Precio Unitario", "Precio Total"])
        self.products_table.horizontalHeader().setStretchLastSection(True)
        self.products_table.setSelectionBehavior(QAbstractItemView.SelectRows) # Select full rows
        products_layout.addWidget(self.products_table)

        products_group.setLayout(products_layout)
        main_layout.addWidget(products_group)
        main_layout.addSpacing(10)

        # Action Buttons
        button_layout = QHBoxLayout()
        self.save_button = QPushButton("Guardar Orden")
        self.save_button.setObjectName("saveButton")
        self.save_button.clicked.connect(self.save_order)
        button_layout.addWidget(self.save_button)

        self.clear_button = QPushButton("Limpiar Campos")
        self.clear_button.setObjectName("clearButton")
        self.clear_button.clicked.connect(self.clear_fields)
        button_layout.addWidget(self.clear_button)

        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def dragEnterEvent(self, event):
        if event.mimeData().hasUrls():
            event.accept()
        else:
            event.ignore()

    def dropEvent(self, event):
        for url in event.mimeData().urls():
            file_path = url.toLocalFile()
            if os.path.isfile(file_path):
                self.process_file(file_path)
                return
        QMessageBox.warning(self, "File Error", "The dragged file is not valid.")

    def select_file(self):
        options = QFileDialog.Options()
        file_path, _ = QFileDialog.getOpenFileName(self, "Seleccionar Orden File", "",
                                                   "Order Files (*.pdf *.docx *.txt);;All Files (*)", options=options)
        if file_path:
            self.process_file(file_path)

    def process_file(self, file_path: str) -> None:
        self.clear_fields() # Clear previous data
        self.file_path_label.setText(f"File loaded: {os.path.basename(file_path)}")

        content = ""
        file_extension = os.path.splitext(file_path)[1].lower()

        # Show loading indicator
        progress_dialog = QProgressDialog("Processing file...", "Cancelar", 0, 0, self)
        progress_dialog.setWindowModality(Qt.WindowModal)
        progress_dialog.setMinimumDuration(0) # Show immediately
        progress_dialog.setValue(0)
        progress_dialog.show()
        QApplication.processEvents() # Process events to show dialog immediately

        try:
            if file_extension == '.pdf':
                # Dynamically import docx here to avoid circular dependencies if parsing docx isn't always needed.
                from pdfplumber import open as pdfplumber_open
                with pdfplumber_open(file_path) as pdf:
                    for i, page in enumerate(pdf.pages):
                        content += page.extract_text() or ""
                        # Additionally, try to extract tables if available (for more structured parsing)
                        for table in page.extract_tables():
                            for row_data in table:
                                content += ",".join(str(cell) for cell in row_data if cell is not None) + "\n"
                        # Update progress for each page (simple example)
                        progress_dialog.setLabelText(f"Processing page {i+1} of {len(pdf.pages)}...")
                        progress_dialog.setValue(i + 1)
                        QApplication.processEvents() # Update progress bar
                        if progress_dialog.wasCanceled():
                            QMessageBox.warning(self, "Operation Cancelared", "File processing was canceled.")
                            return
            elif file_extension == '.docx':
                # Dynamically import docx here to avoid circular dependencies if parsing docx isn't always needed.
                from docx import Document
                doc = Document(file_path)
                for i, para in enumerate(doc.paragraphs):
                    content += para.text + "\n"
                    # No easy way to get total paragraphs for progress, so just a general update
                    if i % 10 == 0: # Update every 10 paragraphs
                        progress_dialog.setLabelText(f"Processing paragraph {i}...")
                        QApplication.processEvents() # Update progress bar
                        if progress_dialog.wasCanceled():
                            QMessageBox.warning(self, "Operation Cancelared", "File processing was canceled.")
                            return
            elif file_extension == '.txt':
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
            else:
                QMessageBox.warning(self, "Unsupported Format", "Please upload a PDF, DOCX, or TXT file.")
                return

            parsed_data = self.parse_content(content)
            if parsed_data and parsed_data.get("numero_orden"): # Check for essential data
                self.display_parsed_data(parsed_data)
            else:
                QMessageBox.warning(self, "Parsing Error", "Could not extract data from the file. Please check the format or try another file.")

        except Exception as e:
            QMessageBox.critical(self, "File Reading Error", f"An error occurred while processing the file: {e}")
            logging.error(f"Error processing file {file_path}: {e}", exc_info=True)
        finally:
            progress_dialog.close() # Ensure dialog is closed

    def parse_content(self, content: str) -> dict | None:
        """Tries to parse the content with several known parsers."""
        parsers = [
            parse_mcx_po,
            parse_pc002057_emaldo_po,
            parse_m229420_po
        ]

        for parser in parsers:
            try:
                parsed_data = parser(content)
                # Check for a core identifier to confirm successful parsing for *this* parser
                if parsed_data and parsed_data.get("numero_orden"):
                    logging.info(f"Content successfully parsed with {parser.__name__}")
                    return parsed_data
            except Exception as e:
                logging.warning(f"Parsing failed with {parser.__name__}: {e}")
                continue # Try next parser
        logging.warning("No known parser could extract data from the content.")
        return None

    def display_parsed_data(self, data: dict) -> None:
        """Displays the parsed data in the UI fields."""
        self.num_orden_input.setText(data.get("numero_orden", ""))

        date_dt = parse_date_format(data.get("fecha_recibida", ""))
        if date_dt:
            qdate = QDate(date_dt.year, date_dt.month, date_dt.day)
            self.fecha_recibida_input.setDate(qdate)
        else:
            logging.warning(f"Invalid date when displaying: {data.get('fecha_recibida', '')}. Setting current date.")
            self.fecha_recibida_input.setDate(QDate.currentDate())

        self.proveedor_origen_input.setText(data.get("proveedor_origen", ""))
        self.monto_total_input.setText(f"{data.get('monto_total', 0.0):.2f}")
        self.estado_combobox.setCurrentText(data.get("estado", "Pendiente"))

        self.products_table.setRowCount(0)
        products = json.loads(data.get("datos_productos_json", "[]"))
        self.products_table.setRowCount(len(products))

        for row, p in enumerate(products):
            self.products_table.setItem(row, 0, QTableWidgetItem(str(p.get("linea", str(row + 1)))))
            self.products_table.setItem(row, 1, QTableWidgetItem(f"{p.get('cantidad', 0):.2f}"))
            self.products_table.setItem(row, 2, QTableWidgetItem(p.get("unidad", "")))
            self.products_table.setItem(row, 3, QTableWidgetItem(p.get("codigo", "")))
            self.products_table.setItem(row, 4, QTableWidgetItem(p.get("descripcion", p.get("nombre", ""))))
            self.products_table.setItem(row, 5, QTableWidgetItem(f"{p.get('precio_unitario', 0.0):.2f}"))
            self.products_table.setItem(row, 6, QTableWidgetItem(f"{p.get('precio_total', 0.0):.2f}"))

        self.products_table.resizeColumnsToContents()

    def save_order(self) -> None:
        """Guardars the received purchase order to the database."""
        num_orden = self.num_orden_input.text().strip()
        fecha_recibida = self.fecha_recibida_input.date().toString(Qt.ISODate)
        proveedor_origen = self.proveedor_origen_input.text().strip()
        monto_total_text = self.monto_total_input.text().strip()
        estado = self.estado_combobox.currentText()

        if not num_orden or not proveedor_origen or not monto_total_text:
            QMessageBox.warning(self, "Incomplete Fields", "Please complete all main fields (Número de Orden, Proveedor de Origen, Monto Total).")
            return

        try:
            monto_total = float(monto_total_text)
        except ValueError:
            QMessageBox.warning(self, "Invalid Amount", "Total amount must be a valid number.")
            return

        products_data = []
        for row in range(self.products_table.rowCount()):
            try:
                linea = self.products_table.item(row, 0).text() if self.products_table.item(row, 0) else ""
                cantidad = float(self.products_table.item(row, 1).text()) if self.products_table.item(row, 1) and self.products_table.item(row, 1).text() else 0.0
                unidad = self.products_table.item(row, 2).text() if self.products_table.item(row, 2) else ""
                codigo = self.products_table.item(row, 3).text() if self.products_table.item(row, 3) else ""
                descripcion = self.products_table.item(row, 4).text() if self.products_table.item(row, 4) else ""
                precio_unitario = float(self.products_table.item(row, 5).text()) if self.products_table.item(row, 5) and self.products_table.item(row, 5).text() else 0.0
                precio_total = float(self.products_table.item(row, 6).text()) if self.products_table.item(row, 6) and self.products_table.item(row, 6).text() else 0.0

                products_data.append({
                    "linea": linea,
                    "cantidad": cantidad,
                    "unidad": unidad,
                    "codigo": codigo,
                    "descripcion": descripcion,
                    "precio_unitario": precio_unitario,
                    "precio_total": precio_total
                })
            except (ValueError, AttributeError) as e:
                QMessageBox.warning(self, "Product Error", f"Error in product data in row {row + 1}: {e}. Ensure Cantidad, Precio Unitario and Precio Total are valid numbers.")
                logging.error(f"Error processing product data to save: {e}", exc_info=True)
                return

        datos_productos_json = json.dumps(products_data, ensure_ascii=False)

        # Use GestorBaseDeDatos for insertion
        success, message = db_manager.ejecutar_consulta(
            '''
            INSERT INTO ordenes_compra_recibidas (numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''',
            (num_orden, fecha_recibida, proveedor_origen, monto_total, estado, self.file_path_label.text(), "", datos_productos_json)
        )

        if success:
            QMessageBox.information(self, "Success", "Received purchase order saved successfully.")
            self.clear_fields()
        else:
            QMessageBox.critical(self, "Guardar Error", message)


    def clear_fields(self) -> None:
        """Clears all UI fields."""
        self.num_orden_input.clear()
        self.fecha_recibida_input.setDate(QDate.currentDate())
        self.proveedor_origen_input.clear()
        self.monto_total_input.clear()
        self.estado_combobox.setCurrentIndex(0) # Set to "Pendiente"
        self.products_table.setRowCount(0)
        self.file_path_label.setText("Arrastra y suelta un archivo aquí o haz clic para seleccionar.")

class GenerarOCPage(QWidget):
    """
    Page to generate new purchase orders (PO) based on a received order.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.selected_received_order_id: int | None = None
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #007bff; /* Blue */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#generateButton {
                background-color: #28a745; /* Green */
            }
            QPushButton#generateButton:hover {
                background-color: #218838;
            }
            QPushButton#selectOrderButton {
                background-color: #ffc107; /* Yellow/Orange */
                color: #333333;
            }
            QPushButton#selectOrderButton:hover {
                background-color: #e0a800;
            }
            QPushButton#previewButton {
                background-color: #6f42c1; /* Purple */
            }
            QPushButton#previewButton:hover {
                background-color: #563d7c;
            }
            QTextEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Received Order Selection Section
        select_order_group = QGroupBox("Seleccionar Orden Recibida (Opcional)")
        select_order_layout = QHBoxLayout()
        self.received_order_label = QLabel("No order selected.")
        self.select_order_button = QPushButton("Seleccionar Orden")
        self.select_order_button.setObjectName("selectOrderButton")
        self.select_order_button.clicked.connect(self.open_select_received_order_dialog)
        select_order_layout.addWidget(self.received_order_label)
        select_order_layout.addWidget(self.select_order_button)
        select_order_group.setLayout(select_order_layout)
        main_layout.addWidget(select_order_group)
        main_layout.addSpacing(10)

        # Generada Order Details Section
        generated_order_group = QGroupBox("Detalles de la Orden a Generar")
        generated_order_layout = QFormLayout()

        # Improvement: Automatic Generada Número de Orden
        self.num_orden_generada_label = QLabel("Automatically Generada")
        generated_order_layout.addRow("Generada Número de Orden:", self.num_orden_generada_label)

        self.fecha_generada_input = QDateEdit()
        self.fecha_generada_input.setCalendarPopup(True)
        self.fecha_generada_input.setDate(QDate.currentDate())
        generated_order_layout.addRow("Generada Fecha:", self.fecha_generada_input)

        self.fecha_entrega_input = QDateEdit()
        self.fecha_entrega_input.setCalendarPopup(True)
        self.fecha_entrega_input.setDate(QDate.currentDate().addDays(7)) # Default to 7 days from now
        generated_order_layout.addRow("Fecha Estimada de Entrega:", self.fecha_entrega_input)


        self.proveedor_destino_input = QLineEdit()
        generated_order_layout.addRow("Proveedor Destino:", self.proveedor_destino_input)

        self.monto_total_generado_input = QLineEdit()
        self.monto_total_generado_input.setValidator(QDoubleValidator(0.0, 999999999.0, 2))
        self.monto_total_generado_input.setReadOnly(True) # Make it read-only if automatically calculated
        generated_order_layout.addRow("Monto Total:", self.monto_total_generado_input)

        self.estado_generado_combobox = QComboBox()
        self.estado_generado_combobox.addItems(["Pendiente", "In Process", "Completed", "Cancelared"])
        generated_order_layout.addRow("Estado:", self.estado_generado_combobox)

        self.formato_pdf_combobox = QComboBox()
        self.formato_pdf_combobox.addItems(["Demoga", "Emaldo"])
        generated_order_layout.addRow("Formato de PDF:", self.formato_pdf_combobox)

        generated_order_group.setLayout(generated_order_layout)
        main_layout.addWidget(generated_order_group)
        main_layout.addSpacing(10)

        # Product Table for Generada Order (Editable)
        products_gen_group = QGroupBox("Detalles del Producto (Modifiable)")
        products_gen_layout = QVBoxLayout()

        self.products_gen_table = QTableWidget()
        self.products_gen_table.setColumnCount(7) # Item, Parte (EDP), Parte del Cliente No., Descripción, Cantidad, Precio Unitario, Precio Total
        self.products_gen_table.setHorizontalHeaderLabels(["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Precio Unitario", "Precio Total"])
        self.products_gen_table.horizontalHeader().setStretchLastSection(True)
        self.products_gen_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        products_gen_layout.addWidget(self.products_gen_table)

        product_buttons_layout = QHBoxLayout()
        add_product_button = QPushButton("Agregar Producto")
        add_product_button.clicked.connect(self.add_product_row)
        product_buttons_layout.addWidget(add_product_button)

        remove_product_button = QPushButton("Eliminar Producto")
        remove_product_button.clicked.connect(self.remove_product_row)
        product_buttons_layout.addWidget(remove_product_button)

        products_gen_layout.addLayout(product_buttons_layout)

        products_gen_group.setLayout(products_gen_layout)
        main_layout.addWidget(products_gen_group)
        main_layout.addSpacing(10)


        # Action Buttons
        button_layout = QHBoxLayout()
        # New button for Preview
        self.preview_pdf_button = QPushButton("Vista Previa PDF")
        self.preview_pdf_button.setObjectName("previewButton")
        self.preview_pdf_button.clicked.connect(self.preview_generated_pdf)
        button_layout.addWidget(self.preview_pdf_button)

        self.generate_button = QPushButton("Generar y Guardar Orden")
        self.generate_button.setObjectName("generateButton")
        self.generate_button.clicked.connect(self.generate_and_save_order)
        button_layout.addWidget(self.generate_button)

        self.clear_gen_button = QPushButton("Limpiar Campos")
        self.clear_gen_button.setObjectName("clearButton")
        self.clear_gen_button.clicked.connect(self.clear_fields)
        button_layout.addWidget(self.clear_gen_button)

        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

        # Connect cell changes to recalculate total

    def add_product_row(self) -> None:
        """Adds a new product row to the editable table."""
        row_count = self.products_gen_table.rowCount()
        self.products_gen_table.insertRow(row_count)
        self.products_gen_table.setItem(row_count, 0, QTableWidgetItem(str(row_count + 1))) # Item number
        # FIX: Ensure all cells are initialized to prevent crashes
        for col in range(1, self.products_gen_table.columnCount()):
            if col in [4, 5, 6]: # Cantidad, Precio Unitario, Precio Total
                self.products_gen_table.setItem(row_count, col, QTableWidgetItem("0.00"))
            else:
                self.products_gen_table.setItem(row_count, col, QTableWidgetItem(""))

        # Make Cantidad and Precio Unitario editable for input
        qty_item = self.products_gen_table.item(row_count, 4)
        if qty_item:
            qty_item.setFlags(qty_item.flags() | Qt.ItemIsEditable)
        unit_price_item = self.products_gen_table.item(row_count, 5)
        if unit_price_item:
            unit_price_item.setFlags(unit_price_item.flags() | Qt.ItemIsEditable)

        # Apply validators to editable numeric fields if needed (QTableWidgetItem doesn't have direct validators)
        # You would typically do this on a custom delegate or custom QTableWidgetItem subclass if stricter validation is required at input time.
        # For now, it will rely on the float() conversion in recalculate_total and save_order.


    def remove_product_row(self) -> None:
        """Removes the selected row from the product table."""
        selected_rows = self.products_gen_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Delete Row", "Please select one or more rows to delete.")
            return

        # Delete rows in reverse order to avoid index issues
        for index in sorted([row.row() for row in selected_rows], reverse=True):
            self.products_gen_table.removeRow(index)

        # Re-number items after deletion
        for row in range(self.products_gen_table.rowCount()):
            # Ensure item exists before setting text
            item_num_item = self.products_gen_table.item(row, 0)
            if item_num_item:
                item_num_item.setText(str(row + 1))
            else: # If item doesn't exist for some reason, create it
                self.products_gen_table.setItem(row, 0, QTableWidgetItem(str(row + 1)))

        self.recalculate_total() # Recalculate total after removal

    def recalculate_total(self) -> None:
        """Recalculates the total amount of products in the table."""
        total_sum = 0.0
        for row in range(self.products_gen_table.rowCount()):
            try:
                qty_item = self.products_gen_table.item(row, 4)
                price_unit_item = self.products_gen_table.item(row, 5)

                qty = float(qty_item.text()) if qty_item and qty_item.text() else 0.0
                unit_price = float(price_unit_item.text()) if price_unit_item and price_unit_item.text() else 0.0

                row_total = qty * unit_price
                # Ensure the item for total exists before setting text
                total_item = self.products_gen_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_gen_table.setItem(row, 6, total_item)
                total_item.setText(f"{row_total:.2f}")

                total_sum += row_total
            except (ValueError, AttributeError):
                logging.warning(f"Non-numeric input in row {row} of the product table. Row total reset to 0.00.")
                # Ensure the total item is set to "0.00" on error
                total_item = self.products_gen_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_gen_table.setItem(row, 6, total_item)
                total_item.setText("0.00")
                continue
        self.monto_total_generado_input.setText(f"{total_sum:.2f}")

    def open_select_received_order_dialog(self) -> None:
        """Opens a dialog to select a received order as a base."""
        dialog = SelectReceivedOrderDialog(self)
        if dialog.exec_() == QDialog.Accepted:
            selected_id = dialog.selected_order_id
            if selected_id:
                self.load_received_order_for_generation(selected_id)
            else:
                QMessageBox.warning(self, "Empty Selection", "No received order was selected.")

    def load_received_order_for_generation(self, order_id: int) -> None:
        """Loads the details of a received order to use it for generation."""
        self.selected_received_order_id = order_id
        order_details = obtener_detalles_orden_recibida(order_id)
        if order_details:
            # Using .get() for robustness in case a key is missing
            self.received_order_label.setText(f"Selected Order: {order_details.get('numero_orden', 'N/A')} (Supplier: {order_details.get('proveedor_origen', 'N/A')})")

            self.proveedor_destino_input.setText(order_details.get('proveedor_origen', ''))
            self.monto_total_generado_input.setText(f"{order_details.get('monto_total', 0.0):.2f}")

            self.products_gen_table.setRowCount(0)
            products = json.loads(order_details.get("datos_productos_json", "[]"))
            self.products_gen_table.setRowCount(len(products))

            for row, p in enumerate(products):
                # FIX: Ensure all items are created with default values for numeric fields
                self.products_gen_table.setItem(row, 0, QTableWidgetItem(p.get("linea", str(row + 1))))
                self.products_gen_table.setItem(row, 1, QTableWidgetItem(p.get("codigo", "")))
                self.products_gen_table.setItem(row, 2, QTableWidgetItem(p.get("numero_cliente", "")))
                self.products_gen_table.setItem(row, 3, QTableWidgetItem(p.get("descripcion", p.get("nombre", ""))))
                self.products_gen_table.setItem(row, 4, QTableWidgetItem(f"{p.get('cantidad', 0):.2f}"))
                self.products_gen_table.setItem(row, 5, QTableWidgetItem(f"{p.get('precio_unitario', 0.0):.2f}"))
                self.products_gen_table.setItem(row, 6, QTableWidgetItem(f"{p.get('precio_total', 0.0):.2f}"))

                # Make editable numeric fields actually editable
                self.products_gen_table.item(row, 4).setFlags(self.products_gen_table.item(row, 4).flags() | Qt.ItemIsEditable)
                self.products_gen_table.item(row, 5).setFlags(self.products_gen_table.item(row, 5).flags() | Qt.ItemIsEditable)


            self.products_gen_table.resizeColumnsToContents()

        else:
            QMessageBox.warning(self, "Error", "Could not load received order details.")
            logging.error(f"No details found for received order with ID: {order_id}")

    def generate_unique_po_number(self) -> str:
        """Generates a unique purchase order number based on date and time."""
        timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
        # To make it more unique and sequential, you could query the last PO number for today
        # For simplicity, we'll use a timestamp. If multiple POs generated in same second, it might clash.
        # A safer approach for production would be a counter stored in DB or a UUID.
        # For this example, let's use a very basic timestamp-based approach.
        return f"PO-{timestamp}"

    def get_order_data_for_pdf(self) -> dict | None:
        """Collects UI data to generate the PDF."""
        num_orden_generada = self.num_orden_generada_label.text().strip() # Use the label for the number
        if num_orden_generada == "Automatically Generada": # Ensure it's not the placeholder
            num_orden_generada = self.generate_unique_po_number()


        fecha_generada = self.fecha_generada_input.date().toString(Qt.ISODate)
        fecha_entrega = self.fecha_entrega_input.date().toString(Qt.ISODate)
        proveedor_destino = self.proveedor_destino_input.text().strip()
        monto_total_text = self.monto_total_generado_input.text().strip()

        if not num_orden_generada or not proveedor_destino or not monto_total_text:
            QMessageBox.warning(self, "Incomplete Fields", "Please complete all main fields (Generada Número de Orden, Destination Supplier, Monto Total).")
            return None

        try:
            monto_total = float(monto_total_text)
        except ValueError:
            QMessageBox.warning(self, "Invalid Amount", "Total amount must be a valid number.")
            return None

        products_data = []
        for row in range(self.products_gen_table.rowCount()):
            try:
                linea = self.products_gen_table.item(row, 0).text() if self.products_gen_table.item(row, 0) else ""
                codigo = self.products_gen_table.item(row, 1).text() if self.products_gen_table.item(row, 1) else ""
                numero_cliente = self.products_gen_table.item(row, 2).text() if self.products_gen_table.item(row, 2) else ""
                descripcion = self.products_gen_table.item(row, 3).text() if self.products_gen_table.item(row, 3) else ""
                cantidad = float(self.products_gen_table.item(row, 4).text()) if self.products_gen_table.item(row, 4) and self.products_gen_table.item(row, 4).text() else 0.0
                precio_unitario = float(self.products_gen_table.item(row, 5).text()) if self.products_gen_table.item(row, 5) and self.products_gen_table.item(row, 5).text() else 0.0
                precio_total = float(self.products_gen_table.item(row, 6).text()) if self.products_gen_table.item(row, 6) and self.products_gen_table.item(row, 6).text() else 0.0

                products_data.append({
                    "linea": linea,
                    "codigo": codigo,
                    "numero_cliente": numero_cliente,
                    "descripcion": descripcion,
                    "cantidad": cantidad,
                    "precio_unitario": precio_unitario,
                    "precio_total": precio_total
                })
            except (ValueError, AttributeError) as e:
                QMessageBox.warning(self, "Product Error", f"Error in product data in row {row + 1}: {e}. Ensure Cantidad, Precio Unitario and Precio Total are valid numbers.")
                logging.error(f"Error processing product data to generate PDF: {e}", exc_info=True)
                return None

        return {
            "numero_orden_generada": num_orden_generada,
            "fecha_generada": fecha_generada,
            "proveedor_destino": proveedor_destino,
            "monto_total": monto_total,
            "fecha_entrega": fecha_entrega,
            "datos_productos_json": json.dumps(products_data, ensure_ascii=False)
        }

    def preview_generated_pdf(self) -> None:
        """Generates a PDF preview and opens it in the default viewer."""
        order_data_for_pdf = self.get_order_data_for_pdf()
        if not order_data_for_pdf:
            return # get_order_data_for_pdf already showed a warning

        formato_pdf = self.formato_pdf_combobox.currentText()

        # Generate to a temporary file
        temp_dir = tempfile.gettempdir()
        temp_file_path = os.path.join(temp_dir, f"temp_PO_preview_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf")

        generation_success = False
        generation_message = ""

        # Show loading indicator
        progress_dialog = QProgressDialog("Generating PDF preview...", "Cancelar", 0, 0, self)
        progress_dialog.setWindowModality(Qt.WindowModal)
        progress_dialog.setMinimumDuration(0) # Show immediately
        progress_dialog.setValue(0)
        progress_dialog.show()
        QApplication.processEvents() # Process events to show dialog immediately

        try:
            if formato_pdf == "Demoga":
                generation_success, generation_message = create_demoga_pdf(temp_file_path, order_data_for_pdf)
            elif formato_pdf == "Emaldo":
                generation_success, generation_message = create_emaldo_pdf(temp_file_path, order_data_for_pdf)
            else:
                generation_message = "Unsupported PDF format for preview."
                logging.error(f"Unsupported PDF format for preview: {formato_pdf}")
        finally:
            progress_dialog.close() # Ensure dialog is closed

        if generation_success:
            QMessageBox.information(self, "Preview Generada", "A PDF preview has been generated. Opening in your default viewer.")
            QDesktopServices.openUrl(QUrl.fromLocalFile(temp_file_path))
            logging.info(f"PDF preview generated at: {temp_file_path}")
        else:
            QMessageBox.critical(self, "Preview Error", f"Failed to generate PDF preview: {generation_message}")


    def generate_and_save_order(self) -> None:
        """Generates the PDF and saves the generated purchase order to the database."""

        order_data_for_pdf = self.get_order_data_for_pdf()
        if not order_data_for_pdf:
            return # get_order_data_for_pdf already showed a warning

        # Use the generated unique number for saving
        num_orden_generada = order_data_for_pdf["numero_orden_generada"]
        fecha_generada = order_data_for_pdf["fecha_generada"]
        fecha_entrega = order_data_for_pdf["fecha_entrega"]
        proveedor_destino = order_data_for_pdf["proveedor_destino"]
        monto_total = order_data_for_pdf["monto_total"]
        datos_productos_json = order_data_for_pdf["datos_productos_json"]
        estado = self.estado_generado_combobox.currentText()
        formato_pdf = self.formato_pdf_combobox.currentText()


        # Request directory to save PDF
        output_dir = QFileDialog.getExistingDirectory(self, "Select Folder to Guardar PDF", os.path.expanduser("~"))
        if not output_dir:
            return # User cancelled

        file_name = f"PO_GENERATED_{num_orden_generada}.pdf"
        pdf_path = os.path.join(output_dir, file_name)

        generation_success = False
        generation_message = ""

        # Show loading indicator
        progress_dialog = QProgressDialog("Generating PDF and saving...", "Cancelar", 0, 0, self)
        progress_dialog.setWindowModality(Qt.WindowModal)
        progress_dialog.setMinimumDuration(0)
        progress_dialog.setValue(0)
        progress_dialog.show()
        QApplication.processEvents() # Process events to show dialog immediately

        try:
            if formato_pdf == "Demoga":
                generation_success, generation_message = create_demoga_pdf(pdf_path, order_data_for_pdf)
            elif formato_pdf == "Emaldo":
                generation_success, generation_message = create_emaldo_pdf(pdf_path, order_data_for_pdf)
            else:
                generation_message = "Unsupported PDF format."
                logging.error(f"Unsupported PDF format: {formato_pdf}")
        finally:
            progress_dialog.close() # Ensure dialog is closed


        if not generation_success:
            QMessageBox.critical(self, "PDF Generation Error", f"Failed to generate PDF: {generation_message}")
            return

        # Guardar to DB using GestorBaseDeDatos
        success, message = db_manager.ejecutar_consulta(
            '''
            INSERT INTO ordenes_compra_generadas (numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, formato_pdf)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''',
            (num_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, pdf_path, "", self.selected_received_order_id, datos_productos_json, fecha_entrega, formato_pdf)
        )

        if success:
            QMessageBox.information(self, "Success", f"Generada purchase order saved successfully and PDF created at:\n{pdf_path}")
            self.clear_fields()
        else:
            QMessageBox.critical(self, "Guardar Error", message)
            # If the order is not saved to the DB, consider deleting the generated PDF to avoid inconsistencies
            if os.path.exists(pdf_path):
                try:
                    os.remove(pdf_path)
                    logging.info(f"Generada PDF deleted due to DB error: {pdf_path}")
                except Exception as e:
                    logging.error(f"Error deleting PDF after DB failure: {pdf_path} - {e}")


    def clear_fields(self) -> None:
        """Clears all UI fields on the Generar Orden page."""
        self.num_orden_generada_label.setText("Automatically Generada") # Reset label
        self.fecha_generada_input.setDate(QDate.currentDate())
        self.fecha_entrega_input.setDate(QDate.currentDate().addDays(7))
        self.proveedor_destino_input.clear()
        self.monto_total_generado_input.setText("0.00") # Reset total
        self.estado_generado_combobox.setCurrentIndex(0) # Pendiente
        self.formato_pdf_combobox.setCurrentIndex(0) # Demoga
        self.products_gen_table.setRowCount(0)
        self.selected_received_order_id = None
        self.received_order_label.setText("No order selected.")

class SelectReceivedOrderDialog(QDialog):
    """
    Dialog to allow the user to select a received purchase order
    from a list to use as a base for generating a new order.
    """
    def __init__(self, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle("Select Received Order")
        self.setFixedSize(700, 500)
        self.selected_order_id: int | None = None
        self.init_ui()
        self.apply_styles()
        self.load_orders()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QPushButton {
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QVBoxLayout()

        self.search_input = QLineEdit(self)
        self.search_input.setPlaceholderText("Buscar por número de orden o proveedor...")
        self.search_input.textChanged.connect(self.filter_orders)
        layout.addWidget(self.search_input)

        self.orders_table = QTableWidget()
        self.orders_table.setColumnCount(4)
        self.orders_table.setHorizontalHeaderLabels(["ID", "Número de Orden", "Fecha de Recepción", "Supplier"])
        self.orders_table.horizontalHeader().setStretchLastSection(True)
        self.orders_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.orders_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.orders_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        layout.addWidget(self.orders_table)

        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(self.accept_selection)
        button_box.rejected.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addWidget(button_box)

        self.setLayout(layout)

    def load_orders(self) -> None:
        """Loads all received orders from the database."""
        orders = db_manager.obtener_todos("SELECT id, numero_orden, fecha_recibida, proveedor_origen FROM ordenes_compra_recibidas")
        self.all_orders = orders
        self.display_orders(orders)

    def display_orders(self, orders_to_display: list[tuple]) -> None:
        """Displays a list of orders in the table."""
        self.orders_table.setRowCount(len(orders_to_display))
        for row, order in enumerate(orders_to_display):
            self.orders_table.setItem(row, 0, QTableWidgetItem(str(order[0])))
            self.orders_table.setItem(row, 1, QTableWidgetItem(order[1]))

            date_dt = parse_date_format(order[2])
            display_date = QDate(date_dt.year, date_dt.month, date_dt.day).toString("dd/MM/yyyy") if date_dt else order[2]
            self.orders_table.setItem(row, 2, QTableWidgetItem(display_date))

            self.orders_table.setItem(row, 3, QTableWidgetItem(order[3]))
        self.orders_table.resizeColumnsToContents()

    def filter_orders(self, text: str) -> None:
        """Filters displayed orders based on search text."""
        filtered_orders = []
        search_text = text.lower()
        for order in self.all_orders:
            order_number = order[1].lower()
            supplier = order[3].lower()
            if search_text in order_number or search_text in supplier:
                filtered_orders.append(order)
        self.display_orders(filtered_orders)

    def accept_selection(self) -> None:
        """Accepts the order selection and closes the dialog."""
        selected_rows = self.orders_table.selectionModel().selectedRows()
        if selected_rows:
            self.selected_order_id = int(self.orders_table.item(selected_rows[0].row(), 0).text())
            self.accept()
        else:
            QMessageBox.warning(self, "No Selection", "Please select an order from the list.")

# New Dialog for Full Order Editing (Improvement: Comprehensive Modification)
class EditOrderDetailsDialog(QDialog):
    """
    Dialog to edit all aspects of a purchase order (received or generated).
    """
    def __init__(self, order_id: int, order_type: str, parent_page: QWidget, admin_username: str):
        super().__init__(parent_page)
        self.order_id = order_id
        self.order_type = order_type
        self.parent_page = parent_page
        self.admin_username = admin_username
        self.order_details = None # Will store full order details

        self.setWindowTitle(f"Edit {order_type} Order: ID {order_id}")
        self.setMinimumSize(800, 600)
        self.init_ui()
        self.apply_styles()
        self.load_order_details()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #28a745; /* Green for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #218838;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #333333;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()
        self.form_layout = QFormLayout()

        # Common fields for both order types (initially hidden or shown dynamically)
        self.num_order_input = QLineEdit()
        self.fecha_input = QDateEdit()
        self.fecha_input.setCalendarPopup(True)
        self.proveedor_input = QLineEdit()
        self.monto_total_input = QLineEdit()
        self.monto_total_input.setValidator(QDoubleValidator(0.0, 999999999.0, 2))
        self.monto_total_input.setReadOnly(True) # Calculated from products
        self.estado_combobox = QComboBox()
        self.estado_combobox.addItems(["Pendiente", "Procesada", "Cancelared"])

        # Specific fields for Generada orders (initially hidden)
        self.fecha_entrega_input = QDateEdit()
        self.fecha_entrega_input.setCalendarPopup(True)
        self.estado_entrega_combobox = QComboBox()
        self.estado_entrega_combobox.addItems(["Pendiente", "In Transit", "Delivered", "Delivery Problem"])
        self.formato_pdf_combobox = QComboBox()
        self.formato_pdf_combobox.addItems(["Demoga", "Emaldo"])

        # Add rows to layout, visibility will be controlled by load_order_details
        self.form_layout.addRow("Order ID:", QLabel(str(self.order_id))) # Display ID, not editable

        self.label_num_order = QLabel("Número de Orden:")
        self.form_layout.addRow(self.label_num_order, self.num_order_input)

        self.label_fecha = QLabel("Fecha:")
        self.form_layout.addRow(self.label_fecha, self.fecha_input)

        self.label_proveedor = QLabel("Supplier:")
        self.form_layout.addRow(self.label_proveedor, self.proveedor_input)

        self.label_monto_total = QLabel("Monto Total:")
        self.form_layout.addRow(self.label_monto_total, self.monto_total_input)

        self.label_estado = QLabel("Estado:")
        self.form_layout.addRow(self.label_estado, self.estado_combobox)

        self.label_fecha_entrega = QLabel("Delivery Fecha:")
        self.form_layout.addRow(self.label_fecha_entrega, self.fecha_entrega_input)

        self.label_estado_entrega = QLabel("Delivery Estado:")
        self.form_layout.addRow(self.label_estado_entrega, self.estado_entrega_combobox)

        self.label_formato_pdf = QLabel("Formato de PDF:")
        self.form_layout.addRow(self.label_formato_pdf, self.formato_pdf_combobox)

        main_layout.addLayout(self.form_layout)

        # Products Table
        products_group = QGroupBox("Detalles del Producto")
        products_layout = QVBoxLayout()

        self.products_table = QTableWidget()
        self.products_table.setColumnCount(7) # Item, Part, Customer Num, Descripción, Cantidad, Precio Unitario, Precio Total
        self.products_table.setHorizontalHeaderLabels(["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Precio Unitario", "Precio Total"])
        self.products_table.horizontalHeader().setStretchLastSection(True)
        self.products_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        products_layout.addWidget(self.products_table)

        product_buttons_layout = QHBoxLayout()
        add_product_button = QPushButton("Agregar Producto")
        add_product_button.clicked.connect(self.add_product_row)
        product_buttons_layout.addWidget(add_product_button)

        remove_product_button = QPushButton("Eliminar Producto")
        remove_product_button.clicked.connect(self.remove_product_row)
        product_buttons_layout.addWidget(remove_product_button)

        products_layout.addLayout(product_buttons_layout)

        products_group.setLayout(products_layout)
        main_layout.addWidget(products_group)

        # Buttons
        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.save_changes)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        main_layout.addWidget(button_box)

        self.setLayout(main_layout)

    def load_order_details(self) -> None:
        """Loads the details of the selected order into the UI fields."""
        if self.order_type == "Recibida":
            self.order_details = obtener_detalles_orden_recibida(self.order_id)
            self.setWindowTitle(f"Edit Received Order: {self.order_details.get('numero_orden', '')}")
            self.label_num_order.setText("Número de Orden:")
            self.num_order_input.setText(self.order_details.get("numero_orden", ""))

            date_dt = parse_date_format(self.order_details.get("fecha_recibida", ""))
            if date_dt: self.fecha_input.setDate(QDate(date_dt.year, date_dt.month, date_dt.day))
            self.label_fecha.setText("Fecha de Recepción:")

            self.label_proveedor.setText("Proveedor de Origen:")
            self.proveedor_input.setText(self.order_details.get("proveedor_origen", ""))
            self.estado_combobox.addItems(["Pendiente", "Procesada", "Cancelared"])
            self.estado_combobox.setCurrentText(self.order_details.get("estado", "Pendiente"))

            # Hide generated-specific fields
            self.label_fecha_entrega.hide()
            self.fecha_entrega_input.hide()
            self.label_estado_entrega.hide()
            self.estado_entrega_combobox.hide()
            self.label_formato_pdf.hide()
            self.formato_pdf_combobox.hide()

        elif self.order_type == "Generada":
            self.order_details = obtener_detalles_orden_generada(self.order_id)
            self.setWindowTitle(f"Edit Generada Order: {self.order_details.get('numero_orden_generada', '')}")
            self.label_num_order.setText("Generada Número de Orden:")
            self.num_order_input.setText(self.order_details.get("numero_orden_generada", ""))

            date_dt = parse_date_format(self.order_details.get("fecha_generada", ""))
            if date_dt: self.fecha_input.setDate(QDate(date_dt.year, date_dt.month, date_dt.day))
            self.label_fecha.setText("Generada Fecha:")

            self.label_proveedor.setText("Proveedor Destino:")
            self.proveedor_input.setText(self.order_details.get("proveedor_destino", ""))
            self.estado_combobox.addItems(["Pendiente", "In Process", "Completed", "Cancelared"])
            self.estado_combobox.setCurrentText(self.order_details.get("estado", "Pendiente"))

            # Show and populate generated-specific fields
            self.label_fecha_entrega.show()
            self.fecha_entrega_input.show()
            date_dt_entrega = parse_date_format(self.order_details.get("fecha_entrega", ""))
            if date_dt_entrega: self.fecha_entrega_input.setDate(QDate(date_dt_entrega.year, date_dt_entrega.month, date_dt_entrega.day))

            self.label_estado_entrega.show()
            self.estado_entrega_combobox.show()
            self.estado_entrega_combobox.setCurrentText(self.order_details.get("estado_entrega", "Pendiente"))

            self.label_formato_pdf.show()
            self.formato_pdf_combobox.show()
            self.formato_pdf_combobox.setCurrentText(self.order_details.get("formato_pdf", "Demoga"))

        if not self.order_details:
            QMessageBox.critical(self, "Load Error", "Could not load order details.")
            self.reject()
            return

        self.monto_total_input.setText(f"{self.order_details.get('monto_total', 0.0):.2f}")

        # Load products
        products = json.loads(self.order_details.get("datos_productos_json", "[]"))
        self.products_table.setRowCount(len(products))
        for row, p in enumerate(products):
            self.products_table.setItem(row, 0, QTableWidgetItem(p.get("linea", str(row + 1))))
            self.products_table.setItem(row, 1, QTableWidgetItem(p.get("codigo", "")))
            self.products_table.setItem(row, 2, QTableWidgetItem(p.get("numero_cliente", "")))
            self.products_table.setItem(row, 3, QTableWidgetItem(p.get("descripcion", p.get("nombre", ""))))
            self.products_table.setItem(row, 4, QTableWidgetItem(f"{p.get('cantidad', 0):.2f}"))
            self.products_table.setItem(row, 5, QTableWidgetItem(f"{p.get('precio_unitario', 0.0):.2f}"))
            self.products_table.setItem(row, 6, QTableWidgetItem(f"{p.get('precio_total', 0.0):.2f}"))

            # Make quantity and unit price columns editable
            self.products_table.item(row, 4).setFlags(self.products_table.item(row, 4).flags() | Qt.ItemIsEditable)
            self.products_table.item(row, 5).setFlags(self.products_table.item(row, 5).flags() | Qt.ItemIsEditable)

        self.products_table.resizeColumnsToContents()

    def add_product_row(self):
        """Adds a new product row to the editable table."""
        row_count = self.products_table.rowCount()
        self.products_table.insertRow(row_count)
        self.products_table.setItem(row_count, 0, QTableWidgetItem(str(row_count + 1)))
        for col in range(1, self.products_table.columnCount()):
            if col in [4, 5, 6]: # Cantidad, Precio Unitario, Precio Total
                self.products_table.setItem(row_count, col, QTableWidgetItem("0.00"))
            else:
                self.products_table.setItem(row_count, col, QTableWidgetItem(""))

        # Make Cantidad and Precio Unitario editable for input
        qty_item = self.products_table.item(row_count, 4)
        if qty_item:
            qty_item.setFlags(qty_item.flags() | Qt.ItemIsEditable)
        unit_price_item = self.products_table.item(row_count, 5)
        if unit_price_item:
            unit_price_item.setFlags(unit_price_item.flags() | Qt.ItemIsEditable)

    def remove_product_row(self):
        """Removes the selected row from the product table."""
        selected_rows = self.products_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Delete Row", "Please select one or more rows to delete.")
            return

        for index in sorted([row.row() for row in selected_rows], reverse=True):
            self.products_table.removeRow(index)

        for row in range(self.products_table.rowCount()):
            item_num_item = self.products_table.item(row, 0)
            if item_num_item:
                item_num_item.setText(str(row + 1))
            else:
                self.products_table.setItem(row, 0, QTableWidgetItem(str(row + 1)))

        self.recalculate_total()

    def recalculate_total(self):
        """Recalculates the total amount of products in the table."""
        total_sum = 0.0
        for row in range(self.products_table.rowCount()):
            try:
                qty_item = self.products_table.item(row, 4)
                price_unit_item = self.products_table.item(row, 5)

                qty = float(qty_item.text()) if qty_item and qty_item.text() else 0.0
                unit_price = float(price_unit_item.text()) if price_unit_item and price_unit_item.text() else 0.0

                row_total = qty * unit_price
                total_item = self.products_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_table.setItem(row, 6, total_item)
                total_item.setText(f"{row_total:.2f}")

                total_sum += row_total
            except (ValueError, AttributeError):
                logging.warning(f"Non-numeric input in row {row} of the product table. Row total reset to 0.00.")
                total_item = self.products_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_table.setItem(row, 6, total_item)
                total_item.setText("0.00")
                continue
        self.monto_total_input.setText(f"{total_sum:.2f}")

    def save_changes(self):
        """Guardars all order changes to the database."""
        auth_dialog = ContraseñaAuthDialog(self.admin_username, self)
        if auth_dialog.exec_() == QDialog.Accepted:
            updated_data = {}
            products_data = []

            # Collect main order details
            if self.order_type == "Recibida":
                updated_data["numero_orden"] = self.num_order_input.text().strip()
                updated_data["fecha_recibida"] = self.fecha_input.date().toString(Qt.ISODate)
                updated_data["proveedor_origen"] = self.proveedor_input.text().strip()
                updated_data["monto_total"] = float(self.monto_total_input.text())
                updated_data["estado"] = self.estado_combobox.currentText()
            elif self.order_type == "Generada":
                updated_data["numero_orden_generada"] = self.num_order_input.text().strip()
                updated_data["fecha_generada"] = self.fecha_input.date().toString(Qt.ISODate)
                updated_data["proveedor_destino"] = self.proveedor_input.text().strip()
                updated_data["monto_total"] = float(self.monto_total_input.text())
                updated_data["estado"] = self.estado_combobox.currentText()
                updated_data["fecha_entrega"] = self.fecha_entrega_input.date().toString(Qt.ISODate)
                updated_data["estado_entrega"] = self.estado_entrega_combobox.currentText()
                updated_data["formato_pdf"] = self.formato_pdf_combobox.currentText()

            # Collect product data
            for row in range(self.products_table.rowCount()):
                try:
                    p = {}
                    p["linea"] = self.products_table.item(row, 0).text() if self.products_table.item(row, 0) else ""
                    p["codigo"] = self.products_table.item(row, 1).text() if self.products_table.item(row, 1) else ""
                    p["numero_cliente"] = self.products_table.item(row, 2).text() if self.products_table.item(row, 2) else ""
                    p["descripcion"] = self.products_table.item(row, 3).text() if self.products_table.item(row, 3) else ""
                    p["cantidad"] = float(self.products_table.item(row, 4).text()) if self.products_table.item(row, 4) and self.products_table.item(row, 4).text() else 0.0
                    p["precio_unitario"] = float(self.products_table.item(row, 5).text()) if self.products_table.item(row, 5) and self.products_table.item(row, 5).text() else 0.0
                    p["precio_total"] = float(self.products_table.item(row, 6).text()) if self.products_table.item(row, 6) and self.products_table.item(row, 6).text() else 0.0
                    products_data.append(p)
                except (ValueError, AttributeError) as e:
                    QMessageBox.warning(self, "Product Error", f"Error in product data in row {row + 1}: {e}. Ensure Cantidad, Precio Unitario and Precio Total are valid numbers.")
                    logging.error(f"Error collecting product data to update: {e}", exc_info=True)
                    return

            updated_data["datos_productos_json"] = json.dumps(products_data, ensure_ascii=False)

            # Perform database update
            success, message = actualizar_orden_en_bd(self.order_id, self.order_type, updated_data)

            if success:
                QMessageBox.information(self, "Success", message)
                # If it's a generated order, ask to regenerate PDF
                if self.order_type == "Generada":
                    regenerate_confirm = QMessageBox.question(self, "Regenerate PDF",
                                                              "The order has been modified. Do you want to regenerate the PDF file with the changes?",
                                                              QMessageBox.Yes | QMessageBox.No)
                    if regenerate_confirm == QMessageBox.Yes:
                        # Fetch the latest data after DB update
                        current_order_data = obtener_detalles_orden_generada(self.order_id)
                        if current_order_data:
                            # Use existing path if available, otherwise prompt for new
                            existing_pdf_path = current_order_data.get("ruta_archivo_generado", "")

                            output_dir = os.path.dirname(existing_pdf_path) if existing_pdf_path and os.path.exists(existing_pdf_path) else os.path.expanduser("~")
                            file_name = f"PO_GENERATED_{current_order_data['numero_orden_generada']}.pdf"
                            pdf_path = os.path.join(output_dir, file_name)

                            generation_success = False
                            generation_message = ""

                            # Show loading indicator
                            progress_dialog = QProgressDialog("Regenerating PDF...", "Cancelar", 0, 0, self)
                            progress_dialog.setWindowModality(Qt.WindowModal)
                            progress_dialog.setMinimumDuration(0)
                            progress_dialog.setValue(0)
                            progress_dialog.show()
                            QApplication.processEvents()

                            try:
                                if current_order_data["formato_pdf"] == "Demoga":
                                    generation_success, generation_message = create_demoga_pdf(pdf_path, current_order_data)
                                elif current_order_data["formato_pdf"] == "Emaldo":
                                    generation_success, generation_message = create_emaldo_pdf(pdf_path, current_order_data)
                            finally:
                                progress_dialog.close()

                            if generation_success:
                                QMessageBox.information(self, "PDF Regenerated", f"PDF regenerated successfully at:\n{pdf_path}")
                                # Update DB with new PDF path if it changed (e.g., if user chose a new dir)
                                if existing_pdf_path != pdf_path:
                                    db_manager.ejecutar_consulta(
                                        "UPDATE ordenes_compra_generadas SET ruta_archivo_generado = ? WHERE id = ?",
                                        (pdf_path, self.order_id)
                                    )
                                QDesktopServices.openUrl(QUrl.fromLocalFile(pdf_path))
                            else:
                                QMessageBox.warning(self, "PDF Regeneration Error", f"Could not regenerate PDF: {generation_message}")
                                logging.error(f"Failed to regenerate PDF for order ID {self.order_id}: {generation_message}")
                        else:
                            QMessageBox.warning(self, "Error", "Could not get updated order data to regenerate PDF.")
                            logging.error(f"Could not get updated order data for order ID {self.order_id} to regenerate PDF.")

                self.parent_page.cargar_historial() # Refresh the history table in the main window
                self.accept()
            else:
                QMessageBox.warning(self, "Guardar Error", message)
        else:
            QMessageBox.warning(self, "Authorization Failed", "Modification was canceled or password was incorrect.")


class VerHistorialOrdenesPage(QWidget):
    """
    Page to view the history of purchase orders (received and generated),
    filter, search, and export. Also allows editing and deleting.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.current_user_role: str | None = main_window.user_role
        self.current_username: str | None = main_window.username_logged_in
        self.all_history_data: list[list] = [] # Store all history data for filtering
        self.init_ui()
        self.apply_styles()
        self.cargar_historial()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #007bff; /* Blue */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#exportButton {
                background-color: #17a2b8; /* Cyan */
            }
            QPushButton#exportButton:hover {
                background-color: #138496;
            }
            QPushButton#editButton {
                background-color: #ffc107; /* Yellow/Orange */
                color: #333333;
            }
            QPushButton#editButton:hover {
                background-color: #e0a800;
            }
            QPushButton#deleteButton {
                background-color: #dc3545; /* Red */
            }
            QPushButton#deleteButton:hover {
                background-color: #c82333;
            }
            QPushButton#viewPdfButton {
                background-color: #6f42c1; /* Purple */
            }
            QPushButton#viewPdfButton:hover {
                background-color: #563d7c;
            }
             QPushButton#changeDeliveryEstadoButton {
                background-color: #20c997; /* Teal */
            }
            QPushButton#changeDeliveryEstadoButton:hover {
                background-color: #17a2b8;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Filter and Buscar Controls
        filter_group = QGroupBox("Filtros y Búsqueda")
        filter_layout = QFormLayout()

        self.filter_type_combobox = QComboBox()
        self.filter_type_combobox.addItems(["All", "Received", "Generada"])
        self.filter_type_combobox.currentIndexChanged.connect(self.cargar_historial)
        filter_layout.addRow("Tipo de Orden:", self.filter_type_combobox)

        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("Buscar por número de orden o proveedor...")
        self.search_input.textChanged.connect(self.filter_historial)
        filter_layout.addRow("Buscar:", self.search_input)

        filter_group.setLayout(filter_layout)
        main_layout.addWidget(filter_group)
        main_layout.addSpacing(10)

        # History Table
        self.history_table = QTableWidget()
        self.history_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.history_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.history_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        main_layout.addWidget(self.history_table)
        main_layout.addSpacing(10)

        # Action Buttons
        action_buttons_layout = QHBoxLayout()

        export_button = QPushButton("Exportar Historial (CSV)")
        export_button.setObjectName("exportButton")
        export_button.clicked.connect(self.export_history_to_csv)
        action_buttons_layout.addWidget(export_button)

        self.edit_button = QPushButton("Editar Orden")
        self.edit_button.setObjectName("editButton")
        self.edit_button.clicked.connect(self.edit_selected_order)
        action_buttons_layout.addWidget(self.edit_button)

        self.delete_button = QPushButton("Eliminar Orden")
        self.delete_button.setObjectName("deleteButton")
        # Correction: Connect to the correct method to delete orders
        self.delete_button.clicked.connect(self.delete_selected_order)
        action_buttons_layout.addWidget(self.delete_button)

        self.view_pdf_button = QPushButton("Ver PDF")
        self.view_pdf_button.setObjectName("viewPdfButton")
        self.view_pdf_button.clicked.connect(self.view_selected_order_pdf)
        action_buttons_layout.addWidget(self.view_pdf_button)

        self.change_delivery_status_button = QPushButton("Cambiar Estado de Entrega")
        self.change_delivery_status_button.setObjectName("changeDeliveryEstadoButton")
        self.change_delivery_status_button.clicked.connect(self.change_delivery_status_for_generated_order)
        action_buttons_layout.addWidget(self.change_delivery_status_button)


        main_layout.addLayout(action_buttons_layout)
        self.setLayout(main_layout)

        # Adjust button visibility based on user role
        self.update_ui_for_role()

    def update_ui_for_role(self) -> None:
        """Adjusts the visibility of UI elements based on the user's role."""
        is_admin = (self.current_user_role == 'admin')
        self.edit_button.setVisible(is_admin)
        self.delete_button.setVisible(is_admin)
        self.change_delivery_status_button.setVisible(is_admin)

    def cargar_historial(self) -> None:
        """Loads the complete order history and displays it."""

        selected_type = self.filter_type_combobox.currentText()
        all_orders: list[list] = []

        if selected_type in ["All", "Received"]:
            # Select all columns explicitly to ensure consistent indexing
            received_orders_raw = db_manager.obtener_todos("SELECT id, numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json FROM ordenes_compra_recibidas")
            for row in received_orders_raw:
                # Add placeholders for 'fecha_entrega', 'estado_entrega', 'formato_pdf' to match 'Generada' structure
                all_orders.append(list(row) + ["Received", "", "", ""])

        if selected_type in ["All", "Generada"]:
            # Select all columns explicitly to ensure consistent indexing
            generated_orders_raw = db_manager.obtener_todos("SELECT id, numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, estado_entrega, formato_pdf FROM ordenes_compra_generadas")
            for row in generated_orders_raw:
                 # Adjust order to match 'Received' for display (Tipo at index 5)
                all_orders.append([
                    row[0], # id
                    row[1], # numero_orden_generada
                    row[2], # fecha_generada
                    row[3], # proveedor_destino
                    row[4], # monto_total
                    "Generada", # type (manual string)
                    row[6], # ruta_archivo_generado
                    row[7], # ruta_foto
                    row[9], # datos_productos_json
                    row[10], # fecha_entrega
                    row[11], # estado_entrega
                    row[12] # formato_pdf
                ])

        # Sort orders by date, then by type
        all_orders.sort(key=lambda x: (
            parse_date_format(x[2]) if parse_date_format(x[2]) else datetime.min, # Use datetime objects for proper sorting
            x[5] == 'Generada' # Received orders first, then Generada
        ))

        headers = ["ID", "Número de Orden", "Fecha", "Proveedor/Destino", "Monto Total", "Tipo", "Ruta del Archivo", "Delivery Fecha", "Delivery Estado", "PDF Format"]
        self.history_table.setColumnCount(len(headers))
        self.history_table.setHorizontalHeaderLabels(headers)

        self.all_history_data = all_orders # Store all orders for filtering

        self.display_filtered_history(all_orders)
        self.history_table.resizeColumnsToContents()
        self.history_table.horizontalHeader().setStretchLastSection(True)


    def display_filtered_history(self, filtered_data: list[list]) -> None:
        """Displays the filtered data in the history table."""
        self.history_table.setRowCount(len(filtered_data))
        for row_idx, row_data in enumerate(filtered_data):

            # Common fields (adjusted indices for the combined structure)
            self.history_table.setItem(row_idx, 0, QTableWidgetItem(str(row_data[0]))) # ID
            self.history_table.setItem(row_idx, 1, QTableWidgetItem(row_data[1]))      # Número de Orden

            # Fecha (date_created/received)
            date_dt = parse_date_format(row_data[2])
            display_date = QDate(date_dt.year, date_dt.month, date_dt.day).toString("dd/MM/yyyy") if date_dt else row_data[2]
            self.history_table.setItem(row_idx, 2, QTableWidgetItem(display_date))

            self.history_table.setItem(row_idx, 3, QTableWidgetItem(row_data[3]))      # Proveedor/Destino
            self.history_table.setItem(row_idx, 4, QTableWidgetItem(f"{row_data[4]:.2f}")) # Monto Total
            self.history_table.setItem(row_idx, 5, QTableWidgetItem(row_data[5]))      # Tipo (Received/Generada)

            # Specific fields (adjusted indices)
            # For received orders, row_data[6] is ruta_archivo_original
            # For generated orders, row_data[6] is ruta_archivo_generado
            ruta_archivo = row_data[6] if len(row_data) > 6 else ""
            self.history_table.setItem(row_idx, 6, QTableWidgetItem(ruta_archivo))     # Ruta del Archivo

            # These fields are only relevant for 'Generada' orders
            # They will be empty strings for 'Received' orders in all_history_data
            fecha_entrega = row_data[9] if len(row_data) > 9 else "" # Adjusted index for combined list
            if fecha_entrega:
                date_dt_delivery = parse_date_format(fecha_entrega)
                display_date_delivery = QDate(date_dt_delivery.year, date_dt_delivery.month, date_dt_delivery.day).toString("dd/MM/yyyy") if date_dt_delivery else fecha_entrega
                self.history_table.setItem(row_idx, 7, QTableWidgetItem(display_date_delivery)) # Delivery Fecha
            else:
                self.history_table.setItem(row_idx, 7, QTableWidgetItem("N/A"))

            estado_entrega = row_data[10] if len(row_data) > 10 else "N/A" # Adjusted index
            self.history_table.setItem(row_idx, 8, QTableWidgetItem(estado_entrega)) # Delivery Estado

            formato_pdf = row_data[11] if len(row_data) > 11 else "N/A" # Adjusted index
            self.history_table.setItem(row_idx, 9, QTableWidgetItem(formato_pdf)) # PDF Format


    def filter_historial(self, text: str) -> None:
        """Filters order history based on search text."""
        search_text = text.lower()
        filtered_orders = []
        for order in self.all_history_data:
            order_number = str(order[1]).lower()
            supplier = str(order[3]).lower()
            if search_text in order_number or search_text in supplier:
                filtered_orders.append(order)
        self.display_filtered_history(filtered_orders)

    def export_history_to_csv(self) -> None:
        """Exports the current order history to a CSV file."""
        options = QFileDialog.Options()
        file_path, _ = QFileDialog.getGuardarFileName(self, "Export History to CSV", "order_history.csv",
                                                   "CSV Files (*.csv);;All Files (*)", options=options)
        if file_path:
            try:
                with open(file_path, 'w', newline='', encoding='utf-8') as csvfile:
                    csv_writer = csv.writer(csvfile)

                    headers = [self.history_table.horizontalHeaderItem(col).text() for col in range(self.history_table.columnCount())]
                    csv_writer.writerow(headers)

                    for row in range(self.history_table.rowCount()):
                        row_data = []
                        for col in range(self.history_table.columnCount()):
                            item = self.history_table.item(row, col)
                            row_data.append(item.text() if item else "")
                        csv_writer.writerow(row_data)

                QMessageBox.information(self, "Success", f"History successfully exported to:\n{file_path}")
                logging.info(f"History exported to CSV: {file_path}")
            except Exception as e:
                QMessageBox.critical(self, "Export Error", f"An error occurred while exporting history: {e}")
                logging.error(f"Error exporting history to CSV: {e}", exc_info=True)

    def edit_selected_order(self) -> None:
        """Opens a dialog to edit all aspects of the selected order."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select an order to edit.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_type = self.history_table.item(row, 5).text()

        # Open the new comprehensive edit dialog
        dialog = EditOrderDetailsDialog(order_id, order_type, self, self.main_window.username_logged_in) # Pass the admin username
        dialog.exec_()
        # The dialog will call self.cargar_historial() on success

    def delete_selected_order(self) -> None:
        """Deletes the selected order from the database."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select an order to delete.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_number = self.history_table.item(row, 1).text()
        order_type = self.history_table.item(row, 5).text()

        confirm = QMessageBox.question(self, "Confirm Deletion",
                                       f"Are you sure you want to delete order {order_number} ({order_type})?",
                                       QMessageBox.Yes | QMessageBox.No)
        if confirm == QMessageBox.Yes:
            if not self.current_username:
                QMessageBox.critical(self, "Session Error", "Could not get current user. Please restart the application.")
                logging.error("Could not get logged in admin username to delete an order.")
                return

            auth_dialog = ContraseñaAuthDialog(self.current_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = eliminar_orden_por_id(order_id, order_type)
                if success:
                    QMessageBox.information(self, "Success", message)
                    self.cargar_historial()
                else:
                    QMessageBox.warning(self, "Delete Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to delete orders.")


    def view_selected_order_pdf(self) -> None:
        """Opens the PDF file associated with the selected order."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select an order to view its PDF.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_type = self.history_table.item(row, 5).text()

        pdf_path = ""
        if order_type == "Recibida":
            order_data = obtener_detalles_orden_recibida(order_id)
            if order_data:
                pdf_path = order_data.get("ruta_archivo_original", "")
        elif order_type == "Generada":
            order_data = obtener_detalles_orden_generada(order_id)
            if order_data:
                pdf_path = order_data.get("ruta_archivo_generado", "")

        if pdf_path and os.path.exists(pdf_path):
            QDesktopServices.openUrl(QUrl.fromLocalFile(pdf_path))
            logging.info(f"Opening PDF: {pdf_path}")
        else:
            QMessageBox.warning(self, "PDF Not Found", "The PDF file path is invalid or the file does not exist.")
            if pdf_path:
                logging.warning(f"Invalid/non-existent PDF path: {pdf_path}")
            else:
                logging.warning(f"No PDF path found for order ID: {order_id}, Tipo: {order_type}")


    def change_delivery_status_for_generated_order(self) -> None:
        """Changes the delivery status of a selected generated order."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select a generated order to change its delivery status.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_type = self.history_table.item(row, 5).text()

        if order_type != "Generada":
            QMessageBox.warning(self, "Incorrect Tipo de Orden", "Only generated orders can have their delivery status changed.")
            return

        current_status = self.history_table.item(row, 8).text()

        status_dialog = QDialog(self)
        status_dialog.setWindowTitle("Cambiar Estado de Entrega")
        status_dialog_layout = QFormLayout()

        status_combobox = QComboBox(status_dialog)
        status_combobox.addItems(["Pendiente", "In Transit", "Delivered", "Delivery Problem"])
        status_combobox.setCurrentText(current_status)

        status_dialog_layout.addRow("New Estado:", status_combobox)

        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(status_dialog.accept)
        button_box.rejected.connect(status_dialog.reject)
        status_dialog_layout.addRow(button_box)

        status_dialog.setLayout(status_dialog_layout)

        if status_dialog.exec_() == QDialog.Accepted:
            new_status = status_combobox.currentText()
            if not self.current_username:
                QMessageBox.critical(self, "Session Error", "Could not get current user. Please restart the application.")
                logging.error("Could not get logged in admin username to change delivery status.")
                return

            auth_dialog = ContraseñaAuthDialog(self.current_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = actualizar_estado_entrega_orden(order_id, new_status)
                if success:
                    QMessageBox.information(self, "Success", f"Delivery status of order {order_id} updated to '{new_status}'.")
                    self.cargar_historial()
                else:
                    QMessageBox.warning(self, "Update Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to change delivery status.")


class AddEditProductDialog(QDialog):
    """
    Dialog to add a new product or edit an existing one in the catalog.
    """
    def __init__(self, admin_username: str, product_id: int = None, parent: QWidget = None):
        super().__init__(parent)
        self.product_id = product_id
        self.admin_username = admin_username
        self.setWindowTitle("Add/Edit Product")
        self.setFixedSize(400, 250)
        self.init_ui()
        self.apply_styles()
        if self.product_id:
            self.load_product_data()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #28a745; /* Green for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #218838;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QFormLayout()

        self.edp_input = QLineEdit()
        self.edp_input.setPlaceholderText("Enter EDP (e.g., 12345ABC)")
        layout.addRow("EDP:", self.edp_input)

        self.numero_cliente_input = QLineEdit()
        self.numero_cliente_input.setPlaceholderText("Enter Número de Cliente (Optional)")
        layout.addRow("Número de Cliente:", self.numero_cliente_input)

        self.descripcion_input = QLineEdit()
        self.descripcion_input.setPlaceholderText("Enter Descripción")
        layout.addRow("Descripción:", self.descripcion_input)

        self.costo_input = QLineEdit()
        self.costo_input.setValidator(QDoubleValidator(0.0, 99999999.0, 2))
        self.costo_input.setPlaceholderText("Enter Costo (e.g., 12.34)")
        layout.addRow("Costo:", self.costo_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.save_product)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addRow(button_box)

        self.setLayout(layout)

    def load_product_data(self):
        product_data = obtener_producto_por_id(self.product_id)
        if product_data:
            self.edp_input.setText(product_data.get("edp", ""))
            self.numero_cliente_input.setText(product_data.get("numero_cliente", ""))
            self.descripcion_input.setText(product_data.get("descripcion", ""))
            self.costo_input.setText(f"{product_data.get('costo', 0.0):.2f}")
        else:
            QMessageBox.critical(self, "Error", "Could not load product data for editing.")
            self.reject()

    def save_product(self):
        edp = self.edp_input.text().strip()
        numero_cliente = self.numero_cliente_input.text().strip()
        descripcion = self.descripcion_input.text().strip()
        costo_text = self.costo_input.text().strip()

        if not edp or not descripcion or not costo_text:
            QMessageBox.warning(self, "Incomplete Fields", "Please fill in EDP, Descripción, and Costo.")
            return

        try:
            costo = float(costo_text)
        except ValueError:
            QMessageBox.warning(self, "Invalid Costo", "Costo must be a valid number.")
            return

        # Authorization check
        auth_dialog = ContraseñaAuthDialog(self.admin_username, self)
        if auth_dialog.exec_() != QDialog.Accepted:
            QMessageBox.warning(self, "Authorization Failed", "Not authorized to save product.")
            return

        if self.product_id: # Edit existing product
            success, message = actualizar_producto_del_catalogo(self.product_id, edp, numero_cliente, descripcion, costo)
            action_type = "updated"
        else: # Add new product
            success, message = agregar_producto_al_catalogo(edp, numero_cliente, descripcion, costo)
            action_type = "added"

        if success:
            QMessageBox.information(self, "Success", f"Product successfully {action_type}.")
            self.accept()
        else:
            QMessageBox.critical(self, "Error", f"Failed to {action_type} product: {message}")


class GestionarProductosPage(QWidget):
    """
    Page for administrators to manage the product catalog.
    Allows adding, editing, and deleting products.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.current_admin_username = main_window.username_logged_in
        self.init_ui()
        self.apply_styles()
        self.load_products()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Add */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#editProductButton {
                background-color: #ffc107; /* Yellow for Edit */
                color: #333333;
            }
            QPushButton#editProductButton:hover {
                background-color: #e0a800;
            }
            QPushButton#deleteProductButton {
                background-color: #dc3545; /* Red for Delete */
            }
            QPushButton#deleteProductButton:hover {
                background-color: #c82333;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Product List Group
        product_list_group = QGroupBox("Catálogo de Productos")
        product_list_layout = QVBoxLayout()

        self.product_table = QTableWidget()
        self.product_table.setColumnCount(5)
        self.product_table.setHorizontalHeaderLabels(["ID", "EDP", "Número de Cliente", "Descripción", "Costo"])
        self.product_table.horizontalHeader().setStretchLastSection(True)
        self.product_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.product_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.product_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        product_list_layout.addWidget(self.product_table)

        product_actions_layout = QHBoxLayout()
        add_product_button = QPushButton("Agregar Producto")
        add_product_button.clicked.connect(self.add_product)
        product_actions_layout.addWidget(add_product_button)

        self.edit_product_button = QPushButton("Editar Producto Seleccionado")
        self.edit_product_button.setObjectName("editProductButton")
        self.edit_product_button.clicked.connect(self.edit_product)
        product_actions_layout.addWidget(self.edit_product_button)

        self.delete_product_button = QPushButton("Eliminar Producto Seleccionado")
        self.delete_product_button.setObjectName("deleteProductButton")
        self.delete_product_button.clicked.connect(self.delete_product)
        product_actions_layout.addWidget(self.delete_product_button)

        product_list_layout.addLayout(product_actions_layout)
        product_list_group.setLayout(product_list_layout)
        main_layout.addWidget(product_list_group)

        self.setLayout(main_layout)

    def load_products(self) -> None:
        """Loads all products from the catalog into the table."""
        products = obtener_todos_los_productos()
        self.product_table.setRowCount(len(products))
        for row, product in enumerate(products):
            self.product_table.setItem(row, 0, QTableWidgetItem(str(product['id'])))
            self.product_table.setItem(row, 1, QTableWidgetItem(product['edp']))
            self.product_table.setItem(row, 2, QTableWidgetItem(product.get('numero_cliente', '')))
            self.product_table.setItem(row, 3, QTableWidgetItem(product['descripcion']))
            self.product_table.setItem(row, 4, QTableWidgetItem(f"{product['costo']:.2f}"))
        self.product_table.resizeColumnsToContents()

    def add_product(self) -> None:
        """Opens dialog to add a new product."""
        dialog = AddEditProductDialog(self.current_admin_username, parent=self)
        if dialog.exec_() == QDialog.Accepted:
            self.load_products()

    def edit_product(self) -> None:
        """Opens dialog to edit the selected product."""
        selected_rows = self.product_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select Product", "Please select a product to edit.")
            return

        row = selected_rows[0].row()
        product_id = int(self.product_table.item(row, 0).text())

        dialog = AddEditProductDialog(self.current_admin_username, product_id, parent=self)
        if dialog.exec_() == QDialog.Accepted:
            self.load_products()

    def delete_product(self) -> None:
        """Deletes the selected product from the catalog."""
        selected_rows = self.product_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select Product", "Please select a product to delete.")
            return

        row = selected_rows[0].row()
        product_id = int(self.product_table.item(row, 0).text())
        edp_to_delete = self.product_table.item(row, 1).text()

        confirm = QMessageBox.question(self, "Confirm Deletion",
                                       f"Are you sure you want to delete product with EDP '{edp_to_delete}'?",
                                       QMessageBox.Yes | QMessageBox.No)
        if confirm == QMessageBox.Yes:
            auth_dialog = ContraseñaAuthDialog(self.current_admin_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = eliminar_producto_del_catalogo(product_id)
                if success:
                    QMessageBox.information(self, "Success", f"Product '{edp_to_delete}' deleted successfully.")
                    self.load_products()
                else:
                    QMessageBox.warning(self, "Delete Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to delete products.")


class AdminUsersPage(QWidget):
    """
    Page for administrators to manage application users:
    create, update (reset password, change role), and delete users.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.current_admin_username = main_window.username_logged_in # Admin currently logged in
        self.init_ui()
        self.apply_styles()
        self.load_users()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Add/Guardar */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#resetPassButton {
                background-color: #ffc107; /* Yellow for Reset */
                color: #333333;
            }
            QPushButton#resetPassButton:hover {
                background-color: #e0a800;
            }
            QPushButton#deleteUserButton {
                background-color: #dc3545; /* Red for Delete */
            }
            QPushButton#deleteUserButton:hover {
                background-color: #c82333;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Group for New User Form
        new_user_group = QGroupBox("Crear Nuevo Usuario")
        new_user_layout = QFormLayout()

        self.new_username_input = QLineEdit()
        self.new_username_input.setPlaceholderText("Nombre de usuario")
        new_user_layout.addRow("Usuario:", self.new_username_input)

        self.new_password_input = QLineEdit()
        self.new_password_input.setEchoMode(QLineEdit.Password)
        self.new_password_input.setPlaceholderText("Contraseña")
        new_user_layout.addRow("Contraseña:", self.new_password_input)

        self.new_role_combobox = QComboBox()
        self.new_role_combobox.addItems(["user", "admin"])
        new_user_layout.addRow("Rol:", self.new_role_combobox)

        self.create_user_button = QPushButton("Create User")
        self.create_user_button.clicked.connect(self.create_new_user)
        new_user_layout.addRow(self.create_user_button)

        new_user_group.setLayout(new_user_layout)
        main_layout.addWidget(new_user_group)
        main_layout.addSpacing(10)

        # Group for User List and Actions
        user_list_group = QGroupBox("User List")
        user_list_layout = QVBoxLayout()

        self.user_table = QTableWidget()
        self.user_table.setColumnCount(3)
        self.user_table.setHorizontalHeaderLabels(["ID", "User", "Role"])
        self.user_table.horizontalHeader().setStretchLastSection(True)
        self.user_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.user_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.user_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        user_list_layout.addWidget(self.user_table)

        user_actions_layout = QHBoxLayout()
        self.reset_password_button = QPushButton("Reset Contraseña")
        self.reset_password_button.setObjectName("resetPassButton")
        self.reset_password_button.clicked.connect(self.open_reset_password_dialog)
        user_actions_layout.addWidget(self.reset_password_button)

        self.delete_user_button = QPushButton("Eliminar Usuario")
        self.delete_user_button.setObjectName("deleteUserButton")
        self.delete_user_button.clicked.connect(self.delete_selected_user)
        user_actions_layout.addWidget(self.delete_user_button)

        user_list_layout.addLayout(user_actions_layout)
        user_list_group.setLayout(user_list_layout)
        main_layout.addWidget(user_list_group)

        self.setLayout(main_layout)

    def load_users(self) -> None:
        """Loads all users from the database into the table."""
        users = obtener_todos_los_usuarios()
        self.user_table.setRowCount(len(users))
        for row, user in enumerate(users):
            self.user_table.setItem(row, 0, QTableWidgetItem(str(user['id'])))
            self.user_table.setItem(row, 1, QTableWidgetItem(user['username']))
            self.user_table.setItem(row, 2, QTableWidgetItem(user['rol']))
        self.user_table.resizeColumnsToContents()

    def create_new_user(self) -> None:
        """Creates a new user with the form data."""
        username = self.new_username_input.text().strip()
        password = self.new_password_input.text().strip()
        rol = self.new_role_combobox.currentText()

        if not username or not password:
            QMessageBox.warning(self, "Empty Fields", "Please enter username and password.")
            return

        success, message = crear_usuario(username, password, rol)
        if success:
            QMessageBox.information(self, "Success", "User created successfully.")
            self.new_username_input.clear()
            self.new_password_input.clear()
            self.load_users() # Reload user table
        else:
            QMessageBox.warning(self, "Create User Error", message)

    def open_reset_password_dialog(self) -> None:
        """Opens the dialog to reset the selected user's password."""
        selected_rows = self.user_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select User", "Please select a user to reset their password.")
            return

        row = selected_rows[0].row()
        user_id = int(self.user_table.item(row, 0).text())
        username_to_reset = self.user_table.item(row, 1).text()

        if username_to_reset == self.current_admin_username:
            QMessageBox.warning(self, "Action Not Allowed", "You cannot reset your own password from here. Use 'Cambiar mi Contraseña'.")
            return

        dialog = ResetContraseñaDialog(user_id, username_to_reset, self.current_admin_username, self)
        if dialog.exec_() == QDialog.Accepted:
            self.load_users() # Reload user table if password was reset

    def delete_selected_user(self) -> None:
        """Deletes the selected user from the database."""
        selected_rows = self.user_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select User", "Please select a user to delete.")
            return

        row = selected_rows[0].row()
        user_id = int(self.user_table.item(row, 0).text())
        username_to_delete = self.user_table.item(row, 1).text()

        if username_to_delete == self.current_admin_username:
            QMessageBox.warning(self, "Action Not Allowed", "You cannot delete your own admin account.")
            return

        confirm = QMessageBox.question(self, "Confirm Deletion",
                                       f"Are you sure you want to delete user '{username_to_delete}'?",
                                       QMessageBox.Yes | QMessageBox.No)
        if confirm == QMessageBox.Yes:
            auth_dialog = ContraseñaAuthDialog(self.current_admin_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = eliminar_usuario(user_id)
                if success:
                    QMessageBox.information(self, "Success", f"User '{username_to_delete}' deleted successfully.")
                    self.load_users()
                else:
                    QMessageBox.warning(self, "Eliminar Usuario Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to delete users.")


class MainWindow(QMainWindow):
    """
    Main application window that manages different pages
    and application flow.
    """
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Purchase Order Management System")
        self.setGeometry(100, 100, 1200, 800) # Adjusted initial size
        self.user_role: str | None = None
        self.username_logged_in: str | None = None
        self.init_db_and_admin()
        self.show_login_dialog()

    def init_db_and_admin(self) -> None:
        """Initializes the database and creates the default admin user if it does not exist."""
        inicializar_bd()
        success, message = crear_usuario(ConfiguracionAplicacion.USUARIO_ADMIN_POR_DEFECTO, ConfiguracionAplicacion.CONTRASENA_ADMIN_POR_DEFECTO, 'admin')
        if not success and "already exists" not in message: # Adjusted message for string comparison
            logging.error(f"Failed to secure default admin user: {message}")

    def show_login_dialog(self) -> None:
        """Shows the login dialog."""
        login_dialog = DialogoInicioSesion()
        if login_dialog.exec_() == QDialog.Accepted:
            self.user_role = login_dialog.rol_usuario
            self.username_logged_in = login_dialog.username_logged_in
            self.init_main_ui()
            self.showMaximized() # Maximize main window on login
        else:
            QMessageBox.critical(self, "Iniciar Sesión Error", "You must log in to use the application.")
            sys.exit()

    def init_main_ui(self) -> None:
        """Initializes the main user interface after successful login."""
        self.central_widget = QWidget()
        self.setCentralWidget(self.central_widget)
        self.main_layout = QHBoxLayout(self.central_widget)

        self.sidebar_layout = QVBoxLayout()
        self.stacked_widget = QStackedWidget()

        # Navigation buttons
        self.read_oc_button = QPushButton("Leer Órdenes Recibidas")
        self.read_oc_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(0))
        self.sidebar_layout.addWidget(self.read_oc_button)

        self.generate_oc_button = QPushButton("Generar Orden")
        self.generate_oc_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(1))
        self.sidebar_layout.addWidget(self.generate_oc_button)

        self.history_button = QPushButton("Ver Historial de Órdenes")
        self.history_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(2))
        self.sidebar_layout.addWidget(self.history_button)

        # NEW: Gestionar Productos Button
        self.manage_products_button = QPushButton("Gestionar Productos")
        self.manage_products_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(3))
        self.sidebar_layout.addWidget(self.manage_products_button)

        self.admin_users_button = QPushButton("Gestionar Usuarios")
        self.admin_users_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(4))
        self.sidebar_layout.addWidget(self.admin_users_button)

        self.change_password_button = QPushButton("Cambiar mi Contraseña")
        self.change_password_button.clicked.connect(self.open_change_password_dialog)
        self.sidebar_layout.addWidget(self.change_password_button)

        self.logout_button = QPushButton("Cerrar Sesión")
        self.logout_button.clicked.connect(self.logout)
        self.sidebar_layout.addWidget(self.logout_button)

        # Adjustment so navigation buttons take necessary space and don't stretch
        self.sidebar_layout.addStretch()

        # Pages
        self.read_oc_page = LeerOCRecibidasPage(self)
        self.generate_oc_page = GenerarOCPage(self)
        self.history_page = VerHistorialOrdenesPage(self)
        self.manage_products_page = GestionarProductosPage(self) # New instance
        self.admin_users_page = AdminUsersPage(self)

        self.stacked_widget.addWidget(self.read_oc_page)
        self.stacked_widget.addWidget(self.generate_oc_page)
        self.stacked_widget.addWidget(self.history_page)
        self.stacked_widget.addWidget(self.manage_products_page) # Add new page
        self.stacked_widget.addWidget(self.admin_users_page)

        self.main_layout.addLayout(self.sidebar_layout, 1) # Sidebar takes 1/5 of width
        self.main_layout.addWidget(self.stacked_widget, 4) # Stacked widget takes 4/5 of width

        self.apply_main_window_styles()
        self.update_ui_for_role() # Apply initial role-based visibility

    def apply_main_window_styles(self) -> None:
        """Applies CSS styles to the main window and its elements."""
        self.setStyleSheet("""
            QMainWindow {
                background-color: #222222;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QPushButton {
                background-color: #555555;
                color: #F0F0F0;
                border: 1px solid #666666;
                border-radius: 5px;
                padding: 10px;
                margin: 5px;
                font-size: 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #666666;
            }
            QStackedWidget {
                background-color: #2e2e2e;
                border: 1px solid #444444;
                border-radius: 8px;
                padding: 10px;
            }
        """)

    def update_ui_for_role(self) -> None:
        """Updates the visibility of navigation buttons based on user role."""
        if self.user_role == 'admin':
            self.admin_users_button.setVisible(True)
            self.manage_products_button.setVisible(True) # Admins can manage products
        else:
            self.admin_users_button.setVisible(False)
            self.manage_products_button.setVisible(False) # Regular users cannot manage products
            # If a non-admin user somehow ended up on an admin page, redirect them
            if self.stacked_widget.currentWidget() in [self.admin_users_page, self.manage_products_page]:
                self.stacked_widget.setCurrentIndex(0) # Redirect to the first page (Leer Órdenes Recibidas)

    def open_change_password_dialog(self) -> None:
        """Opens the dialog for the user to change their own password."""
        if not self.username_logged_in:
            QMessageBox.critical(self, "Error", "No active user session to change password.")
            logging.error("Attempt to change password without logged in user.")
            return

        user_data = obtener_usuario_por_nombre(self.username_logged_in)
        if user_data:
            user_id = user_data["id"]
            dialog = ChangeContraseñaDialog(user_id, self.username_logged_in, self)
            dialog.exec_()
        else:
            QMessageBox.critical(self, "Error", "Could not get your user data.")
            logging.error(f"No user data found for '{self.username_logged_in}' when trying to change password.")


    def logout(self) -> None:
        """Logs out the user and returns to the login dialog."""
        QMessageBox.information(self, "Cerrar Sesión", "Session closed successfully.")
        self.user_role = None
        self.username_logged_in = None
        self.hide() # Hide main window
        self.show_login_dialog() # Show login dialog again


if __name__ == "__main__":
    app = QApplication(sys.argv)

    inicializar_bd()
    crear_usuario(ConfiguracionAplicacion.USUARIO_ADMIN_POR_DEFECTO, ConfiguracionAplicacion.CONTRASENA_ADMIN_POR_DEFECTO, 'admin')

    main_window = MainWindow()

    sys.exit(app.exec_())

# This cell will contain the contents of config.py
# --- Configuración general de la aplicación ---
class ConfiguracionAplicacion:
    NOMBRE_BD: str = 'compras.db'
    USUARIO_ADMIN_POR_DEFECTO: str = 'admin'
    CONTRASENA_ADMIN_POR_DEFECTO: str = 'admin123' # IMPORTANT: Change this in a production environment!
    TASA_IVA: float = 0.16 # Tasa de IVA (16%)
    LONGITUD_MINIMA_CONTRASENA: int = 6 # Longitud mínima de la contraseña

# Configuración del registro de eventos
import logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# This cell will contain the contents of database.py
import sqlite3
import bcrypt
import logging
from datetime import datetime

# Assuming ConfiguracionAplicacion is available from config.py (or imported if in a separate file)
# from config import ConfiguracionAplicacion

class GestorBaseDeDatos:
    """
    Clase para gestionar conexiones y operaciones de la base de datos SQLite.
    Centraliza el manejo de la base de datos y mejora la gestión de errores.
    """
    def __init__(self, db_name: str):
        self.db_name = db_name
        self._conn = None # To hold the connection

    def __enter__(self):
        """Establishes and returns a database connection using a context manager."""
        self._conn = sqlite3.connect(self.db_name)
        self._conn.execute("PRAGMA foreign_keys = ON;") # Enable foreign key support
        return self._conn.cursor()

    def __exit__(self, exc_type, exc_val, exc_tb):
        """Closes the database connection."""
        if self._conn:
            if exc_type:
                self._conn.rollback() # Rollback on error
                logging.error(f"Transaction rolled back due to exception: {exc_type} - {exc_val}")
            else:
                self._conn.commit() # Commit on success
            self._conn.close()
        return False # Propagate exception if any

    def ejecutar_consulta(self, query: str, params: tuple = ()) -> tuple[bool, str]:
        """Ejecuta una consulta SQL que modifica la base de datos (INSERT, UPDATE, DELETE)."""
        try:
            with self as cursor:
                cursor.execute(query, params)
            return True, "Operación exitosa."
        except sqlite3.IntegrityError as e:
            logging.error(f"Error de integridad de la base de datos: {e} - Consulta: {query} - Parámetros: {params}")
            return False, f"Error de integridad: {e}"
        except sqlite3.Error as e:
            logging.error(f"Error de base de datos: {e} - Consulta: {query} - Parámetros: {params}")
            return False, f"Error de base de datos: {e}"

    def obtener_uno(self, query: str, params: tuple = ()) -> tuple | None:
        """Ejecuta una consulta SQL y devuelve una sola fila."""
        try:
            with self as cursor:
                cursor.execute(query, params)
                return cursor.fetchone()
        except sqlite3.Error as e:
            logging.error(f"Error al obtener una fila de la base de datos: {e} - Consulta: {query} - Parámetros: {params}")
            return None

    def obtener_todos(self, query: str, params: tuple = ()) -> list[tuple]:
        """Ejecuta una consulta SQL y devuelve todas las filas."""
        try:
            with self as cursor:
                cursor.execute(query, params)
                return cursor.fetchall()
        except sqlite3.Error as e:
            logging.error(f"Error al obtener todas las filas de la base de datos: {e} - Consulta: {query} - Parámetros: {params}")
            return []

# Global instance of the database manager
db_manager = GestorBaseDeDatos(ConfiguracionAplicacion.NOMBRE_BD)


def add_column_if_not_exists(cursor: sqlite3.Cursor, table_name: str, column_name: str, column_type: str, default_value: str = None) -> None:
    """Adds a column to a table if it does not exist. (Used only in initialize_db)."""
    cursor.execute(f"PRAGMA table_info({table_name})")
    columns = [col[1] for col in cursor.fetchall()]
    if column_name not in columns:
        try:
            # Use parameterized queries even for ALTER TABLE if default_value is a string
            if default_value is not None:
                cursor.execute(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type} DEFAULT ?", (default_value,))
                logging.info(f"Columna '{column_name}' añadida a '{table_name}' con valor por defecto.")
            else:
                cursor.execute(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type}")
                logging.info(f"Columna '{column_name}' añadida a '{table_name}'.")
        except sqlite3.Error as e:
            logging.error(f"Error al añadir columna {column_name} a {table_name}: {e}")


def inicializar_bd() -> None:
    """
    Inicializa la base de datos 'compras.db' y crea las tablas necesarias
    si no existen: 'usuarios', 'ordenes_compra_recibidas', 'ordenes_compra_generadas',
    y 'productos_catalogo'.
    """
    try:
        with db_manager as cursor: # Use context manager
            # Table for users
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS usuarios (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT UNIQUE NOT NULL,
                    password_hash TEXT NOT NULL,
                    rol TEXT NOT NULL
                )
            ''')

            # Table for received purchase orders (from supplier)
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS ordenes_compra_recibidas (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    numero_orden TEXT UNIQUE NOT NULL,
                    fecha_recibida TEXT NOT NULL,
                    proveedor_origen TEXT NOT NULL,
                    monto_total REAL,
                    estado TEXT NOT NULL,
                    ruta_archivo_original TEXT,
                    ruta_foto TEXT,  -- New column for photo path
                    datos_productos_json TEXT
                )
            ''')

            # Table for generated purchase orders (to our supplier)
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS ordenes_compra_generadas (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    numero_orden_generada TEXT UNIQUE NOT NULL,
                    fecha_generada TEXT NOT NULL,
                    proveedor_destino TEXT NOT NULL,
                    monto_total REAL,
                    estado TEXT NOT NULL,
                    ruta_archivo_generado TEXT,
                    ruta_foto TEXT, -- New column for photo path
                    orden_recibida_id INTEGER,
                    datos_productos_json TEXT,
                    fecha_entrega TEXT,
                    estado_entrega TEXT DEFAULT 'Pendiente',
                    formato_pdf TEXT DEFAULT 'Demoga', -- New column for PDF format
                    FOREIGN KEY (orden_recibida_id) REFERENCES ordenes_compra_recibidas(id)
                )
            ''')

            # NEW TABLE: productos_catalogo
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS productos_catalogo (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    edp TEXT UNIQUE NOT NULL,
                    numero_cliente TEXT UNIQUE,
                    descripcion TEXT NOT NULL,
                    costo REAL NOT NULL
                )
            ''')

            # Ensure new columns exist to avoid errors if DB already existed
            add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'fecha_entrega', 'TEXT')
            add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'estado_entrega', 'TEXT', 'Pendiente')
            add_column_if_not_exists(cursor, 'ordenes_compra_recibidas', 'ruta_foto', 'TEXT') # Add foto column for received
            add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'ruta_foto', 'TEXT') # Add foto column for generated
            add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'formato_pdf', 'TEXT', 'Demoga') # Add PDF format column

            # Add indexes for the new products table
            cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_productos_catalogo_edp ON productos_catalogo (edp)')
            cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_productos_catalogo_numero_cliente ON productos_catalogo (numero_cliente)')

        logging.info("Base de datos inicializada (o ya existía) y columnas verificadas/añadidas.")
    except sqlite3.Error as e:
        logging.error(f"Error durante la inicialización de la base de datos: {e}")


# --- Funciones CRUD para el catálogo de productos ---
def agregar_producto_al_catalogo(edp: str, numero_cliente: str, descripcion: str, costo: float) -> tuple[bool, str]:
    """Adds a new product to the catalog."""
    success, message = db_manager.ejecutar_consulta(
        "INSERT INTO productos_catalogo (edp, numero_cliente, descripcion, costo) VALUES (?, ?, ?, ?)",
        (edp, numero_cliente, descripcion, costo)
    )
    if success:
        logging.info(f"Producto '{edp}' añadido al catálogo.")
    else:
        logging.error(f"Error al añadir producto '{edp}' al catálogo: {message}")
    return success, message

def obtener_todos_los_productos() -> list[dict]:
    """Retrieves all products from the catalog."""
    results = db_manager.obtener_todos("SELECT id, edp, numero_cliente, descripcion, costo FROM productos_catalogo")
    return [{"id": r[0], "edp": r[1], "numero_cliente": r[2], "descripcion": r[3], "costo": r[4]} for r in results]

def obtener_producto_por_id(product_id: int) -> dict | None:
    """Retrieves a product from the catalog by its ID."""
    result = db_manager.obtener_uno("SELECT id, edp, numero_cliente, descripcion, costo FROM productos_catalogo WHERE id = ?", (product_id,))
    if result:
        return {"id": result[0], "edp": result[1], "numero_cliente": result[2], "descripcion": result[3], "costo": result[4]}
    return None

def actualizar_producto_del_catalogo(product_id: int, edp: str, numero_cliente: str, descripcion: str, costo: float) -> tuple[bool, str]:
    """Updates an existing product in the catalog."""
    success, message = db_manager.ejecutar_consulta(
        "UPDATE productos_catalogo SET edp = ?, numero_cliente = ?, descripcion = ?, costo = ? WHERE id = ?",
        (edp, numero_cliente, descripcion, costo, product_id)
    )
    if success:
        logging.info(f"Producto con ID {product_id} actualizado en el catálogo.")
    else:
        logging.error(f"Error al actualizar producto con ID {product_id}: {message}")
    return success, message

def eliminar_producto_del_catalogo(product_id: int) -> tuple[bool, str]:
    """Deletes a product from the catalog by its ID."""
    success, message = db_manager.ejecutar_consulta("DELETE FROM productos_catalogo WHERE id = ?", (product_id,))
    if success:
        logging.info(f"Producto con ID {product_id} eliminado del catálogo.")
    else:
        logging.error(f"Error al eliminar producto con ID {product_id}: {message}")
    return success, message

def crear_usuario(username: str, password: str, rol: str) -> tuple[bool, str]:
    """
    Crea un nuevo usuario en la base de datos con una contraseña hasheada.
    Devuelve True y un mensaje de éxito, o False y un mensaje de error.
    """
    if len(password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
        return False, f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} caracteres."

    hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
    success, message = db_manager.ejecutar_consulta(
        "INSERT INTO usuarios (username, password_hash, rol) VALUES (?, ?, ?)",
        (username, hashed_password, rol)
    )
    if success:
        logging.info(f"Usuario '{username}' creado con rol '{rol}'.")
        # Self-check password (for debugging only)
        if not bcrypt.checkpw(password.encode('utf-8'), hashed_password.encode('utf-8')):
            logging.warning(f"La verificación de contraseña para '{username}' FALLÓ después de la creación.")
    else:
        logging.error(f"Error al crear usuario '{username}': {message}")
    return success, message

def obtener_usuario_por_id(user_id: int) -> dict | None:
    """Obtiene los detalles del usuario por ID."""
    result = db_manager.obtener_uno("SELECT id, username, rol FROM usuarios WHERE id = ?", (user_id,))
    if result:
        return {"id": result[0], "username": result[1], "rol": result[2]}
    return None

def obtener_usuario_por_nombre(username: str) -> dict | None:
    """Obtiene los detalles del usuario por nombre de usuario."""
    result = db_manager.obtener_uno("SELECT id, username, rol, password_hash FROM usuarios WHERE username = ?", (username,))
    if result:
        return {"id": result[0], "username": result[1], "rol": result[2], "password_hash": result[3]}
    return None

def obtener_todos_los_usuarios() -> list[dict]:
    """Obtiene todos los usuarios de la base de datos."""
    results = db_manager.obtener_todos("SELECT id, username, rol FROM usuarios")
    return [{"id": r[0], "username": r[1], "rol": r[2]} for r in results]

def actualizar_usuario(user_id: int, username: str, password: str = None, rol: str = None) -> tuple[bool, str]:
    """Actualiza los datos del usuario. Permite actualizar contraseña y/o rol."""
    updates = []
    params = []

    if username:
        updates.append("username = ?")
        params.append(username)
    if password:
        if len(password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            return False, f"La nueva contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} caracteres."
        hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
        updates.append("password_hash = ?")
        params.append(hashed_password)
    if rol:
        updates.append("rol = ?")
        params.append(rol)

    if not updates:
        return False, "No hay datos para actualizar."

    update_query = "UPDATE usuarios SET " + ", ".join(updates) + " WHERE id = ?"
    params.append(user_id)

    success, message = db_manager.ejecutar_consulta(update_query, tuple(params))
    if success:
        logging.info(f"Usuario con ID {user_id} actualizado exitosamente.")
    else:
        logging.error(f"Error al actualizar usuario con ID {user_id}: {message}")
    return success, message

def eliminar_usuario(user_id: int) -> tuple[bool, str]:
    """Elimina un usuario por ID."""
    success, message = db_manager.ejecutar_consulta("DELETE FROM usuarios WHERE id = ?", (user_id,))
    if success:
        logging.info(f"Usuario con ID {user_id} eliminado exitosamente.")
    else:
        logging.error(f"Error al eliminar usuario con ID {user_id}: {message}")
    return success, message

def verificar_credenciales(username: str, password: str) -> tuple[bool, str | None]:
    """
    Verifica las credenciales de un usuario.
    Devuelve True y el rol del usuario si las credenciales son correctas, False y None en caso contrario.
    """
    logging.info(f"Intentando verificar credenciales para el usuario: '{username}'")
    user_data = obtener_usuario_por_nombre(username)
    if user_data:
        password_hash_guardado = user_data["password_hash"]
        rol_del_usuario = user_data["rol"]
        logging.info(f"Usuario encontrado. Hash guardado (parcial): {password_hash_guardado[:10]}...")
        if bcrypt.checkpw(password.encode('utf-8'), password_hash_guardado.encode('utf-8')):
            logging.info("Contraseña verificada exitosamente.")
            return True, rol_del_usuario
        else:
            logging.warning("Contraseña incorrecta.")
    else:
        logging.warning(f"Usuario '{username}' no encontrado en la base de datos.")
    return False, None

def eliminar_orden_por_id(order_id: int, order_type: str) -> tuple[bool, str]:
    """Elimina una orden de compra por su ID y tipo."""
    table_name = ""
    if order_type == "Recibida":
        table_name = "ordenes_compra_recibidas"
    elif order_type == "Generada":
        table_name = "ordenes_compra_generadas"
    else:
        return False, "Tipo de orden desconocido."

    success, message = db_manager.ejecutar_consulta(f"DELETE FROM {table_name} WHERE id = ?", (order_id,))
    if success:
        logging.info(f"Orden '{order_type}' con ID {order_id} eliminada exitosamente.")
    else:
        logging.error(f"Error al eliminar orden '{order_type}' con ID {order_id}: {message}")
    return success, message

def actualizar_estado_entrega_orden(order_id: int, new_status: str) -> tuple[bool, str]:
    """Actualiza el estado de entrega de una orden generada."""
    success, message = db_manager.ejecutar_consulta("UPDATE ordenes_compra_generadas SET estado_entrega = ? WHERE id = ?", (new_status, order_id))
    if success:
        logging.info(f"Estado de entrega de la orden generada ID {order_id} actualizado a '{new_status}'.")
    else:
        logging.error(f"Error al actualizar el estado de entrega de la orden generada ID {order_id}: {message}")
    return success, message

def actualizar_orden_en_bd(order_id: int, order_type: str, updated_data: dict) -> tuple[bool, str]:
    """
    Actualiza una orden de compra (recibida o generada) con nuevos datos.
    `updated_data` es un diccionario con los campos a actualizar.
    """
    table_name = ""
    id_field = ""
    if order_type == "Recibida":
        table_name = "ordenes_compra_recibidas"
        id_field = "id"
    elif order_type == "Generada":
        table_name = "ordenes_compra_generadas"
        id_field = "id"
    else:
        return False, "Tipo de orden desconocido para actualizar."

    set_clauses = []
    params = []

    for key, value in updated_data.items():
        if key in ["id", "ruta_foto", "orden_recibida_id"]: # Campos no actualizables directamente desde el diálogo o manejados por separado
            continue
        set_clauses.append(f"{key} = ?")
        params.append(value)

    if not set_clauses:
        return False, "No hay datos para actualizar."

    query = f"UPDATE {table_name} SET {', '.join(set_clauses)} WHERE {id_field} = ?"
    params.append(order_id)

    success, message = db_manager.ejecutar_consulta(query, tuple(params))
    if success:
        logging.info(f"Orden {order_type} con ID {order_id} actualizada exitosamente.")
    else:
        logging.error(f"Error al actualizar orden {order_type} con ID {order_id}: {message}")
    return success, message


def obtener_detalles_orden_recibida(order_id: int) -> dict | None:
    """Obtiene todos los detalles de una orden de compra recibida por su ID."""
    result = db_manager.obtener_uno("SELECT id, numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json FROM ordenes_compra_recibidas WHERE id = ?", (order_id,))
    if result:
        return {
            "id": result[0],
            "numero_orden": result[1],
            "fecha_recibida": result[2],
            "proveedor_origen": result[3],
            "monto_total": result[4],
            "estado": result[5],
            "ruta_archivo_original": result[6],
            "ruta_foto": result[7],
            "datos_productos_json": result[8]
        }
    return None

def obtener_detalles_orden_generada(order_id: int) -> dict | None:
    """Obtiene todos los detalles de una orden de compra generada por su ID."""
    result = db_manager.obtener_uno("SELECT id, numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, estado_entrega, formato_pdf FROM ordenes_compra_generadas WHERE id = ?", (order_id,))
    if result:
        formato_pdf_from_db = result[12]
        # Ensure that formato_pdf is one of the expected values, default to 'Demoga' if not
        if formato_pdf_from_db not in ["Demoga", "Emaldo"]:
            formato_pdf_from_db = "Demoga"

        return {
            "id": result[0],
            "numero_orden_generada": result[1],
            "fecha_generada": result[2],
            "proveedor_destino": result[3],
            "monto_total": result[4],
            "estado": result[5],
            "ruta_archivo_generado": result[6],
            "ruta_foto": result[7],
            "orden_recibida_id": result[8],
            "datos_productos_json": result[9],
            "fecha_entrega": result[10],
            "estado_entrega": result[11],
            "formato_pdf": formato_pdf_from_db
        }
    return None

# This cell will contain the contents of pdf_parsing.py
import re
import json
from datetime import datetime, timedelta
import logging

# Assuming ConfiguracionAplicacion is available from config.py (or imported)
# from config import ConfiguracionAplicacion

# Month mapping for date parsing (used in parse_date_format and specific parsing functions)
MONTH_MAP = {
    'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
    'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
}

def parse_date_format(date_str: str) -> datetime | None:
    """Tries to parse a date in various formats and returns a datetime object or None."""
    # Convert month abbreviations to numbers before parsing for consistency
    temp_date_str = date_str.upper()
    for abbr, num in MONTH_MAP.items():
        temp_date_str = temp_date_str.replace(abbr, num)

    formats = [
        "%Y-%m-%d",
        "%d-%m-%Y",
        "%m-%d-%Y",
        "%d/%m/%Y",
        "%m/%d/%Y",
        "%Y/%m/%d",
        "%d %m %Y" # For "07 APR 2025" after conversion
    ]
    for fmt in formats:
        try:
            return datetime.strptime(temp_date_str, fmt)
        except ValueError:
            continue
    return None


def parse_mcx_po(content: str) -> dict:
    """
    Parses the MCX_PO_74907_344_0.PDF structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Número de Orden
    num_orden_match = re.search(r'No\.\s*([\w\d-]+)\s*Rev\.0', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha (e.g., "07 APR 2025")
    fecha_match = re.search(r'(\d{2})\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(\d{4})', content)
    if fecha_match:
        day = fecha_match.group(1)
        month_abbr = fecha_match.group(2).upper()
        year = fecha_match.group(3)
        month_num = MONTH_MAP.get(month_abbr, '')
        if all([day, month_num, year]):
            parsed_date = parse_date_format(f"{day} {month_num} {year}")
            if parsed_date:
                data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Supplier Name - Attempt to capture the first line after "PROVEEDOR (SUPPLIER)"
    proveedor_match = re.search(r'PROVEEDOR \(SUPPLIER\)\s*\n\s*([^\n]+)', content, re.IGNORECASE)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip().replace(',', '')

    # Monto Total
    monto_match = re.search(r'TOTAL\s*USD\s*([\d,\.]+)', content)
    if monto_match:
        try:
            data["monto_total"] = float(monto_match.group(1).replace(',', '').strip())
        except ValueError:
            logging.warning(f"Could not parse total amount for MCX_PO: {monto_match.group(1)}")


    # Detalles del Producto (CSV-like rows)
    productos = []
    product_lines_raw = re.findall(
        r'"(\d+)"\s*,\s*'          # LINE
        r'"([\d.]+)"\s*,\s*'        # QTY
        r'"(.*?)"\s*,\s*'           # U.M.
        r'"(.*?)"\s*,\s*'           # CODE
        r'"(.*?)"\s*,\s*'           # DESCRIPTION
        r'"(.*?)"\s*,\s*'           # DATE
        r'"(.*?)"\s*,\s*'           # REQ.
        r'([^,]*?),\s*'             # COT (Handles empty string between commas, non-greedy)
        r'"([\d.]+)"\s*,\s*'        # UNIT PRICE
        r'"([\d.,]+)"',             # TOTAL PRICE
        content
    )

    for line_data in product_lines_raw:
        try:
            line_num = line_data[0].strip()
            qty = float(line_data[1].strip())
            unit = line_data[2].strip()
            code = line_data[3].strip()
            description = line_data[4].strip()
            unit_price = float(line_data[8].replace(',', '').strip())
            total_price = float(line_data[9].replace(',', '').strip())

            productos.append({
                "linea": line_num,
                "cantidad": qty,
                "unidad": unit,
                "codigo": code,
                "descripcion": description,
                "precio_unitario": unit_price,
                "precio_total": total_price
            })
        except ValueError as e:
            logging.warning(f"Error parsing MCX_PO product line (ValueError): {line_data} - {e}")
            continue
        except IndexError as e:
            logging.warning(f"Error parsing MCX_PO product line (IndexError): {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data


def parse_pc002057_emaldo_po(content: str) -> dict:
    """
    Parses the PC002057 EMALDO.pdf structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Supplier
    proveedor_match = re.search(r'SUPPLIER:\s*(.+)', content)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip()

    # Número de Orden
    num_orden_match = re.search(r'NBR:\s*\"?([A-Z0-9]+)\"?', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha (e.g., 23/01/2025)
    fecha_match = re.search(r'DATE:\s*\"?(\d{2}/\d{2}/\d{4})\"?', content)
    if fecha_match:
        parsed_date = parse_date_format(fecha_match.group(1))
        if parsed_date:
            data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Monto Total
    monto_match = re.search(r'Total:\s*([\d,\.]+\s*USD)', content)
    if monto_match:
        try:
            total_str = monto_match.group(1).replace(',', '').replace(' USD', '').strip()
            data["monto_total"] = float(total_str)
        except ValueError:
            logging.warning(f"Could not parse total amount for EMALDO: {monto_match.group(1)}")


    # Detalles del Producto (CSV-like rows)
    productos = []
    # Regex for EMALDO: "PART","CODE","DESCRIPTION","",,"QTY","U.PRICE","VALUE"
    product_lines_raw = re.findall(r'"(\d+)"\s*,\s*"(.*?)"\s*,\s*"(.*?)"\s*,\s*"(.*?)"\s*,\s*"(\d+\.?\d*)"\s*,\s*"(\d+\.?\d*)"\s*,\s*"([\d,\.]+)"', content)

    for line_data in product_lines_raw:
        try:
            part_num = line_data[0]
            code = line_data[1]
            description = line_data[2]
            # line_data[3] is the empty '# PART' field
            qty = float(line_data[4])
            unit_price = float(line_data[5])
            value = float(line_data[6].replace(',', ''))

            productos.append({
                "part_num": part_num,
                "code": code,
                "description": description,
                "quantity": qty,
                "unit_price": unit_price,
                "value": value
            })
        except ValueError as e:
            logging.warning(f"Error parsing EMALDO product line (ValueError): {line_data} - {e}")
            continue
        except IndexError as e:
            logging.warning(f"Error parsing EMALDO product line (IndexError): {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data

def parse_m229420_po(content: str) -> dict:
    """
    Parses the M229420.PDF structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Número de Orden
    num_orden_match = re.search(r'PO NUMBER\\NUMERO PO\s*\"?([A-Z0-9]+)\"?', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha
    fecha_match = re.search(r'DATE FECHA\s*\"?(\d{2}/\d{2}/\d{2})\"?', content)
    if fecha_match:
        day, month, year_short = fecha_match.group(1).split('/')
        # Heuristic for 2-digit years (e.g., 24 -> 2024)
        current_year_last_two_digits = datetime.now().year % 100
        year_full = f"20{year_short}" if int(year_short) <= current_year_last_two_digits else f"19{year_short}"
        parsed_date = parse_date_format(f"{day}/{month}/{year_full}")
        if parsed_date:
            data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Supplier Name
    proveedor_match = re.search(r'R\.F\.C\.:HAS120702332\s*\n\s*([^,\n]+(?:,[^\n]+)*)', content, re.IGNORECASE)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip().replace(',', '')

    # Monto Total (appears on page 2)
    monto_match = re.search(r'Total This PO:\s*\(USD\s*\)\s*([\d,\.]+)', content)
    if monto_match:
        try:
            data["monto_total"] = float(monto_match.group(1).replace(',', '').strip())
        except ValueError:
            logging.warning(f"Could not parse total amount for M229420: {monto_match.group(1)}")


    # Detalles del Producto (Refined Regex)
    productos = []
    product_lines_raw = re.findall(
        r'"(\d+)"\s*,\s*'              # Group 1: Línea number
        r'"([\d\.]+\s*[^\"]+)"\s*,\s*' # Group 2: Cantidad and Unidad (e.g., "500.000 Piezas")
        r'"([\d\.]+\s*per\s*[^\"]+)\s*' # Group 3: Price per Unidad (e.g., "63.22000 per Piezas") - capture up to " per "
        r'(.*?)"\s*,\s*'               # Group 4: Remaining Descripción (after "per Unidad" part, before next quote)
        r'"([\d,\.]+)"',               # Group 5: Precio Total
        content
    )

    for line_data in product_lines_raw:
        try:
            line_num = line_data[0]
            qty_unit_str = line_data[1].strip()
            unit_price_per_str = line_data[2].strip()
            description_remainder = line_data[3].strip()
            total_price = float(line_data[4].replace(',', ''))

            qty_match = re.match(r'([\d\.]+)\s*(.+)', qty_unit_str)
            qty = float(qty_match.group(1)) if qty_match else 0.0
            unit = qty_match.group(2).strip() if qty_match else ""

            unit_price_match = re.match(r'([\d\.]+)', unit_price_per_str)
            unit_price = float(unit_price_match.group(1)) if unit_price_match else 0.0

            full_description = f"{unit_price_per_str} {description_remainder}".strip()

            delivery_date = "N/A" # Placeholder, actual regex needs to capture it if present

            productos.append({
                "linea": line_num,
                "cantidad": qty,
                "unidad": unit,
                "descripcion": full_description,
                "precio_unitario": unit_price,
                "fecha_entrega": delivery_date,
                "precio_total": total_price
            })
        except (ValueError, AttributeError, IndexError) as e:
            logging.warning(f"Error parsing M229420 product line: {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data

# This cell will contain the contents of pdf_generation.py
import json
import logging
import os
from datetime import datetime

from reportlab.lib import colors
from reportlab.lib.pagesizes import letter
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm
from PyQt5.QtCore import QDate, Qt

# Assuming ConfiguracionAplicacion is available from config.py (or imported)
# from config import ConfiguracionAplicacion

def create_styled_paragraph(text: str, style_id: str = 'Normal', font_size: int = 10, color = colors.black, bold: bool = False, alignment = Qt.AlignLeft) -> Paragraph:
    """Creates a Paragraph with custom styles."""
    styles = getSampleStyleSheet()
    if style_id not in styles:
        styles.add(ParagraphStyle(name=style_id, parent=styles['Normal']))

    current_style = styles[style_id]
    current_style.fontSize = font_size
    current_style.textColor = color
    if bold:
        current_style.fontName = 'Helvetica-Bold'
    else:
        current_style.fontName = 'Helvetica'

    if alignment == Qt.AlignCenter:
        current_style.alignment = 1 # TA_CENTER
    elif alignment == Qt.AlignRight:
        current_style.alignment = 2 # TA_RIGHT
    else:
        current_style.alignment = 0 # TA_LEFT

    return Paragraph(text, current_style)

def create_demoga_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF with Demoga format."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Company Header (Green Section)
    company_info = [
        ["DEMOGA S.A DE C.V.", ""],
        ["DeMoGa Tools. Libertad 22, La Magdalena Ocotitlan, Metepec Estado de Mexico. C.P. 52161 Tel: 722 931 38 79", ""]
    ]
    header_table = Table(company_info, colWidths=[14*cm, 5*cm])
    header_table.setStyle(TableStyle([
        ('BACKGROUND', (0,0), (-1,-1), colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green
        ('TEXTCOLOR', (0,0), (-1,-1), colors.white),
        ('ALIGN', (0,0), (0,0), 'LEFT'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (0,0), 'Helvetica-Bold'),
        ('FONTSIZE', (0,0), (0,0), 16),
        ('FONTNAME', (0,1), (0,1), 'Helvetica'),
        ('FONTSIZE', (0,1), (0,1), 9),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('BOTTOMPADDING', (0,0), (-1,-1), 10),
    ]))
    story.append(header_table)
    story.append(Spacer(1, 0.2*cm))

    # General Company Info (Below Green Header - hardcoded for now, but could be dynamic)
    story.append(create_styled_paragraph("<b>Compañía:</b> INGERSOLL CUTTING TOOLS SA DE CV", font_size=10))
    story.append(create_styled_paragraph("<b>Dirección:</b> Blvd. José Musa de León No. 2127, Col. Los Pinos, C.P. 25198", font_size=10))
    story.append(create_styled_paragraph("<b>Ciudad:</b> Saltillo, Coahuila", font_size=10))
    story.append(create_styled_paragraph("<b>Tel./e-mail:</b> (844) 485 32 21", font_size=10))
    story.append(create_styled_paragraph("<b>At'n:</b> Gerardo Berlanga", font_size=10))
    story.append(Spacer(1, 0.5*cm))

    # PURCHASE ORDER Title and Info
    # Ensure date is in QDate format for toString
    fecha_generada_qdate = QDate.fromString(order_data['fecha_generada'], Qt.ISODate)
    order_title_data = [
        [create_styled_paragraph("<b>ORDEN DE COMPRA</b>", font_size=14, alignment=Qt.AlignCenter),
         create_styled_paragraph(f"<b>No.</b><br/>{order_data['numero_orden_generada']}", font_size=10, alignment=Qt.AlignRight)],
        [create_styled_paragraph(f"<b>Fecha:</b> {fecha_generada_qdate.toString('dd/MM/yyyy')}", font_size=10), ""]
    ]
    order_title_table = Table(order_title_data, colWidths=[14*cm, 5*cm])
    order_title_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (0,0), 'CENTER'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (1,0), (1,0), 'Helvetica-Bold'),
        ('FONTSIZE', (0,0), (-1,0), 14),
        ('FONTSIZE', (1,0), (1,0), 10),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5),
    ]))
    story.append(order_title_table)
    story.append(Spacer(1, 0.5*cm))

    # Product Table
    products = json.loads(order_data["datos_productos_json"])
    table_data = [
        ["Ítem", "Parte (EDP)", "Número de Cliente", "Descripción", "Cantidad", "Fecha Envío", "Precio Unidadario (USD)", "Precio Total (USD)"]
    ]

    for i, p in enumerate(products):
        # Ensure date is in QDate format for toString
        fecha_entrega_qdate = QDate.fromString(order_data['fecha_entrega'], Qt.ISODate)
        table_data.append([
            str(i + 1),
            p.get("codigo", ""),
            p.get("numero_cliente", ""),
            p.get("descripcion", p.get("nombre", "")),
            f"{p.get('cantidad', 0):.2f}",
            fecha_entrega_qdate.toString('dd/MM/yyyy'),
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data, colWidths=[1*cm, 2.5*cm, 2.5*cm, 5*cm, 2*cm, 2.5*cm, 2.5*cm, 2.5*cm])
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green header
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 6),
        ('BACKGROUND', (0, 1), (-1, -1), colors.white),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green grid
        ('TEXTCOLOR', (0, 1), (-1, -1), colors.black),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
    ]))
    story.append(product_table)
    story.append(Spacer(1, 0.5*cm))

    # Totals Section
    subtotal = sum(p.get('precio_total', 0.0) for p in products)
    iva = subtotal * ConfiguracionAplicacion.TASA_IVA
    total = subtotal + iva

    totals_data = [
        ["Subtotal", f"{subtotal:.2f}"],
        [f"{ConfiguracionAplicacion.TASA_IVA * 100:.2f}% IVA", f"{iva:.2f}"],
        ["Total", f"{total:.2f}"]
    ]
    totals_table = Table(totals_data, colWidths=[15.5*cm, 3.5*cm])
    totals_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTNAME', (0,-1), (-1,-1), 'Helvetica-Bold'),
        ('LINEBELOW', (0,-2), (-1,-2), 1, colors.black),
        ('LINEBELOW', (0,-1), (-1,-1), 1, colors.black),
        ('FONTSIZE', (0,0), (-1,-1), 10),
    ]))
    story.append(totals_table)
    story.append(Spacer(1, 1*cm))

    # Footer (hardcoded for now, could be dynamic)
    story.append(create_styled_paragraph("Independencia 1319, Metepec, Mexico C.P. 52160", font_size=9, alignment=Qt.AlignCenter))

    try:
        doc.build(story)
        return True, "PDF Demoga generado exitosamente."
    except Exception as e:
        logging.error(f"Error al generar PDF Demoga: {e}", exc_info=True)
        return False, f"Error al generar PDF Demoga: {e}"


def create_emaldo_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF with Emaldo format."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Company Header (Emaldo Logo and Info)
    # Replaced Image URL with styled Paragraph for "EMALDO" text.
    emaldo_logo_text = create_styled_paragraph("<b>EMALDO</b>", font_size=20, bold=True, alignment=Qt.AlignLeft,
                                               color=colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)) # Lighter blue
    story.append(emaldo_logo_text)
    story.append(Spacer(1, 0.2*cm)) # Small spacer after the logo text

    header_data = [
        [create_styled_paragraph("<b>INGERSOLL CUTTING TOOLS SA DE CV</b>", font_size=10, bold=True), ""],
        [create_styled_paragraph("Blvd. José Musa de León No. 2127, Col. Los Pinos, C.P. 25198", font_size=9), ""],
        [create_styled_paragraph("Saltillo, Coahuila", font_size=9), ""],
        [create_styled_paragraph("(844) 485 32 21", font_size=9), ""],
        [create_styled_paragraph("Attn: Gerardo Berlanga", font_size=9), ""]
    ]
    header_table = Table(header_data, colWidths=[10*cm, 9*cm])
    header_table.setStyle(TableStyle([
        ('VALIGN', (0,0), (-1,-1), 'TOP'),
        ('TEXTCOLOR', (0,0), (-1,-1), colors.black),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (0,1), (0,1), 'Helvetica-Bold'),
        ('FONTNAME', (0,2), (0,5), 'Helvetica'),
        ('ALIGN', (0,0), (-1,-1), 'LEFT'),
    ]))
    story.append(header_table)
    story.append(Spacer(1, 0.5*cm))

    # PURCHASE ORDER Title and Info
    fecha_generada_qdate = QDate.fromString(order_data['fecha_generada'], Qt.ISODate)
    order_title_data = [
        [create_styled_paragraph("<b>ORDEN DE COMPRA</b>", font_size=14, bold=True, alignment=Qt.AlignCenter),
         create_styled_paragraph(f"No. POOGM-{order_data['numero_orden_generada']}", font_size=10, alignment=Qt.AlignRight)],
        [create_styled_paragraph(f"Fecha: {fecha_generada_qdate.toString('dd/MM/yyyy')}", font_size=10), ""]
    ]
    order_title_table = Table(order_title_data, colWidths=[14*cm, 5*cm])
    order_title_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (0,0), 'CENTER'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (1,0), (1,0), 'Helvetica'),
        ('FONTSIZE', (0,0), (-1,0), 14),
        ('FONTSIZE', (1,0), (1,0), 10),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5),
    ]))
    story.append(order_title_table)
    story.append(Spacer(1, 0.5*cm))

    # Product Table
    products = json.loads(order_data["datos_productos_json"])
    table_data = [
        ["Ítem", "Parte (EDP)", "Número de Cliente", "Descripción", "Cantidad", "Fecha Envío", "Precio Unidadario (USD)", "Precio Total (USD)"]
    ]

    for i, p in enumerate(products):
        fecha_entrega_qdate = QDate.fromString(order_data['fecha_entrega'], Qt.ISODate)
        table_data.append([
            str(i + 1),
            p.get("codigo", ""),
            p.get("numero_cliente", ""),
            p.get("descripcion", p.get("nombre", "")),
            f"{p.get('cantidad', 0):.2f}",
            fecha_entrega_qdate.toString('dd/MM/yyyy'),
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data, colWidths=[1*cm, 2.5*cm, 2.5*cm, 5*cm, 2*cm, 2.5*cm, 2.5*cm, 2.5*cm])
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)), # Lighter Blue header
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 6),
        ('BACKGROUND', (0, 1), (-1, -1), colors.white),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)), # Lighter Blue grid
        ('TEXTCOLOR', (0, 1), (-1, -1), colors.black),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
    ]))
    story.append(product_table)
    story.append(Spacer(1, 0.5*cm))

    # Totals Section
    subtotal = sum(p.get('precio_total', 0.0) for p in products)
    iva = subtotal * ConfiguracionAplicacion.TASA_IVA
    total = subtotal + iva

    totals_data = [
        ["Subtotal", f"{subtotal:.2f}"],
        [f"{ConfiguracionAplicacion.TASA_IVA * 100:.2f}% IVA", f"{iva:.2f}"],
        ["Total", f"{total:.2f}"]
    ]
    totals_table = Table(totals_data, colWidths=[15.5*cm, 3.5*cm])
    totals_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTNAME', (0,-1), (-1,-1), 'Helvetica-Bold'),
        ('LINEBELOW', (0,-2), (-1,-2), 1, colors.black),
        ('LINEBELOW', (0,-1), (-1,-1), 1, colors.black),
        ('FONTSIZE', (0,0), (-1,-1), 10),
    ]))
    story.append(totals_table)
    story.append(Spacer(1, 1*cm))

    # Footer (hardcoded for now, could be dynamic)
    story.append(create_styled_paragraph("Independencia 1319, Metepec, Mexico C.P. 52160", font_size=9, alignment=Qt.AlignCenter))

    try:
        doc.build(story)
        return True, "PDF Emaldo generado exitosamente."
    except Exception as e:
        logging.error(f"Error al generar PDF Emaldo: {e}", exc_info=True)
        return False, f"Error al generar PDF Emaldo: {e}"


def create_received_order_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF for a received purchase order (generic format)."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Title
    story.append(create_styled_paragraph("<b>Orden de Compra Recibida</b>", font_size=18, bold=True, alignment=Qt.AlignCenter))
    story.append(Spacer(1, 0.5*cm))

    # Order Details
    fecha_recibida_qdate = QDate.fromString(order_data['fecha_recibida'], Qt.ISODate)

    story.append(create_styled_paragraph(f"<b>Número de Orden:</b> {order_data.get('numero_orden', 'N/A')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Fecha de Recepción:</b> {fecha_recibida_qdate.toString('dd/MM/yyyy')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Proveedor de Origen:</b> {order_data.get('proveedor_origen', 'N/A')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Monto Total:</b> ${order_data.get('monto_total', 0.0):.2f} USD", font_size=12))
    story.append(Spacer(1, 0.5*cm))

    # Products Table
    products = json.loads(order_data.get("datos_productos_json", "[]"))
    table_data = [["Nombre del Producto", "Cantidad", "Precio Unidadario", "Precio Total"]]

    for p in products:
        table_data.append([
            p.get("nombre", p.get("descripcion", "N/A")),
            f"{p.get('cantidad', 0):.2f}",
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data)
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
    ]))
    story.append(product_table)

    try:
        doc.build(story)
        return True, "PDF de Orden Recibida generado exitosamente."
    except Exception as e:
        logging.error(f"Error al generar PDF de Orden Recibida: {e}", exc_info=True)
        return False, f"Error al generar PDF de Orden Recibida: {e}"



# ---- CONTINUACIÓN: INTERFAZ DE USUARIO (PyQt5) ----

import sqlite3
import bcrypt
from datetime import datetime, timedelta
import json
import os
import re
import sys
import time
import tempfile # For creating temporary files
import csv # For CSV export
import logging # For logging

# Importaciones necesarias de PyQt5
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QStackedWidget, QDialog, QLabel, QLineEdit, QMessageBox,
    QFormLayout, QDateEdit, QComboBox, QTableWidget, QHeaderView,
    QAbstractItemView, QFileDialog, QProgressDialog, QGroupBox, QDialogButtonBox,
    QTableWidgetItem # IMPORTANT: Add this import!
)
from PyQt5.QtGui import QDoubleValidator, QFont, QDesktopServices
from PyQt5.QtCore import Qt, QDate, QUrl

# Importaciones necesarias de ReportLab para la generación de PDFs
from reportlab.lib import colors
from reportlab.lib.pagesizes import letter
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm

# Asegúrate de tener instaladas las siguientes bibliotecas:
# pip install PyQt5 pdfplumber python-docx reportlab bcrypt

# --- Configuración general de la aplicación ---
# It is recommended to move this to a separate file in a real production environment.
class ConfiguracionAplicacion:
    NOMBRE_BD: str = 'compras.db'
    USUARIO_ADMIN_POR_DEFECTO: str = 'admin'
    CONTRASENA_ADMIN_POR_DEFECTO: str = 'admin123' # IMPORTANT: Change this in a production environment!
    TASA_IVA: float = 0.16 # IVA rate (16%)
    LONGITUD_MINIMA_CONTRASENA: int = 6 # Minimum password length

# Configuración del registro de eventos
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Clase para la gestión de la base de datos ---
class GestorBaseDeDatos:
    """
    Class to manage SQLite database connections and operations.
    Centralizes database handling and improves error management.
    """
    def __init__(self, db_name: str):
        self.db_name = db_name

    def _connect(self) -> sqlite3.Connection:
        """Establishes and returns a database connection."""
        return sqlite3.connect(self.db_name)

    def ejecutar_consulta(self, query: str, params: tuple = ()) -> tuple[bool, str]:
        """Executes an SQL query that modifies the database (INSERT, UPDATE, DELETE)."""
        conn = self._connect()
        cursor = conn.cursor()
        try:
            cursor.execute(query, params)
            conn.commit()
            return True, "Operación exitosa."
        except sqlite3.IntegrityError as e:
            logging.error(f"Database integrity error: {e} - Query: {query} - Parameters: {params}")
            return False, f"Error de integridad: {e}"
        except sqlite3.Error as e:
            logging.error(f"Error en la base de datos: {e} - Query: {query} - Parameters: {params}")
            return False, f"Error en la base de datos: {e}"
        finally:
            conn.close()

    def obtener_uno(self, query: str, params: tuple = ()) -> tuple | None:
        """Executes an SQL query and returns a single row."""
        conn = self._connect()
        cursor = conn.cursor()
        try:
            cursor.execute(query, params)
            return cursor.fetchone()
        except sqlite3.Error as e:
            logging.error(f"Error fetching a row from the database: {e} - Query: {query} - Parameters: {params}")
            return None
        finally:
            conn.close()

    def obtener_todos(self, query: str, params: tuple = ()) -> list[tuple]:
        """Executes an SQL query and returns all rows."""
        conn = self._connect()
        cursor = conn.cursor()
        try:
            cursor.execute(query, params)
            return cursor.fetchall()
        except sqlite3.Error as e:
            logging.error(f"Error fetching all rows from the database: {e} - Query: {query} - Parameters: {params}")
            return []
        finally:
            conn.close()

# Global instance of the database manager
db_manager = GestorBaseDeDatos(ConfiguracionAplicacion.NOMBRE_BD)

def add_column_if_not_exists(cursor: sqlite3.Cursor, table_name: str, column_name: str, column_type: str, default_value: str = None) -> None:
    """Adds a column to a table if it does not exist. (Used only in initialize_db)."""
    cursor.execute(f"PRAGMA table_info({table_name})")
    columns = [col[1] for col in cursor.fetchall()]
    if column_name not in columns:
        try:
            if default_value is not None:
                cursor.execute(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type} DEFAULT '{default_value}'")
                logging.info(f"Column '{column_name}' added to '{table_name}' with default value.")
            else:
                cursor.execute(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type}")
                logging.info(f"Column '{column_name}' added to '{table_name}'.")
        except sqlite3.Error as e:
            logging.error(f"Error adding column {column_name} to {table_name}: {e}")


def inicializar_bd() -> None:
    """
    Initializes the 'compras.db' database and creates the necessary tables
    if they do not exist: 'usuarios', 'ordenes_compra_recibidas', 'ordenes_compra_generadas',
    and 'productos_catalogo'.
    """
    conn = db_manager._connect() # Direct access only for initialization
    cursor = conn.cursor()

    # Table for users
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS usuarios (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            rol TEXT NOT NULL
        )
    ''')

    # Table for received purchase orders (from supplier)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ordenes_compra_recibidas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            numero_orden TEXT UNIQUE NOT NULL,
            fecha_recibida TEXT NOT NULL,
            proveedor_origen TEXT NOT NULL,
            monto_total REAL,
            estado TEXT NOT NULL,
            ruta_archivo_original TEXT,
            ruta_foto TEXT,  -- New column for photo path
            datos_productos_json TEXT
        )
    ''')

    # Table for generated purchase orders (to our supplier)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ordenes_compra_generadas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            numero_orden_generada TEXT UNIQUE NOT NULL,
            fecha_generada TEXT NOT NULL,
            proveedor_destino TEXT NOT NULL,
            monto_total REAL,
            estado TEXT NOT NULL,
            ruta_archivo_generado TEXT,
            ruta_foto TEXT, -- New column for photo path
            orden_recibida_id INTEGER,
            datos_productos_json TEXT,
            fecha_entrega TEXT,
            estado_entrega TEXT DEFAULT 'Pendiente',
            formato_pdf TEXT DEFAULT 'Demoga', -- New column for PDF format
            FOREIGN KEY (orden_recibida_id) REFERENCES ordenes_compra_recibidas(id)
        )
    ''')
    
    # NEW TABLE: productos_catalogo
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS productos_catalogo (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            edp TEXT UNIQUE NOT NULL,
            numero_cliente TEXT UNIQUE,
            descripcion TEXT NOT NULL,
            costo REAL NOT NULL
        )
    ''')
    
    conn.commit()

    # Ensure new columns exist to avoid errors if DB already existed
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'fecha_entrega', 'TEXT')
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'estado_entrega', 'TEXT', 'Pendiente')
    add_column_if_not_exists(cursor, 'ordenes_compra_recibidas', 'ruta_foto', 'TEXT') # Add foto column for received
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'ruta_foto', 'TEXT') # Add foto column for generated
    add_column_if_not_exists(cursor, 'ordenes_compra_generadas', 'formato_pdf', 'TEXT', 'Demoga') # Add PDF format column

    # Add indexes for the new products table
    cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_productos_catalogo_edp ON productos_catalogo (edp)')
    cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS idx_productos_catalogo_numero_cliente ON productos_catalogo (numero_cliente)')


    conn.commit()
    conn.close()
    logging.info("Database initialized (or already existed) and columns verified/added.")

# --- Funciones CRUD para el catálogo de productos ---
def agregar_producto_al_catalogo(edp: str, numero_cliente: str, descripcion: str, costo: float) -> tuple[bool, str]:
    """Adds a new product to the catalog."""
    success, message = db_manager.ejecutar_consulta(
        "INSERT INTO productos_catalogo (edp, numero_cliente, descripcion, costo) VALUES (?, ?, ?, ?)",
        (edp, numero_cliente, descripcion, costo)
    )
    if success:
        logging.info(f"Product '{edp}' added to catalog.")
    else:
        logging.error(f"Error adding product '{edp}' to catalog: {message}")
    return success, message

def obtener_todos_los_productos() -> list[dict]:
    """Retrieves all products from the catalog."""
    results = db_manager.obtener_todos("SELECT id, edp, numero_cliente, descripcion, costo FROM productos_catalogo")
    return [{"id": r[0], "edp": r[1], "numero_cliente": r[2], "descripcion": r[3], "costo": r[4]} for r in results]

def obtener_producto_por_id(product_id: int) -> dict | None:
    """Retrieves a product from the catalog by its ID."""
    result = db_manager.obtener_uno("SELECT id, edp, numero_cliente, descripcion, costo FROM productos_catalogo WHERE id = ?", (product_id,))
    if result:
        return {"id": result[0], "edp": result[1], "numero_cliente": result[2], "descripcion": result[3], "costo": result[4]}
    return None

def actualizar_producto_del_catalogo(product_id: int, edp: str, numero_cliente: str, descripcion: str, costo: float) -> tuple[bool, str]:
    """Updates an existing product in the catalog."""
    success, message = db_manager.ejecutar_consulta(
        "UPDATE productos_catalogo SET edp = ?, numero_cliente = ?, descripcion = ?, costo = ? WHERE id = ?",
        (edp, numero_cliente, descripcion, costo, product_id)
    )
    if success:
        logging.info(f"Product with ID {product_id} updated in the catalog.")
    else:
        logging.error(f"Error updating product with ID {product_id}: {message}")
    return success, message

def eliminar_producto_del_catalogo(product_id: int) -> tuple[bool, str]:
    """Deletes a product from the catalog by its ID."""
    success, message = db_manager.ejecutar_consulta("DELETE FROM productos_catalogo WHERE id = ?", (product_id,))
    if success:
        logging.info(f"Product with ID {product_id} deleted from catalog.")
    else:
        logging.error(f"Error deleting product with ID {product_id}: {message}")
    return success, message

def crear_usuario(username: str, password: str, rol: str) -> tuple[bool, str]:
    """
    Creates a new user in the database with a hashed password.
    Returns True and a success message, or False and an error message.
    """
    if len(password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
        return False, f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long."

    hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
    success, message = db_manager.ejecutar_consulta(
        "INSERT INTO usuarios (username, password_hash, rol) VALUES (?, ?, ?)",
        (username, hashed_password, rol)
    )
    if success:
        logging.info(f"User '{username}' created with role '{rol}'.")
        # Self-check password (for debugging only)
        if not bcrypt.checkpw(password.encode('utf-8'), hashed_password.encode('utf-8')):
            logging.warning(f"Contraseña self-check for '{username}' FAILED after creation.")
    else:
        logging.error(f"Error creating user '{username}': {message}")
    return success, message

def obtener_usuario_por_id(user_id: int) -> dict | None:
    """Gets user details by ID."""
    result = db_manager.obtener_uno("SELECT id, username, rol FROM usuarios WHERE id = ?", (user_id,))
    if result:
        return {"id": result[0], "username": result[1], "rol": result[2]}
    return None

def obtener_usuario_por_nombre(username: str) -> dict | None:
    """Gets user details by username."""
    result = db_manager.obtener_uno("SELECT id, username, rol, password_hash FROM usuarios WHERE username = ?", (username,))
    if result:
        return {"id": result[0], "username": result[1], "rol": result[2], "password_hash": result[3]}
    return None

def obtener_todos_los_usuarios() -> list[dict]:
    """Gets all users from the database."""
    results = db_manager.obtener_todos("SELECT id, username, rol FROM usuarios")
    return [{"id": r[0], "username": r[1], "rol": r[2]} for r in results]

def actualizar_usuario(user_id: int, username: str, password: str = None, rol: str = None) -> tuple[bool, str]:
    """Updates user data. Allows updating password and/or role."""
    updates = []
    params = []
    
    if username:
        updates.append("username = ?")
        params.append(username)
    if password:
        if len(password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            return False, f"La nueva contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long."
        hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
        updates.append("password_hash = ?")
        params.append(hashed_password)
    if rol:
        updates.append("rol = ?")
        params.append(rol)
    
    if not updates:
        return False, "No hay datos para actualizar."

    update_query = "UPDATE usuarios SET " + ", ".join(updates) + " WHERE id = ?"
    params.append(user_id)

    success, message = db_manager.ejecutar_consulta(update_query, tuple(params))
    if success:
        logging.info(f"User with ID {user_id} updated successfully.")
    else:
        logging.error(f"Error updating user with ID {user_id}: {message}")
    return success, message

def eliminar_usuario(user_id: int) -> tuple[bool, str]:
    """Deletes a user by ID."""
    success, message = db_manager.ejecutar_consulta("DELETE FROM usuarios WHERE id = ?", (user_id,))
    if success:
        logging.info(f"User with ID {user_id} deleted successfully.")
    else:
        logging.error(f"Error deleting user with ID {user_id}: {message}")
    return success, message

def verificar_credenciales(username: str, password: str) -> tuple[bool, str | None]:
    """
    Verifies a user's credentials.
    Returns True and the user's role if credentials are correct, False and None otherwise.
    """
    logging.info(f"Attempting to verify credentials for user: '{username}'")
    user_data = obtener_usuario_por_nombre(username)
    if user_data:
        password_hash_guardado = user_data["password_hash"]
        rol_del_usuario = user_data["rol"]
        logging.info(f"Usuario encontrado. Guardard hash (partial): {password_hash_guardado[:10]}...")
        if bcrypt.checkpw(password.encode('utf-8'), password_hash_guardado.encode('utf-8')):
            logging.info("Contraseña verified successfully.")
            return True, rol_del_usuario
        else:
            logging.warning("Contraseña incorrecta.")
    else:
        logging.warning(f"User '{username}' not found in the database.")
    return False, None

def eliminar_orden_por_id(order_id: int, order_type: str) -> tuple[bool, str]:
    """Deletes a purchase order by its ID and type."""
    table_name = ""
    if order_type == "Recibida":
        table_name = "ordenes_compra_recibidas"
    elif order_type == "Generada":
        table_name = "ordenes_compra_generadas"
    else:
        return False, "Tipo de orden desconocido."
    
    success, message = db_manager.ejecutar_consulta(f"DELETE FROM {table_name} WHERE id = ?", (order_id,))
    if success:
        logging.info(f"Order '{order_type}' with ID {order_id} deleted successfully.")
    else:
        logging.error(f"Error deleting order '{order_type}' with ID {order_id}: {message}")
    return success, message

def actualizar_estado_entrega_orden(order_id: int, new_status: str) -> tuple[bool, str]:
    """Updates the delivery status of a generated order."""
    success, message = db_manager.ejecutar_consulta("UPDATE ordenes_compra_generadas SET estado_entrega = ? WHERE id = ?", (new_status, order_id))
    if success:
        logging.info(f"Delivery status of generated order ID {order_id} updated to '{new_status}'.")
    else:
        logging.error(f"Error updating delivery status of generated order ID {order_id}: {message}")
    return success, message

def actualizar_orden_en_bd(order_id: int, order_type: str, updated_data: dict) -> tuple[bool, str]:
    """
    Updates a purchase order (received or generated) with new data.
    `updated_data` is a dictionary with the fields to update.
    """
    table_name = ""
    id_field = ""
    if order_type == "Recibida":
        table_name = "ordenes_compra_recibidas"
        id_field = "id"
    elif order_type == "Generada":
        table_name = "ordenes_compra_generadas"
        id_field = "id"
    else:
        return False, "Tipo de orden desconocido for update."

    set_clauses = []
    params = []
    
    for key, value in updated_data.items():
        if key in ["id", "ruta_foto", "orden_recibida_id"]: # Fields not directly updatable from the dialog or handled separately
            continue 
        set_clauses.append(f"{key} = ?")
        params.append(value)
    
    if not set_clauses:
        return False, "No hay datos para actualizar."

    query = f"UPDATE {table_name} SET {', '.join(set_clauses)} WHERE {id_field} = ?"
    params.append(order_id)

    success, message = db_manager.ejecutar_consulta(query, tuple(params))
    if success:
        logging.info(f"Order {order_type} with ID {order_id} updated successfully.")
    else:
        logging.error(f"Error updating order {order_type} with ID {order_id}: {message}")
    return success, message


def obtener_detalles_orden_recibida(order_id: int) -> dict | None:
    """Gets all details of a received purchase order by its ID."""
    result = db_manager.obtener_uno("SELECT id, numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json FROM ordenes_compra_recibidas WHERE id = ?", (order_id,))
    if result:
        return {
            "id": result[0],
            "numero_orden": result[1],
            "fecha_recibida": result[2],
            "proveedor_origen": result[3],
            "monto_total": result[4],
            "estado": result[5],
            "ruta_archivo_original": result[6],
            "ruta_foto": result[7],
            "datos_productos_json": result[8]
        }
    return None

def obtener_detalles_orden_generada(order_id: int) -> dict | None:
    """Gets all details of a generated purchase order by its ID."""
    result = db_manager.obtener_uno("SELECT id, numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, estado_entrega, formato_pdf FROM ordenes_compra_generadas WHERE id = ?", (order_id,))
    if result:
        formato_pdf_from_db = result[12]
        # Ensure that formato_pdf is one of the expected values, default to 'Demoga' if not
        if formato_pdf_from_db not in ["Demoga", "Emaldo"]:
            formato_pdf_from_db = "Demoga" 

        return {
            "id": result[0],
            "numero_orden_generada": result[1],
            "fecha_generada": result[2],
            "proveedor_destino": result[3],
            "monto_total": result[4],
            "estado": result[5],
            "ruta_archivo_generado": result[6],
            "ruta_foto": result[7],
            "orden_recibida_id": result[8],
            "datos_productos_json": result[9],
            "fecha_entrega": result[10],
            "estado_entrega": result[11],
            "formato_pdf": formato_pdf_from_db 
        }
    return None

# --- Funciones para analizar PDFs ---

# Month mapping for date parsing (used in parse_date_format and specific parsing functions)
MONTH_MAP = {
    'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
    'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
}

def parse_date_format(date_str: str) -> datetime | None:
    """Tries to parse a date in various formats and returns a datetime object or None."""
    # Convert month abbreviations to numbers before parsing for consistency
    temp_date_str = date_str.upper()
    for abbr, num in MONTH_MAP.items():
        temp_date_str = temp_date_str.replace(abbr, num)

    formats = [
        "%Y-%m-%d",
        "%d-%m-%Y",
        "%m-%d-%Y",
        "%d/%m/%Y",
        "%m/%d/%Y",
        "%Y/%m/%d",
        "%d %m %Y" # For "07 APR 2025" after conversion
    ]
    for fmt in formats:
        try:
            return datetime.strptime(temp_date_str, fmt)
        except ValueError:
            continue
    return None


def parse_mcx_po(content: str) -> dict:
    """
    Parses the MCX_PO_74907_344_0.PDF structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Número de Orden
    num_orden_match = re.search(r'No\.\s*([\w\d-]+)\s*Rev\.0', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha (e.g., "07 APR 2025")
    fecha_match = re.search(r'(\d{2})\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(\d{4})', content)
    if fecha_match:
        day = fecha_match.group(1)
        month_abbr = fecha_match.group(2).upper()
        year = fecha_match.group(3)
        month_num = MONTH_MAP.get(month_abbr, '')
        if all([day, month_num, year]):
            parsed_date = parse_date_format(f"{day} {month_num} {year}")
            if parsed_date:
                data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")
    
    # Supplier Name - Attempt to capture the first line after "PROVEEDOR (SUPPLIER)"
    proveedor_match = re.search(r'PROVEEDOR \(SUPPLIER\)\s*\n\s*([^\n]+)', content, re.IGNORECASE)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip().replace(',', '')

    # Monto Total
    monto_match = re.search(r'TOTAL\s*USD\s*([\d,\.]+)', content)
    if monto_match:
        try:
            data["monto_total"] = float(monto_match.group(1).replace(',', '').strip())
        except ValueError:
            logging.warning(f"Could not parse total amount for MCX_PO: {monto_match.group(1)}")


    # Detalles del Producto (CSV-like rows)
    productos = []
    product_lines_raw = re.findall(
        r'"(\d+)"\s*,\s*'          # LINE
        r'"([\d.]+)"\s*,\s*'        # QTY
        r'"(.*?)"\s*,\s*'           # U.M.
        r'"(.*?)"\s*,\s*'           # CODE
        r'"(.*?)"\s*,\s*'           # DESCRIPTION
        r'"(.*?)"\s*,\s*'           # DATE
        r'"(.*?)"\s*,\s*'           # REQ.
        r'([^,]*?),\s*'             # COT (Handles empty string between commas, non-greedy)
        r'"([\d.]+)"\s*,\s*'        # UNIT PRICE
        r'"([\d.,]+)"',             # TOTAL PRICE
        content
    )

    for line_data in product_lines_raw:
        try:
            line_num = line_data[0].strip()
            qty = float(line_data[1].strip())
            unit = line_data[2].strip()
            code = line_data[3].strip()
            description = line_data[4].strip()
            unit_price = float(line_data[8].replace(',', '').strip())
            total_price = float(line_data[9].replace(',', '').strip())

            productos.append({
                "linea": line_num,
                "cantidad": qty,
                "unidad": unit,
                "codigo": code,
                "descripcion": description,
                "precio_unitario": unit_price,
                "precio_total": total_price
            })
        except ValueError as e:
            logging.warning(f"Error parsing MCX_PO product line (ValueError): {line_data} - {e}")
            continue
        except IndexError as e:
            logging.warning(f"Error parsing MCX_PO product line (IndexError): {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data


def parse_pc002057_emaldo_po(content: str) -> dict:
    """
    Parses the PC002057 EMALDO.pdf structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Supplier
    proveedor_match = re.search(r'SUPPLIER:\s*(.+)', content)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip()

    # Número de Orden
    num_orden_match = re.search(r'NBR:\s*\"?([A-Z0-9]+)\"?', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha (e.g., 23/01/2025)
    fecha_match = re.search(r'DATE:\s*\"?(\d{2}/\d{2}/\d{4})\"?', content)
    if fecha_match:
        parsed_date = parse_date_format(fecha_match.group(1))
        if parsed_date:
            data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Monto Total
    monto_match = re.search(r'Total:\s*([\d,\.]+\s*USD)', content)
    if monto_match:
        try:
            total_str = monto_match.group(1).replace(',', '').replace(' USD', '').strip()
            data["monto_total"] = float(total_str)
        except ValueError:
            logging.warning(f"Could not parse total amount for EMALDO: {monto_match.group(1)}")


    # Detalles del Producto (CSV-like rows)
    productos = []
    # Regex for EMALDO: "PART","CODE","DESCRIPTION","",,"QTY","U.PRICE","VALUE"
    product_lines_raw = re.findall(r'"(\d+)"\s*,\s*"(.*?)"\s*,\s*"(.*?)"\s*,\s*"(.*?)"\s*,\s*"(\d+\.?\d*)"\s*,\s*"(\d+\.?\d*)"\s*,\s*"([\d,\.]+)"', content)

    for line_data in product_lines_raw:
        try:
            part_num = line_data[0]
            code = line_data[1]
            description = line_data[2]
            # line_data[3] is the empty '# PART' field
            qty = float(line_data[4])
            unit_price = float(line_data[5])
            value = float(line_data[6].replace(',', ''))

            productos.append({
                "part_num": part_num,
                "code": code,
                "description": description,
                "quantity": qty,
                "unit_price": unit_price,
                "value": value
            })
        except ValueError as e:
            logging.warning(f"Error parsing EMALDO product line (ValueError): {line_data} - {e}")
            continue
        except IndexError as e:
            logging.warning(f"Error parsing EMALDO product line (IndexError): {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data

def parse_m229420_po(content: str) -> dict:
    """
    Parses the M229420.PDF structure.
    """
    data = {
        "numero_orden": "",
        "fecha_recibida": "",
        "proveedor_origen": "",
        "monto_total": 0.0,
        "datos_productos_json": "[]"
    }

    # Número de Orden
    num_orden_match = re.search(r'PO NUMBER\\NUMERO PO\s*\"?([A-Z0-9]+)\"?', content)
    if num_orden_match:
        data["numero_orden"] = num_orden_match.group(1).strip()

    # Fecha
    fecha_match = re.search(r'DATE FECHA\s*\"?(\d{2}/\d{2}/\d{2})\"?', content)
    if fecha_match:
        day, month, year_short = fecha_match.group(1).split('/')
        # Heuristic for 2-digit years (e.g., 24 -> 2024)
        current_year_last_two_digits = datetime.now().year % 100
        year_full = f"20{year_short}" if int(year_short) <= current_year_last_two_digits else f"19{year_short}"
        parsed_date = parse_date_format(f"{day}/{month}/{year_full}")
        if parsed_date:
            data["fecha_recibida"] = parsed_date.strftime("%Y-%m-%d")

    # Supplier Name
    proveedor_match = re.search(r'R\.F\.C\.:HAS120702332\s*\n\s*([^,\n]+(?:,[^\n]+)*)', content, re.IGNORECASE)
    if proveedor_match:
        data["proveedor_origen"] = proveedor_match.group(1).strip().replace(',', '')
    
    # Monto Total (appears on page 2)
    monto_match = re.search(r'Total This PO:\s*\(USD\s*\)\s*([\d,\.]+)', content)
    if monto_match:
        try:
            data["monto_total"] = float(monto_match.group(1).replace(',', '').strip())
        except ValueError:
            logging.warning(f"Could not parse total amount for M229420: {monto_match.group(1)}")


    # Detalles del Producto (Refined Regex)
    productos = []
    product_lines_raw = re.findall(
        r'"(\d+)"\s*,\s*'              # Group 1: Línea number
        r'"([\d\.]+\s*[^\"]+)"\s*,\s*' # Group 2: Cantidad and Unidad (e.g., "500.000 Piezas")
        r'"([\d\.]+\s*per\s*[^\"]+)\s*' # Group 3: Price per Unidad (e.g., "63.22000 per Piezas") - capture up to " per "
        r'(.*?)"\s*,\s*'               # Group 4: Remaining Descripción (after "per Unidad" part, before next quote)
        r'"([\d,\.]+)"',               # Group 5: Precio Total
        content
    )

    for line_data in product_lines_raw:
        try:
            line_num = line_data[0]
            qty_unit_str = line_data[1].strip() 
            unit_price_per_str = line_data[2].strip() 
            description_remainder = line_data[3].strip()
            total_price = float(line_data[4].replace(',', ''))

            qty_match = re.match(r'([\d\.]+)\s*(.+)', qty_unit_str)
            qty = float(qty_match.group(1)) if qty_match else 0.0
            unit = qty_match.group(2).strip() if qty_match else ""

            unit_price_match = re.match(r'([\d\.]+)', unit_price_per_str) 
            unit_price = float(unit_price_match.group(1)) if unit_price_match else 0.0
            
            full_description = f"{unit_price_per_str} {description_remainder}".strip()

            delivery_date = "N/A" # Placeholder, actual regex needs to capture it if present

            productos.append({
                "linea": line_num,
                "cantidad": qty,
                "unidad": unit,
                "descripcion": full_description, 
                "precio_unitario": unit_price,
                "fecha_entrega": delivery_date, 
                "precio_total": total_price
            })
        except (ValueError, AttributeError, IndexError) as e:
            logging.warning(f"Error parsing M229420 product line: {line_data} - {e}")
            continue

    data["datos_productos_json"] = json.dumps(productos, indent=2, ensure_ascii=False)
    return data


# --- Funciones para generar archivos PDF ---
def create_styled_paragraph(text: str, style_id: str = 'Normal', font_size: int = 10, color = colors.black, bold: bool = False, alignment = Qt.AlignLeft) -> Paragraph:
    """Creates a Paragraph with custom styles."""
    styles = getSampleStyleSheet()
    if style_id not in styles:
        styles.add(ParagraphStyle(name=style_id, parent=styles['Normal']))
    
    current_style = styles[style_id]
    current_style.fontSize = font_size
    current_style.textColor = color
    if bold:
        current_style.fontName = 'Helvetica-Bold'
    else:
        current_style.fontName = 'Helvetica'
    
    if alignment == Qt.AlignCenter:
        current_style.alignment = 1 # TA_CENTER
    elif alignment == Qt.AlignRight:
        current_style.alignment = 2 # TA_RIGHT
    else:
        current_style.alignment = 0 # TA_LEFT

    return Paragraph(text, current_style)

def create_demoga_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF with Demoga format."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Company Header (Green Section)
    company_info = [
        ["DEMOGA S.A DE C.V.", ""],
        ["DeMoGa Tools. Libertad 22, La Magdalena Ocotitlan, Metepec Estado de Mexico. C.P. 52161 Tel: 722 931 38 79", ""]
    ]
    header_table = Table(company_info, colWidths=[14*cm, 5*cm]) 
    header_table.setStyle(TableStyle([
        ('BACKGROUND', (0,0), (-1,-1), colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green
        ('TEXTCOLOR', (0,0), (-1,-1), colors.white),
        ('ALIGN', (0,0), (0,0), 'LEFT'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'), 
        ('FONTNAME', (0,0), (0,0), 'Helvetica-Bold'),
        ('FONTSIZE', (0,0), (0,0), 16),
        ('FONTNAME', (0,1), (0,1), 'Helvetica'),
        ('FONTSIZE', (0,1), (0,1), 9),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('BOTTOMPADDING', (0,0), (-1,-1), 10),
    ]))
    story.append(header_table)
    story.append(Spacer(1, 0.2*cm))

    # General Company Info (Below Green Header - hardcoded for now, but could be dynamic)
    story.append(create_styled_paragraph("<b>Compañía:</b> INGERSOLL CUTTING TOOLS SA DE CV", font_size=10))
    story.append(create_styled_paragraph("<b>Dirección:</b> Blvd. José Musa de León No. 2127, Col. Los Pinos, C.P. 25198", font_size=10))
    story.append(create_styled_paragraph("<b>Ciudad:</b> Saltillo, Coahuila", font_size=10))
    story.append(create_styled_paragraph("<b>Tel./e-mail:</b> (844) 485 32 21", font_size=10))
    story.append(create_styled_paragraph("<b>At'n:</b> Gerardo Berlanga", font_size=10))
    story.append(Spacer(1, 0.5*cm))

    # PURCHASE ORDER Title and Info
    # Ensure date is in QDate format for toString
    fecha_generada_qdate = QDate.fromString(order_data['fecha_generada'], Qt.ISODate)
    order_title_data = [
        [create_styled_paragraph("<b>PURCHASE ORDER</b>", font_size=14, alignment=Qt.AlignCenter),
         create_styled_paragraph(f"<b>No.</b><br/>{order_data['numero_orden_generada']}", font_size=10, alignment=Qt.AlignRight)],
        [create_styled_paragraph(f"<b>Fecha:</b> {fecha_generada_qdate.toString('dd/MM/yyyy')}", font_size=10), ""]
    ]
    order_title_table = Table(order_title_data, colWidths=[14*cm, 5*cm])
    order_title_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (0,0), 'CENTER'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (1,0), (1,0), 'Helvetica-Bold'),
        ('FONTSIZE', (0,0), (-1,0), 14),
        ('FONTSIZE', (1,0), (1,0), 10),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5),
    ]))
    story.append(order_title_table)
    story.append(Spacer(1, 0.5*cm))

    # Product Table
    products = json.loads(order_data["datos_productos_json"])
    table_data = [
        ["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Ship Fecha", "Precio Unitario (USD)", "Precio Total (USD)"]
    ]

    for i, p in enumerate(products):
        # Ensure date is in QDate format for toString
        fecha_entrega_qdate = QDate.fromString(order_data['fecha_entrega'], Qt.ISODate)
        table_data.append([
            str(i + 1),
            p.get("codigo", ""), 
            p.get("numero_cliente", ""), 
            p.get("descripcion", p.get("nombre", "")),
            f"{p.get('cantidad', 0):.2f}",
            fecha_entrega_qdate.toString('dd/MM/yyyy'), 
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data, colWidths=[1*cm, 2.5*cm, 2.5*cm, 5*cm, 2*cm, 2.5*cm, 2.5*cm, 2.5*cm])
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green header
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 6),
        ('BACKGROUND', (0, 1), (-1, -1), colors.white),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.Color(red=0.0, green=0.5, blue=0.0, alpha=1)), # Dark Green grid
        ('TEXTCOLOR', (0, 1), (-1, -1), colors.black),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
    ]))
    story.append(product_table)
    story.append(Spacer(1, 0.5*cm))

    # Totals Section
    subtotal = sum(p.get('precio_total', 0.0) for p in products)
    iva = subtotal * ConfiguracionAplicacion.TASA_IVA 
    total = subtotal + iva

    totals_data = [
        ["Subtotal", f"{subtotal:.2f}"],
        [f"{ConfiguracionAplicacion.TASA_IVA * 100:.2f}% IVA", f"{iva:.2f}"],
        ["Total", f"{total:.2f}"]
    ]
    totals_table = Table(totals_data, colWidths=[15.5*cm, 3.5*cm])
    totals_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTNAME', (0,-1), (-1,-1), 'Helvetica-Bold'), 
        ('LINEBELOW', (0,-2), (-1,-2), 1, colors.black), 
        ('LINEBELOW', (0,-1), (-1,-1), 1, colors.black), 
        ('FONTSIZE', (0,0), (-1,-1), 10),
    ]))
    story.append(totals_table)
    story.append(Spacer(1, 1*cm))

    # Footer (hardcoded for now, could be dynamic)
    story.append(create_styled_paragraph("Independencia 1319, Metepec, Mexico C.P. 52160", font_size=9, alignment=Qt.AlignCenter))

    try:
        doc.build(story)
        return True, "Demoga PDF generated successfully."
    except Exception as e:
        logging.error(f"Error generating Demoga PDF: {e}", exc_info=True)
        return False, f"Error generating Demoga PDF: {e}"


def create_emaldo_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF with Emaldo format."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Company Header (Emaldo Logo and Info)
    # Replaced Image URL with styled Paragraph for "EMALDO" text.
    emaldo_logo_text = create_styled_paragraph("<b>EMALDO</b>", font_size=20, bold=True, alignment=Qt.AlignLeft,
                                               color=colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)) # Lighter blue
    story.append(emaldo_logo_text)
    story.append(Spacer(1, 0.2*cm)) # Small spacer after the logo text
    
    header_data = [
        [create_styled_paragraph("<b>INGERSOLL CUTTING TOOLS SA DE CV</b>", font_size=10, bold=True), ""],
        [create_styled_paragraph("Blvd. José Musa de León No. 2127, Col. Los Pinos, C.P. 25198", font_size=9), ""],
        [create_styled_paragraph("Saltillo, Coahuila", font_size=9), ""],
        [create_styled_paragraph("(844) 485 32 21", font_size=9), ""],
        [create_styled_paragraph("Attn: Gerardo Berlanga", font_size=9), ""]
    ]
    header_table = Table(header_data, colWidths=[10*cm, 9*cm])
    header_table.setStyle(TableStyle([
        ('VALIGN', (0,0), (-1,-1), 'TOP'),
        ('TEXTCOLOR', (0,0), (-1,-1), colors.black),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'), 
        ('FONTNAME', (0,1), (0,1), 'Helvetica-Bold'),
        ('FONTNAME', (0,2), (0,5), 'Helvetica'),
        ('ALIGN', (0,0), (-1,-1), 'LEFT'),
    ]))
    story.append(header_table)
    story.append(Spacer(1, 0.5*cm))

    # PURCHASE ORDER Title and Info
    fecha_generada_qdate = QDate.fromString(order_data['fecha_generada'], Qt.ISODate)
    order_title_data = [
        [create_styled_paragraph("<b>PURCHASE ORDER</b>", font_size=14, bold=True, alignment=Qt.AlignCenter),
         create_styled_paragraph(f"No. POOGM-{order_data['numero_orden_generada']}", font_size=10, alignment=Qt.AlignRight)],
        [create_styled_paragraph(f"Fecha: {fecha_generada_qdate.toString('dd/MM/yyyy')}", font_size=10), ""]
    ]
    order_title_table = Table(order_title_data, colWidths=[14*cm, 5*cm])
    order_title_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (0,0), 'CENTER'),
        ('ALIGN', (1,0), (1,0), 'RIGHT'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (1,0), (1,0), 'Helvetica'),
        ('FONTSIZE', (0,0), (-1,0), 14),
        ('FONTSIZE', (1,0), (1,0), 10),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5),
    ]))
    story.append(order_title_table)
    story.append(Spacer(1, 0.5*cm))

    # Product Table
    products = json.loads(order_data["datos_productos_json"])
    table_data = [
        ["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Ship Fecha", "Precio Unitario (USD)", "Precio Total (USD)"]
    ]

    for i, p in enumerate(products):
        fecha_entrega_qdate = QDate.fromString(order_data['fecha_entrega'], Qt.ISODate)
        table_data.append([
            str(i + 1),
            p.get("codigo", ""), 
            p.get("numero_cliente", ""), 
            p.get("descripcion", p.get("nombre", "")),
            f"{p.get('cantidad', 0):.2f}",
            fecha_entrega_qdate.toString('dd/MM/yyyy'), 
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data, colWidths=[1*cm, 2.5*cm, 2.5*cm, 5*cm, 2*cm, 2.5*cm, 2.5*cm, 2.5*cm])
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)), # Lighter Blue header
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 6),
        ('BACKGROUND', (0, 1), (-1, -1), colors.white),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.Color(red=0.0, green=0.482, blue=1.0, alpha=1)), # Lighter Blue grid
        ('TEXTCOLOR', (0, 1), (-1, -1), colors.black),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
    ]))
    story.append(product_table)
    story.append(Spacer(1, 0.5*cm))

    # Totals Section
    subtotal = sum(p.get('precio_total', 0.0) for p in products)
    iva = subtotal * ConfiguracionAplicacion.TASA_IVA 
    total = subtotal + iva

    totals_data = [
        ["Subtotal", f"{subtotal:.2f}"],
        [f"{ConfiguracionAplicacion.TASA_IVA * 100:.2f}% IVA", f"{iva:.2f}"],
        ["Total", f"{total:.2f}"]
    ]
    totals_table = Table(totals_data, colWidths=[15.5*cm, 3.5*cm])
    totals_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTNAME', (0,-1), (-1,-1), 'Helvetica-Bold'), 
        ('LINEBELOW', (0,-2), (-1,-2), 1, colors.black), 
        ('LINEBELOW', (0,-1), (-1,-1), 1, colors.black), 
        ('FONTSIZE', (0,0), (-1,-1), 10),
    ]))
    story.append(totals_table)
    story.append(Spacer(1, 1*cm))

    # Footer (hardcoded for now, could be dynamic)
    story.append(create_styled_paragraph("Independencia 1319, Metepec, Mexico C.P. 52160", font_size=9, alignment=Qt.AlignCenter))
    
    try:
        doc.build(story)
        return True, "Emaldo PDF generated successfully."
    except Exception as e:
        logging.error(f"Error generating Emaldo PDF: {e}", exc_info=True)
        return False, f"Error generating Emaldo PDF: {e}"


def create_received_order_pdf(file_path: str, order_data: dict) -> tuple[bool, str]:
    """Generates a PDF for a received purchase order (generic format)."""
    doc = SimpleDocTemplate(file_path, pagesize=letter,
                            rightMargin=1.5*cm, leftMargin=1.5*cm,
                            topMargin=1.5*cm, bottomMargin=1.5*cm)
    story = []
    styles = getSampleStyleSheet()

    # Title
    story.append(create_styled_paragraph("<b>Received Purchase Order</b>", font_size=18, bold=True, alignment=Qt.AlignCenter))
    story.append(Spacer(1, 0.5*cm))

    # Order Details
    fecha_recibida_qdate = QDate.fromString(order_data['fecha_recibida'], Qt.ISODate)

    story.append(create_styled_paragraph(f"<b>Número de Orden:</b> {order_data.get('numero_orden', 'N/A')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Fecha de Recepción:</b> {fecha_recibida_qdate.toString('dd/MM/yyyy')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Proveedor de Origen:</b> {order_data.get('proveedor_origen', 'N/A')}", font_size=12))
    story.append(create_styled_paragraph(f"<b>Monto Total:</b> ${order_data.get('monto_total', 0.0):.2f} USD", font_size=12))
    story.append(Spacer(1, 0.5*cm))

    # Products Table
    products = json.loads(order_data.get("datos_productos_json", "[]"))
    table_data = [["Product Name", "Cantidad", "Precio Unitario", "Precio Total"]]

    for p in products:
        table_data.append([
            p.get("nombre", p.get("descripcion", "N/A")),
            f"{p.get('cantidad', 0):.2f}",
            f"{p.get('precio_unitario', 0.0):.2f}",
            f"{p.get('precio_total', 0.0):.2f}"
        ])

    product_table = Table(table_data)
    product_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
    ]))
    story.append(product_table)

    try:
        doc.build(story)
        return True, "Received Order PDF generated successfully."
    except Exception as e:
        logging.error(f"Error generating Received Order PDF: {e}", exc_info=True)
        return False, f"Error generating Received Order PDF: {e}"


# --- Part 2: Graphical User Interface (GUI) Classes ---

class DialogoInicioSesion(QDialog):
    """
    Iniciar Sesión dialog for the application.
    Allows the user to enter username and password for authentication.
    """
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Iniciar Sesión - Purchase Management")
        self.setFixedSize(300, 180) # Adjusted size for better viewing
        self.rol_usuario: str | None = None # Stores the authenticated user's role
        self.username_logged_in: str | None = None # Stores the authenticated username
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for login */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        """
        Configures the user interface elements of the login dialog.
        """
        layout = QVBoxLayout()
        layout.setSpacing(10) # Spacing between widgets

        # Title
        title_label = QLabel("Bienvenido")
        title_label.setAlignment(Qt.AlignCenter)
        title_font = QFont()
        title_font.setPointSize(16)
        title_font.setBold(True)
        title_label.setFont(title_font)
        layout.addWidget(title_label)

        # Nombre de usuario field
        layout.addWidget(QLabel("Nombre de usuario:"))
        self.username_input = QLineEdit(self)
        self.username_input.setPlaceholderText("Nombre de usuario")
        layout.addWidget(self.username_input)

        # Contraseña field
        self.password_input = QLineEdit(self)
        self.password_input.setPlaceholderText("Contraseña")
        self.password_input.setEchoMode(QLineEdit.Password) # Hides password
        layout.addWidget(self.password_input)

        # Iniciar Sesión button
        self.login_button = QPushButton("Iniciar Sesión", self)
        self.login_button.clicked.connect(self.attempt_login)
        layout.addWidget(self.login_button)

        self.setLayout(layout)

    def attempt_login(self):
        """
        Attempts to authenticate the user with the entered credentials.
        If successful, accepts the dialog; otherwise, displays a warning.
        """
        username = self.username_input.text()
        password = self.password_input.text()
        logging.info(f"DialogoInicioSesion: Attempting to log in user: '{username}'")

        autenticado, rol = verificar_credenciales(username, password)

        if autenticado:
            self.rol_usuario = rol
            self.username_logged_in = username
            self.accept()
        else:
            QMessageBox.warning(self, "Iniciar Sesión Error", "Incorrect username or password.")
            self.password_input.clear()

class ContraseñaAuthDialog(QDialog):
    """
    Dialog to request password and authorize an action.
    """
    def __init__(self, username: str, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle("Authorization Required")
        self.username = username
        self.setFixedSize(280, 150) # Adjusted size
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Ok */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QDialogButtonBox QPushButton#cancelButton { /* Specific style for Cancelar */
                background-color: #6c757d; /* Grey for Cancelar */
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QVBoxLayout()
        layout.setSpacing(10)

        info_label = QLabel(f"Please enter the password for user '{self.username}' to authorize this action:")
        info_label.setWordWrap(True) # Allows text to wrap to multiple lines
        layout.addWidget(info_label)

        self.password_input = QLineEdit(self)
        self.password_input.setEchoMode(QLineEdit.Password)
        self.password_input.setPlaceholderText("Contraseña")
        layout.addWidget(self.password_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(self.attempt_auth)
        button_box.rejected.connect(self.reject)
        # Assign object names to buttons for specific styling
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addWidget(button_box)
        
        self.setLayout(layout)

    def attempt_auth(self):
        password = self.password_input.text()
        autenticado, _ = verificar_credenciales(self.username, password)
        if autenticado:
            self.accept()
        else:
            QMessageBox.warning(self, "Authorization Error", "Contraseña incorrecta.")
            self.password_input.clear()

class ResetContraseñaDialog(QDialog):
    """
    Dialog for an administrator to reset another user's password.
    """
    def __init__(self, user_id: int, username_to_reset: str, admin_username: str, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle(f"Reset Contraseña for {username_to_reset}")
        self.user_id = user_id
        self.username_to_reset = username_to_reset
        self.admin_username = admin_username
        self.setFixedSize(350, 220)
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #28a745; /* Green for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #218838;
            }
            QDialogButtonBox QPushButton#cancelButton { /* Specific style for Cancelar */
                background-color: #6c757d; /* Grey for Cancelar */
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {

                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)
    
    def init_ui(self):
        layout = QFormLayout()

        # Insert "Usuario:" label at the top
        layout.addRow("Usuario:", QLabel(self.username_to_reset))
        
        self.new_password_input = QLineEdit(self)
        self.new_password_input.setEchoMode(QLineEdit.Password)
        self.new_password_input.setPlaceholderText("Enter new password")
        layout.addRow(QLabel("New Contraseña:"), self.new_password_input)

        self.confirm_password_input = QLineEdit(self)
        self.confirm_password_input.setEchoMode(QLineEdit.Password)
        self.confirm_password_input.setPlaceholderText("Confirm new password")
        layout.addRow(QLabel("Confirm Contraseña:"), self.confirm_password_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.reset_password)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton") # Apply style
        layout.addRow(button_box)

        self.setLayout(layout)

    def reset_password(self):
        new_password = self.new_password_input.text()
        confirm_password = self.confirm_password_input.text()

        if not new_password:
            QMessageBox.warning(self, "Empty Contraseña", "New password cannot be empty.")
            return

        if new_password != confirm_password:
            QMessageBox.warning(self, "Contraseñas Do Not Match", "New password and confirmation do not match.")
            return
        
        if len(new_password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            QMessageBox.warning(self, "Weak Contraseña", f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long.")
            return

        # Authenticate the admin again before performing the reset
        auth_dialog = ContraseñaAuthDialog(self.admin_username, self)
        if auth_dialog.exec_() == QDialog.Accepted:
            success, message = actualizar_usuario(self.user_id, self.username_to_reset, new_password)
            if success:
                QMessageBox.information(self, "Success", f"Contraseña for '{self.username_to_reset}' reset successfully.")
                self.accept()
            else:
                QMessageBox.warning(self, "Reset Error", message)
        else:
            QMessageBox.warning(self, "Authorization Failed", "Not authorized to reset password.")

class ChangeContraseñaDialog(QDialog):
    """
    Dialog for a user to change their own password.
    """
    def __init__(self, user_id: int, username: str, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle("Change Contraseña")
        self.user_id = user_id
        self.username = username
        self.setFixedSize(350, 250)
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)
    
    def init_ui(self):
        layout = QFormLayout()

        layout.addRow("Usuario:", QLabel(self.username))
        
        self.current_password_input = QLineEdit(self)
        self.current_password_input.setEchoMode(QLineEdit.Password)
        self.current_password_input.setPlaceholderText("Current password")
        layout.addRow("Current Contraseña:", self.current_password_input)

        self.new_password_input = QLineEdit(self)
        self.new_password_input.setEchoMode(QLineEdit.Password)
        self.new_password_input.setPlaceholderText("New password")
        layout.addRow("New Contraseña:", self.new_password_input)

        self.confirm_password_input = QLineEdit(self)
        self.confirm_password_input.setEchoMode(QLineEdit.Password)
        self.confirm_password_input.setPlaceholderText("Confirm new password")
        layout.addRow("Confirmar Nueva:", self.confirm_password_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.change_password)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addRow(button_box)

        self.setLayout(layout)

    def change_password(self):
        current_password = self.current_password_input.text()
        new_password = self.new_password_input.text()
        confirm_password = self.confirm_password_input.text()

        if not current_password or not new_password or not confirm_password:
            QMessageBox.warning(self, "Empty Fields", "Please complete all fields.")
            return

        if new_password != confirm_password:
            QMessageBox.warning(self, "Contraseñas Do Not Match", "New password and confirmation do not match.")
            return
        
        if len(new_password) < ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA:
            QMessageBox.warning(self, "Weak Contraseña", f"La contraseña debe tener al menos {ConfiguracionAplicacion.LONGITUD_MINIMA_CONTRASENA} characters long.")
            return

        # Verify current password
        authenticated, _ = verificar_credenciales(self.username, current_password)
        if not authenticated:
            QMessageBox.warning(self, "Authorization Error", "Current password is incorrect.")
            return

        # Update the password
        success, message = actualizar_usuario(self.user_id, self.username, new_password)
        if success:
            QMessageBox.information(self, "Success", "Contraseña changed successfully.")
            self.accept()
        else:
            QMessageBox.warning(self, "Change Contraseña Error", message)


class LeerOCRecibidasPage(QWidget):
    """
    Page to read and process received purchase orders.
    Allows loading a file (TXT, DOCX, PDF), extracting data and saving it to the database.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window 
        self.init_ui()
        self.apply_styles()
        self.setAcceptDrops(True) 

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e; /* Dark background */
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;  
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #007bff; /* Blue */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#saveButton {
                background-color: #28a745; /* Green */
            }
            QPushButton#saveButton:hover {
                background-color: #218838;
            }
            QPushButton#clearButton {
                background-color: #dc3545; /* Red */
            }
            QPushButton#clearButton:hover {
                background-color: #c82333;
            }
            QTextEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
             #dropArea {
                border: 2px dashed #007bff;
                border-radius: 10px;
                background-color: #3a3a3a;
                padding: 20px;
                color: #F0F0F0;
                font-size: 16px;
                text-align: center;
             }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # File Upload Section
        file_input_group = QGroupBox("Cargar Archivo")
        file_layout = QVBoxLayout()
        
        self.file_path_label = QLabel("Arrastra y suelta un archivo aquí o haz clic para seleccionar.")
        self.file_path_label.setAlignment(Qt.AlignCenter)
        self.file_path_label.setWordWrap(True)
        self.file_path_label.setObjectName("dropArea") # For CSS styles
        
        self.select_file_button = QPushButton("Seleccionar Archivo")
        self.select_file_button.clicked.connect(self.select_file)
        
        file_selection_layout = QVBoxLayout()
        file_selection_layout.addWidget(self.file_path_label)
        file_selection_layout.addWidget(self.select_file_button)
        file_layout.addLayout(file_selection_layout)

        file_input_group.setLayout(file_layout)
        main_layout.addWidget(file_input_group)
        main_layout.addSpacing(10)

        # Datos Extraídos Section
        extracted_data_group = QGroupBox("Datos Extraídos")
        extracted_data_layout = QFormLayout()

        self.num_orden_input = QLineEdit()
        extracted_data_layout.addRow("Número de Orden:", self.num_orden_input)

        self.fecha_recibida_input = QDateEdit()
        self.fecha_recibida_input.setCalendarPopup(True)
        self.fecha_recibida_input.setDate(QDate.currentDate())
        extracted_data_layout.addRow("Fecha de Recepción:", self.fecha_recibida_input)

        self.proveedor_origen_input = QLineEdit()
        extracted_data_layout.addRow("Proveedor de Origen:", self.proveedor_origen_input)

        self.monto_total_input = QLineEdit()
        self.monto_total_input.setValidator(QDoubleValidator(0.0, 999999999.0, 2))
        extracted_data_layout.addRow("Monto Total:", self.monto_total_input)

        self.estado_combobox = QComboBox()
        self.estado_combobox.addItems(["Pendiente", "Procesada", "Cancelared"])
        extracted_data_layout.addRow("Estado:", self.estado_combobox)

        extracted_data_group.setLayout(extracted_data_layout)
        main_layout.addWidget(extracted_data_group)
        main_layout.addSpacing(10)

        # Detalles del Producto Section
        products_group = QGroupBox("Detalles del Producto")
        products_layout = QVBoxLayout()
        
        self.products_table = QTableWidget()
        self.products_table.setColumnCount(7) # Added "Precio Total"
        self.products_table.setHorizontalHeaderLabels(["Línea", "Cantidad", "Unidad", "Código", "Descripción", "Precio Unitario", "Precio Total"])
        self.products_table.horizontalHeader().setStretchLastSection(True)
        self.products_table.setSelectionBehavior(QAbstractItemView.SelectRows) # Select full rows
        products_layout.addWidget(self.products_table)
        
        products_group.setLayout(products_layout)
        main_layout.addWidget(products_group)
        main_layout.addSpacing(10)

        # Action Buttons
        button_layout = QHBoxLayout()
        self.save_button = QPushButton("Guardar Orden")
        self.save_button.setObjectName("saveButton")
        self.save_button.clicked.connect(self.save_order)
        button_layout.addWidget(self.save_button)

        self.clear_button = QPushButton("Limpiar Campos")
        self.clear_button.setObjectName("clearButton")
        self.clear_button.clicked.connect(self.clear_fields)
        button_layout.addWidget(self.clear_button)

        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def dragEnterEvent(self, event):
        if event.mimeData().hasUrls():
            event.accept()
        else:
            event.ignore()

    def dropEvent(self, event):
        for url in event.mimeData().urls():
            file_path = url.toLocalFile()
            if os.path.isfile(file_path):
                self.process_file(file_path)
                return
        QMessageBox.warning(self, "File Error", "The dragged file is not valid.")

    def select_file(self):
        options = QFileDialog.Options()
        file_path, _ = QFileDialog.getOpenFileName(self, "Seleccionar Orden File", "",
                                                   "Order Files (*.pdf *.docx *.txt);;All Files (*)", options=options)
        if file_path:
            self.process_file(file_path)

    def process_file(self, file_path: str) -> None:
        self.clear_fields() # Clear previous data
        self.file_path_label.setText(f"File loaded: {os.path.basename(file_path)}")
        
        content = ""
        file_extension = os.path.splitext(file_path)[1].lower()

        # Show loading indicator
        progress_dialog = QProgressDialog("Processing file...", "Cancelar", 0, 0, self)
        progress_dialog.setWindowModality(Qt.WindowModal)
        progress_dialog.setMinimumDuration(0) # Show immediately
        progress_dialog.setValue(0)
        progress_dialog.show()
        QApplication.processEvents() # Process events to show dialog immediately

        try:
            if file_extension == '.pdf':
                # Dynamically import docx here to avoid circular dependencies if parsing docx isn't always needed.
                from pdfplumber import open as pdfplumber_open
                with pdfplumber_open(file_path) as pdf:
                    for i, page in enumerate(pdf.pages):
                        content += page.extract_text() or ""
                        # Additionally, try to extract tables if available (for more structured parsing)
                        for table in page.extract_tables():
                            for row_data in table:
                                content += ",".join(str(cell) for cell in row_data if cell is not None) + "\n"
                        # Update progress for each page (simple example)
                        progress_dialog.setLabelText(f"Processing page {i+1} of {len(pdf.pages)}...")
                        progress_dialog.setValue(i + 1)
                        QApplication.processEvents() # Update progress bar
                        if progress_dialog.wasCanceled():
                            QMessageBox.warning(self, "Operation Cancelared", "File processing was canceled.")
                            return
            elif file_extension == '.docx':
                # Dynamically import docx here to avoid circular dependencies if parsing docx isn't always needed.
                from docx import Document
                doc = Document(file_path)
                for i, para in enumerate(doc.paragraphs):
                    content += para.text + "\n"
                    # No easy way to get total paragraphs for progress, so just a general update
                    if i % 10 == 0: # Update every 10 paragraphs
                        progress_dialog.setLabelText(f"Processing paragraph {i}...")
                        QApplication.processEvents() # Update progress bar
                        if progress_dialog.wasCanceled():
                            QMessageBox.warning(self, "Operation Cancelared", "File processing was canceled.")
                            return
            elif file_extension == '.txt':
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
            else:
                QMessageBox.warning(self, "Unsupported Format", "Please upload a PDF, DOCX, or TXT file.")
                return

            parsed_data = self.parse_content(content)
            if parsed_data and parsed_data.get("numero_orden"): # Check for essential data
                self.display_parsed_data(parsed_data)
            else:
                QMessageBox.warning(self, "Parsing Error", "Could not extract data from the file. Please check the format or try another file.")

        except Exception as e:
            QMessageBox.critical(self, "File Reading Error", f"An error occurred while processing the file: {e}")
            logging.error(f"Error processing file {file_path}: {e}", exc_info=True)
        finally:
            progress_dialog.close() # Ensure dialog is closed

    def parse_content(self, content: str) -> dict | None:
        """Tries to parse the content with several known parsers."""
        parsers = [
            parse_mcx_po,
            parse_pc002057_emaldo_po,
            parse_m229420_po
        ]
        
        for parser in parsers:
            try:
                parsed_data = parser(content)
                # Check for a core identifier to confirm successful parsing for *this* parser
                if parsed_data and parsed_data.get("numero_orden"):
                    logging.info(f"Content successfully parsed with {parser.__name__}")
                    return parsed_data
            except Exception as e:
                logging.warning(f"Parsing failed with {parser.__name__}: {e}")
                continue # Try next parser
        logging.warning("No known parser could extract data from the content.")
        return None 

    def display_parsed_data(self, data: dict) -> None:
        """Displays the parsed data in the UI fields."""
        self.num_orden_input.setText(data.get("numero_orden", ""))
        
        date_dt = parse_date_format(data.get("fecha_recibida", ""))
        if date_dt:
            qdate = QDate(date_dt.year, date_dt.month, date_dt.day)
            self.fecha_recibida_input.setDate(qdate)
        else:
            logging.warning(f"Invalid date when displaying: {data.get('fecha_recibida', '')}. Setting current date.")
            self.fecha_recibida_input.setDate(QDate.currentDate())
        
        self.proveedor_origen_input.setText(data.get("proveedor_origen", ""))
        self.monto_total_input.setText(f"{data.get('monto_total', 0.0):.2f}")
        self.estado_combobox.setCurrentText(data.get("estado", "Pendiente")) 

        self.products_table.setRowCount(0) 
        products = json.loads(data.get("datos_productos_json", "[]"))
        self.products_table.setRowCount(len(products))
        
        for row, p in enumerate(products):
            self.products_table.setItem(row, 0, QTableWidgetItem(str(p.get("linea", str(row + 1)))))
            self.products_table.setItem(row, 1, QTableWidgetItem(f"{p.get('cantidad', 0):.2f}"))
            self.products_table.setItem(row, 2, QTableWidgetItem(p.get("unidad", "")))
            self.products_table.setItem(row, 3, QTableWidgetItem(p.get("codigo", "")))
            self.products_table.setItem(row, 4, QTableWidgetItem(p.get("descripcion", p.get("nombre", "")))) 
            self.products_table.setItem(row, 5, QTableWidgetItem(f"{p.get('precio_unitario', 0.0):.2f}"))
            self.products_table.setItem(row, 6, QTableWidgetItem(f"{p.get('precio_total', 0.0):.2f}"))
        
        self.products_table.resizeColumnsToContents()

    def save_order(self) -> None:
        """Guardars the received purchase order to the database."""
        num_orden = self.num_orden_input.text().strip()
        fecha_recibida = self.fecha_recibida_input.date().toString(Qt.ISODate)
        proveedor_origen = self.proveedor_origen_input.text().strip()
        monto_total_text = self.monto_total_input.text().strip()
        estado = self.estado_combobox.currentText()

        if not num_orden or not proveedor_origen or not monto_total_text:
            QMessageBox.warning(self, "Incomplete Fields", "Please complete all main fields (Número de Orden, Proveedor de Origen, Monto Total).")
            return

        try:
            monto_total = float(monto_total_text)
        except ValueError:
            QMessageBox.warning(self, "Invalid Amount", "Total amount must be a valid number.")
            return

        products_data = []
        for row in range(self.products_table.rowCount()):
            try:
                linea = self.products_table.item(row, 0).text() if self.products_table.item(row, 0) else ""
                cantidad = float(self.products_table.item(row, 1).text()) if self.products_table.item(row, 1) and self.products_table.item(row, 1).text() else 0.0
                unidad = self.products_table.item(row, 2).text() if self.products_table.item(row, 2) else ""
                codigo = self.products_table.item(row, 3).text() if self.products_table.item(row, 3) else ""
                descripcion = self.products_table.item(row, 4).text() if self.products_table.item(row, 4) else ""
                precio_unitario = float(self.products_table.item(row, 5).text()) if self.products_table.item(row, 5) and self.products_table.item(row, 5).text() else 0.0
                precio_total = float(self.products_table.item(row, 6).text()) if self.products_table.item(row, 6) and self.products_table.item(row, 6).text() else 0.0

                products_data.append({
                    "linea": linea,
                    "cantidad": cantidad,
                    "unidad": unidad,
                    "codigo": codigo,
                    "descripcion": descripcion,
                    "precio_unitario": precio_unitario,
                    "precio_total": precio_total
                })
            except (ValueError, AttributeError) as e:
                QMessageBox.warning(self, "Product Error", f"Error in product data in row {row + 1}: {e}. Ensure Cantidad, Precio Unitario and Precio Total are valid numbers.")
                logging.error(f"Error processing product data to save: {e}", exc_info=True)
                return

        datos_productos_json = json.dumps(products_data, ensure_ascii=False)

        # Use GestorBaseDeDatos for insertion
        success, message = db_manager.ejecutar_consulta(
            '''
            INSERT INTO ordenes_compra_recibidas (numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', 
            (num_orden, fecha_recibida, proveedor_origen, monto_total, estado, self.file_path_label.text(), "", datos_productos_json)
        )
        
        if success:
            QMessageBox.information(self, "Success", "Received purchase order saved successfully.")
            self.clear_fields()
        else:
            QMessageBox.critical(self, "Guardar Error", message)


    def clear_fields(self) -> None:
        """Clears all UI fields."""
        self.num_orden_input.clear()
        self.fecha_recibida_input.setDate(QDate.currentDate())
        self.proveedor_origen_input.clear()
        self.monto_total_input.clear()
        self.estado_combobox.setCurrentIndex(0) # Set to "Pendiente"
        self.products_table.setRowCount(0)
        self.file_path_label.setText("Arrastra y suelta un archivo aquí o haz clic para seleccionar.")

class GenerarOCPage(QWidget):
    """
    Page to generate new purchase orders (PO) based on a received order.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.selected_received_order_id: int | None = None
        self.init_ui()
        self.apply_styles()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #007bff; /* Blue */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#generateButton {
                background-color: #28a745; /* Green */
            }
            QPushButton#generateButton:hover {
                background-color: #218838;
            }
            QPushButton#selectOrderButton {
                background-color: #ffc107; /* Yellow/Orange */
                color: #333333;
            }
            QPushButton#selectOrderButton:hover {
                background-color: #e0a800;
            }
            QPushButton#previewButton {
                background-color: #6f42c1; /* Purple */
            }
            QPushButton#previewButton:hover {
                background-color: #563d7c;
            }
            QTextEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Received Order Selection Section
        select_order_group = QGroupBox("Seleccionar Orden Recibida (Opcional)")
        select_order_layout = QHBoxLayout()
        self.received_order_label = QLabel("No order selected.")
        self.select_order_button = QPushButton("Seleccionar Orden")
        self.select_order_button.setObjectName("selectOrderButton")
        self.select_order_button.clicked.connect(self.open_select_received_order_dialog)
        select_order_layout.addWidget(self.received_order_label)
        select_order_layout.addWidget(self.select_order_button)
        select_order_group.setLayout(select_order_layout)
        main_layout.addWidget(select_order_group)
        main_layout.addSpacing(10)

        # Generada Order Details Section
        generated_order_group = QGroupBox("Detalles de la Orden a Generar")
        generated_order_layout = QFormLayout()

        # Improvement: Automatic Generada Número de Orden
        self.num_orden_generada_label = QLabel("Automatically Generada")
        generated_order_layout.addRow("Generada Número de Orden:", self.num_orden_generada_label)

        self.fecha_generada_input = QDateEdit()
        self.fecha_generada_input.setCalendarPopup(True)
        self.fecha_generada_input.setDate(QDate.currentDate())
        generated_order_layout.addRow("Generada Fecha:", self.fecha_generada_input)
        
        self.fecha_entrega_input = QDateEdit()
        self.fecha_entrega_input.setCalendarPopup(True)
        self.fecha_entrega_input.setDate(QDate.currentDate().addDays(7)) # Default to 7 days from now
        generated_order_layout.addRow("Fecha Estimada de Entrega:", self.fecha_entrega_input)


        self.proveedor_destino_input = QLineEdit()
        generated_order_layout.addRow("Proveedor Destino:", self.proveedor_destino_input)

        self.monto_total_generado_input = QLineEdit()
        self.monto_total_generado_input.setValidator(QDoubleValidator(0.0, 999999999.0, 2))
        self.monto_total_generado_input.setReadOnly(True) # Make it read-only if automatically calculated
        generated_order_layout.addRow("Monto Total:", self.monto_total_generado_input)

        self.estado_generado_combobox = QComboBox()
        self.estado_generado_combobox.addItems(["Pendiente", "In Process", "Completed", "Cancelared"])
        generated_order_layout.addRow("Estado:", self.estado_generado_combobox)

        self.formato_pdf_combobox = QComboBox()
        self.formato_pdf_combobox.addItems(["Demoga", "Emaldo"])
        generated_order_layout.addRow("Formato de PDF:", self.formato_pdf_combobox)

        generated_order_group.setLayout(generated_order_layout)
        main_layout.addWidget(generated_order_group)
        main_layout.addSpacing(10)

        # Product Table for Generada Order (Editable)
        products_gen_group = QGroupBox("Detalles del Producto (Modifiable)")
        products_gen_layout = QVBoxLayout()
        
        self.products_gen_table = QTableWidget()
        self.products_gen_table.setColumnCount(7) # Item, Parte (EDP), Parte del Cliente No., Descripción, Cantidad, Precio Unitario, Precio Total
        self.products_gen_table.setHorizontalHeaderLabels(["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Precio Unitario", "Precio Total"])
        self.products_gen_table.horizontalHeader().setStretchLastSection(True)
        self.products_gen_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        products_gen_layout.addWidget(self.products_gen_table)

        product_buttons_layout = QHBoxLayout()
        add_product_button = QPushButton("Agregar Producto")
        add_product_button.clicked.connect(self.add_product_row)
        product_buttons_layout.addWidget(add_product_button)
        
        remove_product_button = QPushButton("Eliminar Producto")
        remove_product_button.clicked.connect(self.remove_product_row)
        product_buttons_layout.addWidget(remove_product_button)
        
        products_gen_layout.addLayout(product_buttons_layout)
        
        products_gen_group.setLayout(products_gen_layout)
        main_layout.addWidget(products_gen_group)
        main_layout.addSpacing(10)


        # Action Buttons
        button_layout = QHBoxLayout()
        # New button for Preview
        self.preview_pdf_button = QPushButton("Vista Previa PDF")
        self.preview_pdf_button.setObjectName("previewButton")
        self.preview_pdf_button.clicked.connect(self.preview_generated_pdf)
        button_layout.addWidget(self.preview_pdf_button)

        self.generate_button = QPushButton("Generar y Guardar Orden")
        self.generate_button.setObjectName("generateButton")
        self.generate_button.clicked.connect(self.generate_and_save_order)
        button_layout.addWidget(self.generate_button)

        self.clear_gen_button = QPushButton("Limpiar Campos")
        self.clear_gen_button.setObjectName("clearButton")
        self.clear_gen_button.clicked.connect(self.clear_fields)
        button_layout.addWidget(self.clear_gen_button)

        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

        # Connect cell changes to recalculate total

    def add_product_row(self) -> None:
        """Adds a new product row to the editable table."""
        row_count = self.products_gen_table.rowCount()
        self.products_gen_table.insertRow(row_count)
        self.products_gen_table.setItem(row_count, 0, QTableWidgetItem(str(row_count + 1))) # Item number
        # FIX: Ensure all cells are initialized to prevent crashes
        for col in range(1, self.products_gen_table.columnCount()):
            if col in [4, 5, 6]: # Cantidad, Precio Unitario, Precio Total
                self.products_gen_table.setItem(row_count, col, QTableWidgetItem("0.00"))
            else:
                self.products_gen_table.setItem(row_count, col, QTableWidgetItem(""))
        
        # Make Cantidad and Precio Unitario editable for input
        qty_item = self.products_gen_table.item(row_count, 4)
        if qty_item:
            qty_item.setFlags(qty_item.flags() | Qt.ItemIsEditable)
        unit_price_item = self.products_gen_table.item(row_count, 5)
        if unit_price_item:
            unit_price_item.setFlags(unit_price_item.flags() | Qt.ItemIsEditable)

        # Apply validators to editable numeric fields if needed (QTableWidgetItem doesn't have direct validators)
        # You would typically do this on a custom delegate or custom QTableWidgetItem subclass if stricter validation is required at input time.
        # For now, it will rely on the float() conversion in recalculate_total and save_order.


    def remove_product_row(self) -> None:
        """Removes the selected row from the product table."""
        selected_rows = self.products_gen_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Delete Row", "Please select one or more rows to delete.")
            return

        # Delete rows in reverse order to avoid index issues
        for index in sorted([row.row() for row in selected_rows], reverse=True):
            self.products_gen_table.removeRow(index)
        
        # Re-number items after deletion
        for row in range(self.products_gen_table.rowCount()):
            # Ensure item exists before setting text
            item_num_item = self.products_gen_table.item(row, 0)
            if item_num_item:
                item_num_item.setText(str(row + 1))
            else: # If item doesn't exist for some reason, create it
                self.products_gen_table.setItem(row, 0, QTableWidgetItem(str(row + 1)))
        
        self.recalculate_total() # Recalculate total after removal

    def recalculate_total(self) -> None:
        """Recalculates the total amount of products in the table."""
        total_sum = 0.0
        for row in range(self.products_gen_table.rowCount()):
            try:
                qty_item = self.products_gen_table.item(row, 4)
                price_unit_item = self.products_gen_table.item(row, 5)
                
                qty = float(qty_item.text()) if qty_item and qty_item.text() else 0.0
                unit_price = float(price_unit_item.text()) if price_unit_item and price_unit_item.text() else 0.0
                
                row_total = qty * unit_price
                # Ensure the item for total exists before setting text
                total_item = self.products_gen_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_gen_table.setItem(row, 6, total_item)
                total_item.setText(f"{row_total:.2f}")
                
                total_sum += row_total
            except (ValueError, AttributeError):
                logging.warning(f"Non-numeric input in row {row} of the product table. Row total reset to 0.00.")
                # Ensure the total item is set to "0.00" on error
                total_item = self.products_gen_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_gen_table.setItem(row, 6, total_item)
                total_item.setText("0.00")
                continue
        self.monto_total_generado_input.setText(f"{total_sum:.2f}")

    def open_select_received_order_dialog(self) -> None:
        """Opens a dialog to select a received order as a base."""
        dialog = SelectReceivedOrderDialog(self)
        if dialog.exec_() == QDialog.Accepted:
            selected_id = dialog.selected_order_id
            if selected_id:
                self.load_received_order_for_generation(selected_id)
            else:
                QMessageBox.warning(self, "Empty Selection", "No received order was selected.")

    def load_received_order_for_generation(self, order_id: int) -> None:
        """Loads the details of a received order to use it for generation."""
        self.selected_received_order_id = order_id
        order_details = obtener_detalles_orden_recibida(order_id)
        if order_details:
            # Using .get() for robustness in case a key is missing
            self.received_order_label.setText(f"Selected Order: {order_details.get('numero_orden', 'N/A')} (Supplier: {order_details.get('proveedor_origen', 'N/A')})")
            
            self.proveedor_destino_input.setText(order_details.get('proveedor_origen', ''))
            self.monto_total_generado_input.setText(f"{order_details.get('monto_total', 0.0):.2f}")
            
            self.products_gen_table.setRowCount(0) 
            products = json.loads(order_details.get("datos_productos_json", "[]"))
            self.products_gen_table.setRowCount(len(products))
            
            for row, p in enumerate(products):
                # FIX: Ensure all items are created with default values for numeric fields
                self.products_gen_table.setItem(row, 0, QTableWidgetItem(p.get("linea", str(row + 1))))
                self.products_gen_table.setItem(row, 1, QTableWidgetItem(p.get("codigo", "")))
                self.products_gen_table.setItem(row, 2, QTableWidgetItem(p.get("numero_cliente", ""))) 
                self.products_gen_table.setItem(row, 3, QTableWidgetItem(p.get("descripcion", p.get("nombre", ""))))
                self.products_gen_table.setItem(row, 4, QTableWidgetItem(f"{p.get('cantidad', 0):.2f}"))
                self.products_gen_table.setItem(row, 5, QTableWidgetItem(f"{p.get('precio_unitario', 0.0):.2f}"))
                self.products_gen_table.setItem(row, 6, QTableWidgetItem(f"{p.get('precio_total', 0.0):.2f}"))
                
                # Make editable numeric fields actually editable
                self.products_gen_table.item(row, 4).setFlags(self.products_gen_table.item(row, 4).flags() | Qt.ItemIsEditable)
                self.products_gen_table.item(row, 5).setFlags(self.products_gen_table.item(row, 5).flags() | Qt.ItemIsEditable)


            self.products_gen_table.resizeColumnsToContents()

        else:
            QMessageBox.warning(self, "Error", "Could not load received order details.")
            logging.error(f"No details found for received order with ID: {order_id}")

    def generate_unique_po_number(self) -> str:
        """Generates a unique purchase order number based on date and time."""
        timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
        # To make it more unique and sequential, you could query the last PO number for today
        # For simplicity, we'll use a timestamp. If multiple POs generated in same second, it might clash.
        # A safer approach for production would be a counter stored in DB or a UUID.
        # For this example, let's use a very basic timestamp-based approach.
        return f"PO-{timestamp}"

    def get_order_data_for_pdf(self) -> dict | None:
        """Collects UI data to generate the PDF."""
        num_orden_generada = self.num_orden_generada_label.text().strip() # Use the label for the number
        if num_orden_generada == "Automatically Generada": # Ensure it's not the placeholder
            num_orden_generada = self.generate_unique_po_number()


        fecha_generada = self.fecha_generada_input.date().toString(Qt.ISODate)
        fecha_entrega = self.fecha_entrega_input.date().toString(Qt.ISODate)
        proveedor_destino = self.proveedor_destino_input.text().strip()
        monto_total_text = self.monto_total_generado_input.text().strip()

        if not num_orden_generada or not proveedor_destino or not monto_total_text:
            QMessageBox.warning(self, "Incomplete Fields", "Please complete all main fields (Generada Número de Orden, Destination Supplier, Monto Total).")
            return None

        try:
            monto_total = float(monto_total_text)
        except ValueError:
            QMessageBox.warning(self, "Invalid Amount", "Total amount must be a valid number.")
            return None

        products_data = []
        for row in range(self.products_gen_table.rowCount()):
            try:
                linea = self.products_gen_table.item(row, 0).text() if self.products_gen_table.item(row, 0) else ""
                codigo = self.products_gen_table.item(row, 1).text() if self.products_gen_table.item(row, 1) else ""
                numero_cliente = self.products_gen_table.item(row, 2).text() if self.products_gen_table.item(row, 2) else ""
                descripcion = self.products_gen_table.item(row, 3).text() if self.products_gen_table.item(row, 3) else ""
                cantidad = float(self.products_gen_table.item(row, 4).text()) if self.products_gen_table.item(row, 4) and self.products_gen_table.item(row, 4).text() else 0.0
                precio_unitario = float(self.products_gen_table.item(row, 5).text()) if self.products_gen_table.item(row, 5) and self.products_gen_table.item(row, 5).text() else 0.0
                precio_total = float(self.products_gen_table.item(row, 6).text()) if self.products_gen_table.item(row, 6) and self.products_gen_table.item(row, 6).text() else 0.0

                products_data.append({
                    "linea": linea,
                    "codigo": codigo,
                    "numero_cliente": numero_cliente,
                    "descripcion": descripcion,
                    "cantidad": cantidad,
                    "precio_unitario": precio_unitario,
                    "precio_total": precio_total
                })
            except (ValueError, AttributeError) as e:
                QMessageBox.warning(self, "Product Error", f"Error in product data in row {row + 1}: {e}. Ensure Cantidad, Precio Unitario and Precio Total are valid numbers.")
                logging.error(f"Error processing product data to generate PDF: {e}", exc_info=True)
                return None

        return {
            "numero_orden_generada": num_orden_generada,
            "fecha_generada": fecha_generada,
            "proveedor_destino": proveedor_destino,
            "monto_total": monto_total,
            "fecha_entrega": fecha_entrega,
            "datos_productos_json": json.dumps(products_data, ensure_ascii=False)
        }

    def preview_generated_pdf(self) -> None:
        """Generates a PDF preview and opens it in the default viewer."""
        order_data_for_pdf = self.get_order_data_for_pdf()
        if not order_data_for_pdf:
            return # get_order_data_for_pdf already showed a warning

        formato_pdf = self.formato_pdf_combobox.currentText()

        # Generate to a temporary file
        temp_dir = tempfile.gettempdir()
        temp_file_path = os.path.join(temp_dir, f"temp_PO_preview_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf")

        generation_success = False
        generation_message = ""

        # Show loading indicator
        progress_dialog = QProgressDialog("Generating PDF preview...", "Cancelar", 0, 0, self)
        progress_dialog.setWindowModality(Qt.WindowModal)
        progress_dialog.setMinimumDuration(0) # Show immediately
        progress_dialog.setValue(0)
        progress_dialog.show()
        QApplication.processEvents() # Process events to show dialog immediately

        try:
            if formato_pdf == "Demoga":
                generation_success, generation_message = create_demoga_pdf(temp_file_path, order_data_for_pdf)
            elif formato_pdf == "Emaldo":
                generation_success, generation_message = create_emaldo_pdf(temp_file_path, order_data_for_pdf)
            else:
                generation_message = "Unsupported PDF format for preview."
                logging.error(f"Unsupported PDF format for preview: {formato_pdf}")
        finally:
            progress_dialog.close() # Ensure dialog is closed

        if generation_success:
            QMessageBox.information(self, "Preview Generada", "A PDF preview has been generated. Opening in your default viewer.")
            QDesktopServices.openUrl(QUrl.fromLocalFile(temp_file_path))
            logging.info(f"PDF preview generated at: {temp_file_path}")
        else:
            QMessageBox.critical(self, "Preview Error", f"Failed to generate PDF preview: {generation_message}")


    def generate_and_save_order(self) -> None:
        """Generates the PDF and saves the generated purchase order to the database."""
        
        order_data_for_pdf = self.get_order_data_for_pdf()
        if not order_data_for_pdf:
            return # get_order_data_for_pdf already showed a warning

        # Use the generated unique number for saving
        num_orden_generada = order_data_for_pdf["numero_orden_generada"]
        fecha_generada = order_data_for_pdf["fecha_generada"]
        fecha_entrega = order_data_for_pdf["fecha_entrega"]
        proveedor_destino = order_data_for_pdf["proveedor_destino"]
        monto_total = order_data_for_pdf["monto_total"]
        datos_productos_json = order_data_for_pdf["datos_productos_json"]
        estado = self.estado_generado_combobox.currentText()
        formato_pdf = self.formato_pdf_combobox.currentText()


        # Request directory to save PDF
        output_dir = QFileDialog.getExistingDirectory(self, "Select Folder to Guardar PDF", os.path.expanduser("~"))
        if not output_dir:
            return # User cancelled

        file_name = f"PO_GENERATED_{num_orden_generada}.pdf"
        pdf_path = os.path.join(output_dir, file_name)

        generation_success = False
        generation_message = ""
        
        # Show loading indicator
        progress_dialog = QProgressDialog("Generating PDF and saving...", "Cancelar", 0, 0, self)
        progress_dialog.setWindowModality(Qt.WindowModal)
        progress_dialog.setMinimumDuration(0) 
        progress_dialog.setValue(0)
        progress_dialog.show()
        QApplication.processEvents() # Process events to show dialog immediately

        try:
            if formato_pdf == "Demoga":
                generation_success, generation_message = create_demoga_pdf(pdf_path, order_data_for_pdf)
            elif formato_pdf == "Emaldo":
                generation_success, generation_message = create_emaldo_pdf(pdf_path, order_data_for_pdf)
            else:
                generation_message = "Unsupported PDF format."
                logging.error(f"Unsupported PDF format: {formato_pdf}")
        finally:
            progress_dialog.close() # Ensure dialog is closed


        if not generation_success:
            QMessageBox.critical(self, "PDF Generation Error", f"Failed to generate PDF: {generation_message}")
            return

        # Guardar to DB using GestorBaseDeDatos
        success, message = db_manager.ejecutar_consulta(
            '''
            INSERT INTO ordenes_compra_generadas (numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, formato_pdf)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', 
            (num_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, pdf_path, "", self.selected_received_order_id, datos_productos_json, fecha_entrega, formato_pdf)
        )
        
        if success:
            QMessageBox.information(self, "Success", f"Generada purchase order saved successfully and PDF created at:\n{pdf_path}")
            self.clear_fields()
        else:
            QMessageBox.critical(self, "Guardar Error", message)
            # If the order is not saved to the DB, consider deleting the generated PDF to avoid inconsistencies
            if os.path.exists(pdf_path):
                try:
                    os.remove(pdf_path)
                    logging.info(f"Generada PDF deleted due to DB error: {pdf_path}")
                except Exception as e:
                    logging.error(f"Error deleting PDF after DB failure: {pdf_path} - {e}")


    def clear_fields(self) -> None:
        """Clears all UI fields on the Generar Orden page."""
        self.num_orden_generada_label.setText("Automatically Generada") # Reset label
        self.fecha_generada_input.setDate(QDate.currentDate())
        self.fecha_entrega_input.setDate(QDate.currentDate().addDays(7))
        self.proveedor_destino_input.clear()
        self.monto_total_generado_input.setText("0.00") # Reset total
        self.estado_generado_combobox.setCurrentIndex(0) # Pendiente
        self.formato_pdf_combobox.setCurrentIndex(0) # Demoga
        self.products_gen_table.setRowCount(0)
        self.selected_received_order_id = None
        self.received_order_label.setText("No order selected.")

class SelectReceivedOrderDialog(QDialog):
    """
    Dialog to allow the user to select a received purchase order
    from a list to use as a base for generating a new order.
    """
    def __init__(self, parent: QWidget = None):
        super().__init__(parent)
        self.setWindowTitle("Select Received Order")
        self.setFixedSize(700, 500)
        self.selected_order_id: int | None = None
        self.init_ui()
        self.apply_styles()
        self.load_orders()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QPushButton {
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QVBoxLayout()

        self.search_input = QLineEdit(self)
        self.search_input.setPlaceholderText("Buscar por número de orden o proveedor...")
        self.search_input.textChanged.connect(self.filter_orders)
        layout.addWidget(self.search_input)

        self.orders_table = QTableWidget()
        self.orders_table.setColumnCount(4)
        self.orders_table.setHorizontalHeaderLabels(["ID", "Número de Orden", "Fecha de Recepción", "Supplier"])
        self.orders_table.horizontalHeader().setStretchLastSection(True)
        self.orders_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.orders_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.orders_table.setEditTriggers(QAbstractItemView.NoEditTriggers) 
        layout.addWidget(self.orders_table)

        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(self.accept_selection)
        button_box.rejected.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addWidget(button_box)

        self.setLayout(layout)

    def load_orders(self) -> None:
        """Loads all received orders from the database."""
        orders = db_manager.obtener_todos("SELECT id, numero_orden, fecha_recibida, proveedor_origen FROM ordenes_compra_recibidas")
        self.all_orders = orders 
        self.display_orders(orders)

    def display_orders(self, orders_to_display: list[tuple]) -> None:
        """Displays a list of orders in the table."""
        self.orders_table.setRowCount(len(orders_to_display))
        for row, order in enumerate(orders_to_display):
            self.orders_table.setItem(row, 0, QTableWidgetItem(str(order[0])))
            self.orders_table.setItem(row, 1, QTableWidgetItem(order[1]))
            
            date_dt = parse_date_format(order[2])
            display_date = QDate(date_dt.year, date_dt.month, date_dt.day).toString("dd/MM/yyyy") if date_dt else order[2]
            self.orders_table.setItem(row, 2, QTableWidgetItem(display_date))
            
            self.orders_table.setItem(row, 3, QTableWidgetItem(order[3]))
        self.orders_table.resizeColumnsToContents()

    def filter_orders(self, text: str) -> None:
        """Filters displayed orders based on search text."""
        filtered_orders = []
        search_text = text.lower()
        for order in self.all_orders:
            order_number = order[1].lower()
            supplier = order[3].lower()
            if search_text in order_number or search_text in supplier:
                filtered_orders.append(order)
        self.display_orders(filtered_orders)

    def accept_selection(self) -> None:
        """Accepts the order selection and closes the dialog."""
        selected_rows = self.orders_table.selectionModel().selectedRows()
        if selected_rows:
            self.selected_order_id = int(self.orders_table.item(selected_rows[0].row(), 0).text())
            self.accept()
        else:
            QMessageBox.warning(self, "No Selection", "Please select an order from the list.")

# New Dialog for Full Order Editing (Improvement: Comprehensive Modification)
class EditOrderDetailsDialog(QDialog):
    """
    Dialog to edit all aspects of a purchase order (received or generated).
    """
    def __init__(self, order_id: int, order_type: str, parent_page: QWidget, admin_username: str):
        super().__init__(parent_page)
        self.order_id = order_id
        self.order_type = order_type
        self.parent_page = parent_page
        self.admin_username = admin_username
        self.order_details = None # Will store full order details

        self.setWindowTitle(f"Edit {order_type} Order: ID {order_id}")
        self.setMinimumSize(800, 600)
        self.init_ui()
        self.apply_styles()
        self.load_order_details()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #28a745; /* Green for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #218838;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #333333;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()
        self.form_layout = QFormLayout()

        # Common fields for both order types (initially hidden or shown dynamically)
        self.num_order_input = QLineEdit()
        self.fecha_input = QDateEdit()
        self.fecha_input.setCalendarPopup(True)
        self.proveedor_input = QLineEdit()
        self.monto_total_input = QLineEdit()
        self.monto_total_input.setValidator(QDoubleValidator(0.0, 999999999.0, 2))
        self.monto_total_input.setReadOnly(True) # Calculated from products
        self.estado_combobox = QComboBox()
        self.estado_combobox.addItems(["Pendiente", "Procesada", "Cancelared"])
        
        # Specific fields for Generada orders (initially hidden)
        self.fecha_entrega_input = QDateEdit()
        self.fecha_entrega_input.setCalendarPopup(True)
        self.estado_entrega_combobox = QComboBox()
        self.estado_entrega_combobox.addItems(["Pendiente", "In Transit", "Delivered", "Delivery Problem"])
        self.formato_pdf_combobox = QComboBox()
        self.formato_pdf_combobox.addItems(["Demoga", "Emaldo"])

        # Add rows to layout, visibility will be controlled by load_order_details
        self.form_layout.addRow("Order ID:", QLabel(str(self.order_id))) # Display ID, not editable

        self.label_num_order = QLabel("Número de Orden:")
        self.form_layout.addRow(self.label_num_order, self.num_order_input)

        self.label_fecha = QLabel("Fecha:")
        self.form_layout.addRow(self.label_fecha, self.fecha_input)

        self.label_proveedor = QLabel("Supplier:")
        self.form_layout.addRow(self.label_proveedor, self.proveedor_input)

        self.label_monto_total = QLabel("Monto Total:")
        self.form_layout.addRow(self.label_monto_total, self.monto_total_input)

        self.label_estado = QLabel("Estado:")
        self.form_layout.addRow(self.label_estado, self.estado_combobox)

        self.label_fecha_entrega = QLabel("Delivery Fecha:")
        self.form_layout.addRow(self.label_fecha_entrega, self.fecha_entrega_input)

        self.label_estado_entrega = QLabel("Delivery Estado:")
        self.form_layout.addRow(self.label_estado_entrega, self.estado_entrega_combobox)

        self.label_formato_pdf = QLabel("Formato de PDF:")
        self.form_layout.addRow(self.label_formato_pdf, self.formato_pdf_combobox)

        main_layout.addLayout(self.form_layout)

        # Products Table
        products_group = QGroupBox("Detalles del Producto")
        products_layout = QVBoxLayout()
        
        self.products_table = QTableWidget()
        self.products_table.setColumnCount(7) # Item, Part, Customer Num, Descripción, Cantidad, Precio Unitario, Precio Total
        self.products_table.setHorizontalHeaderLabels(["Item", "Parte (EDP)", "Parte del Cliente No.", "Descripción", "Cantidad", "Precio Unitario", "Precio Total"])
        self.products_table.horizontalHeader().setStretchLastSection(True)
        self.products_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        products_layout.addWidget(self.products_table)

        product_buttons_layout = QHBoxLayout()
        add_product_button = QPushButton("Agregar Producto")
        add_product_button.clicked.connect(self.add_product_row)
        product_buttons_layout.addWidget(add_product_button)
        
        remove_product_button = QPushButton("Eliminar Producto")
        remove_product_button.clicked.connect(self.remove_product_row)
        product_buttons_layout.addWidget(remove_product_button)
        
        products_layout.addLayout(product_buttons_layout)
        
        products_group.setLayout(products_layout)
        main_layout.addWidget(products_group)

        # Buttons
        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.save_changes)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        main_layout.addWidget(button_box)

        self.setLayout(main_layout)

    def load_order_details(self) -> None:
        """Loads the details of the selected order into the UI fields."""
        if self.order_type == "Recibida":
            self.order_details = obtener_detalles_orden_recibida(self.order_id)
            self.setWindowTitle(f"Edit Received Order: {self.order_details.get('numero_orden', '')}")
            self.label_num_order.setText("Número de Orden:")
            self.num_order_input.setText(self.order_details.get("numero_orden", ""))
            
            date_dt = parse_date_format(self.order_details.get("fecha_recibida", ""))
            if date_dt: self.fecha_input.setDate(QDate(date_dt.year, date_dt.month, date_dt.day))
            self.label_fecha.setText("Fecha de Recepción:")

            self.label_proveedor.setText("Proveedor de Origen:")
            self.proveedor_input.setText(self.order_details.get("proveedor_origen", ""))
            self.estado_combobox.addItems(["Pendiente", "Procesada", "Cancelared"])
            self.estado_combobox.setCurrentText(self.order_details.get("estado", "Pendiente"))

            # Hide generated-specific fields
            self.label_fecha_entrega.hide()
            self.fecha_entrega_input.hide()
            self.label_estado_entrega.hide()
            self.estado_entrega_combobox.hide()
            self.label_formato_pdf.hide()
            self.formato_pdf_combobox.hide()

        elif self.order_type == "Generada":
            self.order_details = obtener_detalles_orden_generada(self.order_id)
            self.setWindowTitle(f"Edit Generada Order: {self.order_details.get('numero_orden_generada', '')}")
            self.label_num_order.setText("Generada Número de Orden:")
            self.num_order_input.setText(self.order_details.get("numero_orden_generada", ""))

            date_dt = parse_date_format(self.order_details.get("fecha_generada", ""))
            if date_dt: self.fecha_input.setDate(QDate(date_dt.year, date_dt.month, date_dt.day))
            self.label_fecha.setText("Generada Fecha:")

            self.label_proveedor.setText("Proveedor Destino:")
            self.proveedor_input.setText(self.order_details.get("proveedor_destino", ""))
            self.estado_combobox.addItems(["Pendiente", "In Process", "Completed", "Cancelared"])
            self.estado_combobox.setCurrentText(self.order_details.get("estado", "Pendiente"))

            # Show and populate generated-specific fields
            self.label_fecha_entrega.show()
            self.fecha_entrega_input.show()
            date_dt_entrega = parse_date_format(self.order_details.get("fecha_entrega", ""))
            if date_dt_entrega: self.fecha_entrega_input.setDate(QDate(date_dt_entrega.year, date_dt_entrega.month, date_dt_entrega.day))
            
            self.label_estado_entrega.show()
            self.estado_entrega_combobox.show()
            self.estado_entrega_combobox.setCurrentText(self.order_details.get("estado_entrega", "Pendiente"))

            self.label_formato_pdf.show()
            self.formato_pdf_combobox.show()
            self.formato_pdf_combobox.setCurrentText(self.order_details.get("formato_pdf", "Demoga"))

        if not self.order_details:
            QMessageBox.critical(self, "Load Error", "Could not load order details.")
            self.reject()
            return

        self.monto_total_input.setText(f"{self.order_details.get('monto_total', 0.0):.2f}")
        
        # Load products
        products = json.loads(self.order_details.get("datos_productos_json", "[]"))
        self.products_table.setRowCount(len(products))
        for row, p in enumerate(products):
            self.products_table.setItem(row, 0, QTableWidgetItem(p.get("linea", str(row + 1))))
            self.products_table.setItem(row, 1, QTableWidgetItem(p.get("codigo", "")))
            self.products_table.setItem(row, 2, QTableWidgetItem(p.get("numero_cliente", "")))
            self.products_table.setItem(row, 3, QTableWidgetItem(p.get("descripcion", p.get("nombre", ""))))
            self.products_table.setItem(row, 4, QTableWidgetItem(f"{p.get('cantidad', 0):.2f}"))
            self.products_table.setItem(row, 5, QTableWidgetItem(f"{p.get('precio_unitario', 0.0):.2f}"))
            self.products_table.setItem(row, 6, QTableWidgetItem(f"{p.get('precio_total', 0.0):.2f}"))
            
            # Make quantity and unit price columns editable
            self.products_table.item(row, 4).setFlags(self.products_table.item(row, 4).flags() | Qt.ItemIsEditable)
            self.products_table.item(row, 5).setFlags(self.products_table.item(row, 5).flags() | Qt.ItemIsEditable)

        self.products_table.resizeColumnsToContents()

    def add_product_row(self):
        """Adds a new product row to the editable table."""
        row_count = self.products_table.rowCount()
        self.products_table.insertRow(row_count)
        self.products_table.setItem(row_count, 0, QTableWidgetItem(str(row_count + 1))) 
        for col in range(1, self.products_table.columnCount()):
            if col in [4, 5, 6]: # Cantidad, Precio Unitario, Precio Total
                self.products_table.setItem(row_count, col, QTableWidgetItem("0.00"))
            else:
                self.products_table.setItem(row_count, col, QTableWidgetItem(""))
        
        # Make Cantidad and Precio Unitario editable for input
        qty_item = self.products_table.item(row_count, 4)
        if qty_item:
            qty_item.setFlags(qty_item.flags() | Qt.ItemIsEditable)
        unit_price_item = self.products_table.item(row_count, 5)
        if unit_price_item:
            unit_price_item.setFlags(unit_price_item.flags() | Qt.ItemIsEditable)

    def remove_product_row(self):
        """Removes the selected row from the product table."""
        selected_rows = self.products_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Delete Row", "Please select one or more rows to delete.")
            return

        for index in sorted([row.row() for row in selected_rows], reverse=True):
            self.products_table.removeRow(index)
        
        for row in range(self.products_table.rowCount()):
            item_num_item = self.products_table.item(row, 0)
            if item_num_item:
                item_num_item.setText(str(row + 1))
            else:
                self.products_table.setItem(row, 0, QTableWidgetItem(str(row + 1)))
        
        self.recalculate_total()

    def recalculate_total(self):
        """Recalculates the total amount of products in the table."""
        total_sum = 0.0
        for row in range(self.products_table.rowCount()):
            try:
                qty_item = self.products_table.item(row, 4)
                price_unit_item = self.products_table.item(row, 5)
                
                qty = float(qty_item.text()) if qty_item and qty_item.text() else 0.0
                unit_price = float(price_unit_item.text()) if price_unit_item and price_unit_item.text() else 0.0
                
                row_total = qty * unit_price
                total_item = self.products_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_table.setItem(row, 6, total_item)
                total_item.setText(f"{row_total:.2f}")
                
                total_sum += row_total
            except (ValueError, AttributeError):
                logging.warning(f"Non-numeric input in row {row} of the product table. Row total reset to 0.00.")
                total_item = self.products_table.item(row, 6)
                if not total_item:
                    total_item = QTableWidgetItem()
                    self.products_table.setItem(row, 6, total_item)
                total_item.setText("0.00")
                continue
        self.monto_total_input.setText(f"{total_sum:.2f}")

    def save_changes(self):
        """Guardars all order changes to the database."""
        auth_dialog = ContraseñaAuthDialog(self.admin_username, self)
        if auth_dialog.exec_() == QDialog.Accepted:
            updated_data = {}
            products_data = []

            # Collect main order details
            if self.order_type == "Recibida":
                updated_data["numero_orden"] = self.num_order_input.text().strip()
                updated_data["fecha_recibida"] = self.fecha_input.date().toString(Qt.ISODate)
                updated_data["proveedor_origen"] = self.proveedor_input.text().strip()
                updated_data["monto_total"] = float(self.monto_total_input.text())
                updated_data["estado"] = self.estado_combobox.currentText()
            elif self.order_type == "Generada":
                updated_data["numero_orden_generada"] = self.num_order_input.text().strip()
                updated_data["fecha_generada"] = self.fecha_input.date().toString(Qt.ISODate)
                updated_data["proveedor_destino"] = self.proveedor_input.text().strip()
                updated_data["monto_total"] = float(self.monto_total_input.text())
                updated_data["estado"] = self.estado_combobox.currentText()
                updated_data["fecha_entrega"] = self.fecha_entrega_input.date().toString(Qt.ISODate)
                updated_data["estado_entrega"] = self.estado_entrega_combobox.currentText()
                updated_data["formato_pdf"] = self.formato_pdf_combobox.currentText()

            # Collect product data
            for row in range(self.products_table.rowCount()):
                try:
                    p = {}
                    p["linea"] = self.products_table.item(row, 0).text() if self.products_table.item(row, 0) else ""
                    p["codigo"] = self.products_table.item(row, 1).text() if self.products_table.item(row, 1) else ""
                    p["numero_cliente"] = self.products_table.item(row, 2).text() if self.products_table.item(row, 2) else ""
                    p["descripcion"] = self.products_table.item(row, 3).text() if self.products_table.item(row, 3) else ""
                    p["cantidad"] = float(self.products_table.item(row, 4).text()) if self.products_table.item(row, 4) and self.products_table.item(row, 4).text() else 0.0
                    p["precio_unitario"] = float(self.products_table.item(row, 5).text()) if self.products_table.item(row, 5) and self.products_table.item(row, 5).text() else 0.0
                    p["precio_total"] = float(self.products_table.item(row, 6).text()) if self.products_table.item(row, 6) and self.products_table.item(row, 6).text() else 0.0
                    products_data.append(p)
                except (ValueError, AttributeError) as e:
                    QMessageBox.warning(self, "Product Error", f"Error in product data in row {row + 1}: {e}. Ensure Cantidad, Precio Unitario and Precio Total are valid numbers.")
                    logging.error(f"Error collecting product data to update: {e}", exc_info=True)
                    return

            updated_data["datos_productos_json"] = json.dumps(products_data, ensure_ascii=False)
            
            # Perform database update
            success, message = actualizar_orden_en_bd(self.order_id, self.order_type, updated_data)

            if success:
                QMessageBox.information(self, "Success", message)
                # If it's a generated order, ask to regenerate PDF
                if self.order_type == "Generada":
                    regenerate_confirm = QMessageBox.question(self, "Regenerate PDF",
                                                              "The order has been modified. Do you want to regenerate the PDF file with the changes?",
                                                              QMessageBox.Yes | QMessageBox.No)
                    if regenerate_confirm == QMessageBox.Yes:
                        # Fetch the latest data after DB update
                        current_order_data = obtener_detalles_orden_generada(self.order_id)
                        if current_order_data:
                            # Use existing path if available, otherwise prompt for new
                            existing_pdf_path = current_order_data.get("ruta_archivo_generado", "")
                            
                            output_dir = os.path.dirname(existing_pdf_path) if existing_pdf_path and os.path.exists(existing_pdf_path) else os.path.expanduser("~")
                            file_name = f"PO_GENERATED_{current_order_data['numero_orden_generada']}.pdf"
                            pdf_path = os.path.join(output_dir, file_name)

                            generation_success = False
                            generation_message = ""

                            # Show loading indicator
                            progress_dialog = QProgressDialog("Regenerating PDF...", "Cancelar", 0, 0, self)
                            progress_dialog.setWindowModality(Qt.WindowModal)
                            progress_dialog.setMinimumDuration(0)
                            progress_dialog.setValue(0)
                            progress_dialog.show()
                            QApplication.processEvents()

                            try:
                                if current_order_data["formato_pdf"] == "Demoga":
                                    generation_success, generation_message = create_demoga_pdf(pdf_path, current_order_data)
                                elif current_order_data["formato_pdf"] == "Emaldo":
                                    generation_success, generation_message = create_emaldo_pdf(pdf_path, current_order_data)
                            finally:
                                progress_dialog.close()

                            if generation_success:
                                QMessageBox.information(self, "PDF Regenerated", f"PDF regenerated successfully at:\n{pdf_path}")
                                # Update DB with new PDF path if it changed (e.g., if user chose a new dir)
                                if existing_pdf_path != pdf_path:
                                    db_manager.ejecutar_consulta(
                                        "UPDATE ordenes_compra_generadas SET ruta_archivo_generado = ? WHERE id = ?",
                                        (pdf_path, self.order_id)
                                    )
                                QDesktopServices.openUrl(QUrl.fromLocalFile(pdf_path))
                            else:
                                QMessageBox.warning(self, "PDF Regeneration Error", f"Could not regenerate PDF: {generation_message}")
                                logging.error(f"Failed to regenerate PDF for order ID {self.order_id}: {generation_message}")
                        else:
                            QMessageBox.warning(self, "Error", "Could not get updated order data to regenerate PDF.")
                            logging.error(f"Could not get updated order data for order ID {self.order_id} to regenerate PDF.")

                self.parent_page.cargar_historial() # Refresh the history table in the main window
                self.accept()
            else:
                QMessageBox.warning(self, "Guardar Error", message)
        else:
            QMessageBox.warning(self, "Authorization Failed", "Modification was canceled or password was incorrect.")


class VerHistorialOrdenesPage(QWidget):
    """
    Page to view the history of purchase orders (received and generated),
    filter, search, and export. Also allows editing and deleting.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.current_user_role: str | None = main_window.user_role
        self.current_username: str | None = main_window.username_logged_in
        self.all_history_data: list[list] = [] # Store all history data for filtering
        self.init_ui()
        self.apply_styles()
        self.cargar_historial() 

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QDateEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QDateEdit::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 20px;
                border-left-width: 1px;
                border-left-color: #555555;
                border-left-style: solid;
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
            }
            QDateEdit::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z3IgeD0iMHB4IiB5PSIwCHB4IiB2aWV3Qm94PSIwIDAgMTkgMTkinIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDppuZXcgMCAwIDE5IDE5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI0YwRjBGMCIgZD0iTTEwLjQsMTMuNGwtNC43LTQuN2MxLTYuMywwLjMtMC44LD Pedro-MCX-PO-74907-344-0-NOY-0.6-2.1-0.5-4.7-0.1-6.8-4.7TDkuNCw3LjZjLTkuNSw0LjctOS45LDUtMC.xLDUuOSw0LjcsMC.xLDguOC0yLjUsNi44LTA.OVoiLz48L3N2Zz4=);
                width: 12px;
                height: 12px;
            }
            QPushButton {
                background-color: #007bff; /* Blue */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#exportButton {
                background-color: #17a2b8; /* Cyan */
            }
            QPushButton#exportButton:hover {
                background-color: #138496;
            }
            QPushButton#editButton {
                background-color: #ffc107; /* Yellow/Orange */
                color: #333333;
            }
            QPushButton#editButton:hover {
                background-color: #e0a800;
            }
            QPushButton#deleteButton {
                background-color: #dc3545; /* Red */
            }
            QPushButton#deleteButton:hover {
                background-color: #c82333;
            }
            QPushButton#viewPdfButton {
                background-color: #6f42c1; /* Purple */
            }
            QPushButton#viewPdfButton:hover {
                background-color: #563d7c;
            }
             QPushButton#changeDeliveryEstadoButton {
                background-color: #20c997; /* Teal */
            }
            QPushButton#changeDeliveryEstadoButton:hover {
                background-color: #17a2b8;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Filter and Buscar Controls
        filter_group = QGroupBox("Filtros y Búsqueda")
        filter_layout = QFormLayout()

        self.filter_type_combobox = QComboBox()
        self.filter_type_combobox.addItems(["All", "Received", "Generada"])
        self.filter_type_combobox.currentIndexChanged.connect(self.cargar_historial)
        filter_layout.addRow("Tipo de Orden:", self.filter_type_combobox)

        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("Buscar por número de orden o proveedor...")
        self.search_input.textChanged.connect(self.filter_historial)
        filter_layout.addRow("Buscar:", self.search_input)

        filter_group.setLayout(filter_layout)
        main_layout.addWidget(filter_group)
        main_layout.addSpacing(10)

        # History Table
        self.history_table = QTableWidget()
        self.history_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.history_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.history_table.setEditTriggers(QAbstractItemView.NoEditTriggers) 
        main_layout.addWidget(self.history_table)
        main_layout.addSpacing(10)

        # Action Buttons
        action_buttons_layout = QHBoxLayout()

        export_button = QPushButton("Exportar Historial (CSV)")
        export_button.setObjectName("exportButton")
        export_button.clicked.connect(self.export_history_to_csv)
        action_buttons_layout.addWidget(export_button)

        self.edit_button = QPushButton("Editar Orden")
        self.edit_button.setObjectName("editButton")
        self.edit_button.clicked.connect(self.edit_selected_order)
        action_buttons_layout.addWidget(self.edit_button)

        self.delete_button = QPushButton("Eliminar Orden")
        self.delete_button.setObjectName("deleteButton")
        # Correction: Connect to the correct method to delete orders
        self.delete_button.clicked.connect(self.delete_selected_order)
        action_buttons_layout.addWidget(self.delete_button)

        self.view_pdf_button = QPushButton("Ver PDF")
        self.view_pdf_button.setObjectName("viewPdfButton")
        self.view_pdf_button.clicked.connect(self.view_selected_order_pdf)
        action_buttons_layout.addWidget(self.view_pdf_button)
        
        self.change_delivery_status_button = QPushButton("Cambiar Estado de Entrega")
        self.change_delivery_status_button.setObjectName("changeDeliveryEstadoButton")
        self.change_delivery_status_button.clicked.connect(self.change_delivery_status_for_generated_order)
        action_buttons_layout.addWidget(self.change_delivery_status_button)


        main_layout.addLayout(action_buttons_layout)
        self.setLayout(main_layout)
        
        # Adjust button visibility based on user role
        self.update_ui_for_role()

    def update_ui_for_role(self) -> None:
        """Adjusts the visibility of UI elements based on the user's role."""
        is_admin = (self.current_user_role == 'admin')
        self.edit_button.setVisible(is_admin)
        self.delete_button.setVisible(is_admin)
        self.change_delivery_status_button.setVisible(is_admin) 

    def cargar_historial(self) -> None:
        """Loads the complete order history and displays it."""
        
        selected_type = self.filter_type_combobox.currentText()
        all_orders: list[list] = []

        if selected_type in ["All", "Received"]:
            # Select all columns explicitly to ensure consistent indexing
            received_orders_raw = db_manager.obtener_todos("SELECT id, numero_orden, fecha_recibida, proveedor_origen, monto_total, estado, ruta_archivo_original, ruta_foto, datos_productos_json FROM ordenes_compra_recibidas")
            for row in received_orders_raw:
                # Add placeholders for 'fecha_entrega', 'estado_entrega', 'formato_pdf' to match 'Generada' structure
                all_orders.append(list(row) + ["Received", "", "", ""]) 

        if selected_type in ["All", "Generada"]:
            # Select all columns explicitly to ensure consistent indexing
            generated_orders_raw = db_manager.obtener_todos("SELECT id, numero_orden_generada, fecha_generada, proveedor_destino, monto_total, estado, ruta_archivo_generado, ruta_foto, orden_recibida_id, datos_productos_json, fecha_entrega, estado_entrega, formato_pdf FROM ordenes_compra_generadas")
            for row in generated_orders_raw:
                 # Adjust order to match 'Received' for display (Tipo at index 5)
                all_orders.append([
                    row[0], # id
                    row[1], # numero_orden_generada
                    row[2], # fecha_generada
                    row[3], # proveedor_destino
                    row[4], # monto_total
                    "Generada", # type (manual string)
                    row[6], # ruta_archivo_generado
                    row[7], # ruta_foto
                    row[9], # datos_productos_json
                    row[10], # fecha_entrega
                    row[11], # estado_entrega
                    row[12] # formato_pdf
                ])

        # Sort orders by date, then by type
        all_orders.sort(key=lambda x: (
            parse_date_format(x[2]) if parse_date_format(x[2]) else datetime.min, # Use datetime objects for proper sorting
            x[5] == 'Generada' # Received orders first, then Generada
        ))

        headers = ["ID", "Número de Orden", "Fecha", "Proveedor/Destino", "Monto Total", "Tipo", "Ruta del Archivo", "Delivery Fecha", "Delivery Estado", "PDF Format"]
        self.history_table.setColumnCount(len(headers))
        self.history_table.setHorizontalHeaderLabels(headers)
        
        self.all_history_data = all_orders # Store all orders for filtering

        self.display_filtered_history(all_orders)
        self.history_table.resizeColumnsToContents()
        self.history_table.horizontalHeader().setStretchLastSection(True)


    def display_filtered_history(self, filtered_data: list[list]) -> None:
        """Displays the filtered data in the history table."""
        self.history_table.setRowCount(len(filtered_data))
        for row_idx, row_data in enumerate(filtered_data):
            
            # Common fields (adjusted indices for the combined structure)
            self.history_table.setItem(row_idx, 0, QTableWidgetItem(str(row_data[0]))) # ID
            self.history_table.setItem(row_idx, 1, QTableWidgetItem(row_data[1]))      # Número de Orden
            
            # Fecha (date_created/received)
            date_dt = parse_date_format(row_data[2])
            display_date = QDate(date_dt.year, date_dt.month, date_dt.day).toString("dd/MM/yyyy") if date_dt else row_data[2]
            self.history_table.setItem(row_idx, 2, QTableWidgetItem(display_date))     
            
            self.history_table.setItem(row_idx, 3, QTableWidgetItem(row_data[3]))      # Proveedor/Destino
            self.history_table.setItem(row_idx, 4, QTableWidgetItem(f"{row_data[4]:.2f}")) # Monto Total
            self.history_table.setItem(row_idx, 5, QTableWidgetItem(row_data[5]))      # Tipo (Received/Generada)

            # Specific fields (adjusted indices)
            # For received orders, row_data[6] is ruta_archivo_original
            # For generated orders, row_data[6] is ruta_archivo_generado
            ruta_archivo = row_data[6] if len(row_data) > 6 else ""
            self.history_table.setItem(row_idx, 6, QTableWidgetItem(ruta_archivo))     # Ruta del Archivo

            # These fields are only relevant for 'Generada' orders
            # They will be empty strings for 'Received' orders in all_history_data
            fecha_entrega = row_data[9] if len(row_data) > 9 else "" # Adjusted index for combined list
            if fecha_entrega:
                date_dt_delivery = parse_date_format(fecha_entrega)
                display_date_delivery = QDate(date_dt_delivery.year, date_dt_delivery.month, date_dt_delivery.day).toString("dd/MM/yyyy") if date_dt_delivery else fecha_entrega
                self.history_table.setItem(row_idx, 7, QTableWidgetItem(display_date_delivery)) # Delivery Fecha
            else:
                self.history_table.setItem(row_idx, 7, QTableWidgetItem("N/A"))

            estado_entrega = row_data[10] if len(row_data) > 10 else "N/A" # Adjusted index
            self.history_table.setItem(row_idx, 8, QTableWidgetItem(estado_entrega)) # Delivery Estado

            formato_pdf = row_data[11] if len(row_data) > 11 else "N/A" # Adjusted index
            self.history_table.setItem(row_idx, 9, QTableWidgetItem(formato_pdf)) # PDF Format


    def filter_historial(self, text: str) -> None:
        """Filters order history based on search text."""
        search_text = text.lower()
        filtered_orders = []
        for order in self.all_history_data:
            order_number = str(order[1]).lower()
            supplier = str(order[3]).lower()
            if search_text in order_number or search_text in supplier:
                filtered_orders.append(order)
        self.display_filtered_history(filtered_orders)

    def export_history_to_csv(self) -> None:
        """Exports the current order history to a CSV file."""
        options = QFileDialog.Options()
        file_path, _ = QFileDialog.getGuardarFileName(self, "Export History to CSV", "order_history.csv",
                                                   "CSV Files (*.csv);;All Files (*)", options=options)
        if file_path:
            try:
                with open(file_path, 'w', newline='', encoding='utf-8') as csvfile:
                    csv_writer = csv.writer(csvfile)
                    
                    headers = [self.history_table.horizontalHeaderItem(col).text() for col in range(self.history_table.columnCount())]
                    csv_writer.writerow(headers)
                    
                    for row in range(self.history_table.rowCount()):
                        row_data = []
                        for col in range(self.history_table.columnCount()):
                            item = self.history_table.item(row, col)
                            row_data.append(item.text() if item else "")
                        csv_writer.writerow(row_data)
                
                QMessageBox.information(self, "Success", f"History successfully exported to:\n{file_path}")
                logging.info(f"History exported to CSV: {file_path}")
            except Exception as e:
                QMessageBox.critical(self, "Export Error", f"An error occurred while exporting history: {e}")
                logging.error(f"Error exporting history to CSV: {e}", exc_info=True)

    def edit_selected_order(self) -> None:
        """Opens a dialog to edit all aspects of the selected order."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select an order to edit.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_type = self.history_table.item(row, 5).text()
        
        # Open the new comprehensive edit dialog
        dialog = EditOrderDetailsDialog(order_id, order_type, self, self.main_window.username_logged_in) # Pass the admin username
        dialog.exec_()
        # The dialog will call self.cargar_historial() on success

    def delete_selected_order(self) -> None:
        """Deletes the selected order from the database."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select an order to delete.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_number = self.history_table.item(row, 1).text()
        order_type = self.history_table.item(row, 5).text()

        confirm = QMessageBox.question(self, "Confirm Deletion",
                                       f"Are you sure you want to delete order {order_number} ({order_type})?",
                                       QMessageBox.Yes | QMessageBox.No)
        if confirm == QMessageBox.Yes:
            if not self.current_username:
                QMessageBox.critical(self, "Session Error", "Could not get current user. Please restart the application.")
                logging.error("Could not get logged in admin username to delete an order.")
                return

            auth_dialog = ContraseñaAuthDialog(self.current_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = eliminar_orden_por_id(order_id, order_type)
                if success:
                    QMessageBox.information(self, "Success", message)
                    self.cargar_historial() 
                else:
                    QMessageBox.warning(self, "Delete Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to delete orders.")


    def view_selected_order_pdf(self) -> None:
        """Opens the PDF file associated with the selected order."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select an order to view its PDF.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_type = self.history_table.item(row, 5).text()
        
        pdf_path = ""
        if order_type == "Recibida":
            order_data = obtener_detalles_orden_recibida(order_id)
            if order_data:
                pdf_path = order_data.get("ruta_archivo_original", "")
        elif order_type == "Generada":
            order_data = obtener_detalles_orden_generada(order_id)
            if order_data:
                pdf_path = order_data.get("ruta_archivo_generado", "")
        
        if pdf_path and os.path.exists(pdf_path):
            QDesktopServices.openUrl(QUrl.fromLocalFile(pdf_path))
            logging.info(f"Opening PDF: {pdf_path}")
        else:
            QMessageBox.warning(self, "PDF Not Found", "The PDF file path is invalid or the file does not exist.")
            if pdf_path:
                logging.warning(f"Invalid/non-existent PDF path: {pdf_path}")
            else:
                logging.warning(f"No PDF path found for order ID: {order_id}, Tipo: {order_type}")


    def change_delivery_status_for_generated_order(self) -> None:
        """Changes the delivery status of a selected generated order."""
        selected_rows = self.history_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Seleccionar Orden", "Please select a generated order to change its delivery status.")
            return

        row = selected_rows[0].row()
        order_id = int(self.history_table.item(row, 0).text())
        order_type = self.history_table.item(row, 5).text()

        if order_type != "Generada":
            QMessageBox.warning(self, "Incorrect Tipo de Orden", "Only generated orders can have their delivery status changed.")
            return
        
        current_status = self.history_table.item(row, 8).text() 

        status_dialog = QDialog(self)
        status_dialog.setWindowTitle("Cambiar Estado de Entrega")
        status_dialog_layout = QFormLayout()
        
        status_combobox = QComboBox(status_dialog)
        status_combobox.addItems(["Pendiente", "In Transit", "Delivered", "Delivery Problem"])
        status_combobox.setCurrentText(current_status)
        
        status_dialog_layout.addRow("New Estado:", status_combobox)

        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(status_dialog.accept)
        button_box.rejected.connect(status_dialog.reject)
        status_dialog_layout.addRow(button_box)
        
        status_dialog.setLayout(status_dialog_layout)

        if status_dialog.exec_() == QDialog.Accepted:
            new_status = status_combobox.currentText()
            if not self.current_username:
                QMessageBox.critical(self, "Session Error", "Could not get current user. Please restart the application.")
                logging.error("Could not get logged in admin username to change delivery status.")
                return

            auth_dialog = ContraseñaAuthDialog(self.current_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = actualizar_estado_entrega_orden(order_id, new_status)
                if success:
                    QMessageBox.information(self, "Success", f"Delivery status of order {order_id} updated to '{new_status}'.")
                    self.cargar_historial() 
                else:
                    QMessageBox.warning(self, "Update Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to change delivery status.")


class AddEditProductDialog(QDialog):
    """
    Dialog to add a new product or edit an existing one in the catalog.
    """
    def __init__(self, admin_username: str, product_id: int = None, parent: QWidget = None):
        super().__init__(parent)
        self.product_id = product_id
        self.admin_username = admin_username
        self.setWindowTitle("Add/Edit Product")
        self.setFixedSize(400, 250)
        self.init_ui()
        self.apply_styles()
        if self.product_id:
            self.load_product_data()

    def apply_styles(self):
        self.setStyleSheet("""
            QDialog {
                background-color: #333333;
                color: #F0F0F0;
                border-radius: 8px;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #28a745; /* Green for Guardar */
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #218838;
            }
            QDialogButtonBox QPushButton#cancelButton {
                background-color: #6c757d;
            }
            QDialogButtonBox QPushButton#cancelButton:hover {
                background-color: #5a6268;
            }
            QMessageBox {
                background-color: #333333;
                color: #F0F0F0;
            }
            QMessageBox QLabel {
                color: #F0F0F0;
            }
            QMessageBox QPushButton {
                background-color: #007bff;
                color: white;
                border-radius: 5px;
                padding: 5px 10px;
            }
        """)

    def init_ui(self):
        layout = QFormLayout()

        self.edp_input = QLineEdit()
        self.edp_input.setPlaceholderText("Enter EDP (e.g., 12345ABC)")
        layout.addRow("EDP:", self.edp_input)

        self.numero_cliente_input = QLineEdit()
        self.numero_cliente_input.setPlaceholderText("Enter Número de Cliente (Optional)")
        layout.addRow("Número de Cliente:", self.numero_cliente_input)

        self.descripcion_input = QLineEdit()
        self.descripcion_input.setPlaceholderText("Enter Descripción")
        layout.addRow("Descripción:", self.descripcion_input)

        self.costo_input = QLineEdit()
        self.costo_input.setValidator(QDoubleValidator(0.0, 99999999.0, 2))
        self.costo_input.setPlaceholderText("Enter Costo (e.g., 12.34)")
        layout.addRow("Costo:", self.costo_input)

        button_box = QDialogButtonBox(QDialogButtonBox.Save | QDialogButtonBox.Cancel)
        button_box.button(QDialogButtonBox.Save).clicked.connect(self.save_product)
        button_box.button(QDialogButtonBox.Cancel).clicked.connect(self.reject)
        button_box.button(QDialogButtonBox.Cancel).setObjectName("cancelButton")
        layout.addRow(button_box)

        self.setLayout(layout)

    def load_product_data(self):
        product_data = obtener_producto_por_id(self.product_id)
        if product_data:
            self.edp_input.setText(product_data.get("edp", ""))
            self.numero_cliente_input.setText(product_data.get("numero_cliente", ""))
            self.descripcion_input.setText(product_data.get("descripcion", ""))
            self.costo_input.setText(f"{product_data.get('costo', 0.0):.2f}")
        else:
            QMessageBox.critical(self, "Error", "Could not load product data for editing.")
            self.reject()

    def save_product(self):
        edp = self.edp_input.text().strip()
        numero_cliente = self.numero_cliente_input.text().strip()
        descripcion = self.descripcion_input.text().strip()
        costo_text = self.costo_input.text().strip()

        if not edp or not descripcion or not costo_text:
            QMessageBox.warning(self, "Incomplete Fields", "Please fill in EDP, Descripción, and Costo.")
            return

        try:
            costo = float(costo_text)
        except ValueError:
            QMessageBox.warning(self, "Invalid Costo", "Costo must be a valid number.")
            return
        
        # Authorization check
        auth_dialog = ContraseñaAuthDialog(self.admin_username, self)
        if auth_dialog.exec_() != QDialog.Accepted:
            QMessageBox.warning(self, "Authorization Failed", "Not authorized to save product.")
            return

        if self.product_id: # Edit existing product
            success, message = actualizar_producto_del_catalogo(self.product_id, edp, numero_cliente, descripcion, costo)
            action_type = "updated"
        else: # Add new product
            success, message = agregar_producto_al_catalogo(edp, numero_cliente, descripcion, costo)
            action_type = "added"
        
        if success:
            QMessageBox.information(self, "Success", f"Product successfully {action_type}.")
            self.accept()
        else:
            QMessageBox.critical(self, "Error", f"Failed to {action_type} product: {message}")


class GestionarProductosPage(QWidget):
    """
    Page for administrators to manage the product catalog.
    Allows adding, editing, and deleting products.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.current_admin_username = main_window.username_logged_in
        self.init_ui()
        self.apply_styles()
        self.load_products()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Add */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#editProductButton {
                background-color: #ffc107; /* Yellow for Edit */
                color: #333333;
            }
            QPushButton#editProductButton:hover {
                background-color: #e0a800;
            }
            QPushButton#deleteProductButton {
                background-color: #dc3545; /* Red for Delete */
            }
            QPushButton#deleteProductButton:hover {
                background-color: #c82333;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Product List Group
        product_list_group = QGroupBox("Catálogo de Productos")
        product_list_layout = QVBoxLayout()

        self.product_table = QTableWidget()
        self.product_table.setColumnCount(5)
        self.product_table.setHorizontalHeaderLabels(["ID", "EDP", "Número de Cliente", "Descripción", "Costo"])
        self.product_table.horizontalHeader().setStretchLastSection(True)
        self.product_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.product_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.product_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        product_list_layout.addWidget(self.product_table)

        product_actions_layout = QHBoxLayout()
        add_product_button = QPushButton("Agregar Producto")
        add_product_button.clicked.connect(self.add_product)
        product_actions_layout.addWidget(add_product_button)

        self.edit_product_button = QPushButton("Editar Producto Seleccionado")
        self.edit_product_button.setObjectName("editProductButton")
        self.edit_product_button.clicked.connect(self.edit_product)
        product_actions_layout.addWidget(self.edit_product_button)

        self.delete_product_button = QPushButton("Eliminar Producto Seleccionado")
        self.delete_product_button.setObjectName("deleteProductButton")
        self.delete_product_button.clicked.connect(self.delete_product)
        product_actions_layout.addWidget(self.delete_product_button)

        product_list_layout.addLayout(product_actions_layout)
        product_list_group.setLayout(product_list_layout)
        main_layout.addWidget(product_list_group)

        self.setLayout(main_layout)

    def load_products(self) -> None:
        """Loads all products from the catalog into the table."""
        products = obtener_todos_los_productos()
        self.product_table.setRowCount(len(products))
        for row, product in enumerate(products):
            self.product_table.setItem(row, 0, QTableWidgetItem(str(product['id'])))
            self.product_table.setItem(row, 1, QTableWidgetItem(product['edp']))
            self.product_table.setItem(row, 2, QTableWidgetItem(product.get('numero_cliente', '')))
            self.product_table.setItem(row, 3, QTableWidgetItem(product['descripcion']))
            self.product_table.setItem(row, 4, QTableWidgetItem(f"{product['costo']:.2f}"))
        self.product_table.resizeColumnsToContents()

    def add_product(self) -> None:
        """Opens dialog to add a new product."""
        dialog = AddEditProductDialog(self.current_admin_username, parent=self)
        if dialog.exec_() == QDialog.Accepted:
            self.load_products()

    def edit_product(self) -> None:
        """Opens dialog to edit the selected product."""
        selected_rows = self.product_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select Product", "Please select a product to edit.")
            return

        row = selected_rows[0].row()
        product_id = int(self.product_table.item(row, 0).text())
        
        dialog = AddEditProductDialog(self.current_admin_username, product_id, parent=self)
        if dialog.exec_() == QDialog.Accepted:
            self.load_products()

    def delete_product(self) -> None:
        """Deletes the selected product from the catalog."""
        selected_rows = self.product_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select Product", "Please select a product to delete.")
            return

        row = selected_rows[0].row()
        product_id = int(self.product_table.item(row, 0).text())
        edp_to_delete = self.product_table.item(row, 1).text()

        confirm = QMessageBox.question(self, "Confirm Deletion",
                                       f"Are you sure you want to delete product with EDP '{edp_to_delete}'?",
                                       QMessageBox.Yes | QMessageBox.No)
        if confirm == QMessageBox.Yes:
            auth_dialog = ContraseñaAuthDialog(self.current_admin_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = eliminar_producto_del_catalogo(product_id)
                if success:
                    QMessageBox.information(self, "Success", f"Product '{edp_to_delete}' deleted successfully.")
                    self.load_products()
                else:
                    QMessageBox.warning(self, "Delete Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to delete products.")


class AdminUsersPage(QWidget):
    """
    Page for administrators to manage application users:
    create, update (reset password, change role), and delete users.
    """
    def __init__(self, main_window: QMainWindow):
        super().__init__()
        self.main_window = main_window
        self.current_admin_username = main_window.username_logged_in # Admin currently logged in
        self.init_ui()
        self.apply_styles()
        self.load_users()

    def apply_styles(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2e2e2e;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QLabel {
                color: #F0F0F0;
                font-size: 14px;
            }
            QLineEdit, QComboBox {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                padding: 8px;
                color: #F0F0F0;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007bff; /* Blue for Add/Guardar */
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton#resetPassButton {
                background-color: #ffc107; /* Yellow for Reset */
                color: #333333;
            }
            QPushButton#resetPassButton:hover {
                background-color: #e0a800;
            }
            QPushButton#deleteUserButton {
                background-color: #dc3545; /* Red for Delete */
            }
            QPushButton#deleteUserButton:hover {
                background-color: #c82333;
            }
            QTableWidget {
                background-color: #444444;
                border: 1px solid #555555;
                border-radius: 5px;
                color: #F0F0F0;
                font-size: 13px;
                gridline-color: #555555;
            }
            QTableWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background-color: #555555;
                color: #F0F0F0;
                padding: 5px;
                border: 1px solid #666666;
                font-weight: bold;
                font-size: 14px;
            }
            QTableWidget::item:selected {
                background-color: #007bff;
                color: white;
            }
            QComboBox {
                selection-background-color: #007bff;
                selection-color: white;
            }
            QComboBox QAbstractItemView {
                background-color: #444444;
                color: #F0F0F0;
                border: 1px solid #555555;
                selection-background-color: #007bff;
            }
            QGroupBox {
                border: 1px solid #555555;
                border-radius: 5px;
                margin-top: 10px;
                padding: 5px;
                color: #F0F0F0;
                font-size: 16px;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                background-color: #2e2e2e;
            }
        """)

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Group for New User Form
        new_user_group = QGroupBox("Crear Nuevo Usuario")
        new_user_layout = QFormLayout()

        self.new_username_input = QLineEdit()
        self.new_username_input.setPlaceholderText("Nombre de usuario")
        new_user_layout.addRow("Usuario:", self.new_username_input)

        self.new_password_input = QLineEdit()
        self.new_password_input.setEchoMode(QLineEdit.Password)
        self.new_password_input.setPlaceholderText("Contraseña")
        new_user_layout.addRow("Contraseña:", self.new_password_input)

        self.new_role_combobox = QComboBox()
        self.new_role_combobox.addItems(["user", "admin"])
        new_user_layout.addRow("Rol:", self.new_role_combobox)

        self.create_user_button = QPushButton("Create User")
        self.create_user_button.clicked.connect(self.create_new_user)
        new_user_layout.addRow(self.create_user_button)

        new_user_group.setLayout(new_user_layout)
        main_layout.addWidget(new_user_group)
        main_layout.addSpacing(10)

        # Group for User List and Actions
        user_list_group = QGroupBox("User List")
        user_list_layout = QVBoxLayout()

        self.user_table = QTableWidget()
        self.user_table.setColumnCount(3)
        self.user_table.setHorizontalHeaderLabels(["ID", "User", "Role"])
        self.user_table.horizontalHeader().setStretchLastSection(True)
        self.user_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.user_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.user_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        user_list_layout.addWidget(self.user_table)

        user_actions_layout = QHBoxLayout()
        self.reset_password_button = QPushButton("Reset Contraseña")
        self.reset_password_button.setObjectName("resetPassButton")
        self.reset_password_button.clicked.connect(self.open_reset_password_dialog)
        user_actions_layout.addWidget(self.reset_password_button)

        self.delete_user_button = QPushButton("Eliminar Usuario")
        self.delete_user_button.setObjectName("deleteUserButton")
        self.delete_user_button.clicked.connect(self.delete_selected_user)
        user_actions_layout.addWidget(self.delete_user_button)

        user_list_layout.addLayout(user_actions_layout)
        user_list_group.setLayout(user_list_layout)
        main_layout.addWidget(user_list_group)

        self.setLayout(main_layout)

    def load_users(self) -> None:
        """Loads all users from the database into the table."""
        users = obtener_todos_los_usuarios()
        self.user_table.setRowCount(len(users))
        for row, user in enumerate(users):
            self.user_table.setItem(row, 0, QTableWidgetItem(str(user['id'])))
            self.user_table.setItem(row, 1, QTableWidgetItem(user['username']))
            self.user_table.setItem(row, 2, QTableWidgetItem(user['rol']))
        self.user_table.resizeColumnsToContents()

    def create_new_user(self) -> None:
        """Creates a new user with the form data."""
        username = self.new_username_input.text().strip()
        password = self.new_password_input.text().strip()
        rol = self.new_role_combobox.currentText()

        if not username or not password:
            QMessageBox.warning(self, "Empty Fields", "Please enter username and password.")
            return

        success, message = crear_usuario(username, password, rol)
        if success:
            QMessageBox.information(self, "Success", "User created successfully.")
            self.new_username_input.clear()
            self.new_password_input.clear()
            self.load_users() # Reload user table
        else:
            QMessageBox.warning(self, "Create User Error", message)

    def open_reset_password_dialog(self) -> None:
        """Opens the dialog to reset the selected user's password."""
        selected_rows = self.user_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select User", "Please select a user to reset their password.")
            return

        row = selected_rows[0].row()
        user_id = int(self.user_table.item(row, 0).text())
        username_to_reset = self.user_table.item(row, 1).text()

        if username_to_reset == self.current_admin_username:
            QMessageBox.warning(self, "Action Not Allowed", "You cannot reset your own password from here. Use 'Cambiar mi Contraseña'.")
            return

        dialog = ResetContraseñaDialog(user_id, username_to_reset, self.current_admin_username, self)
        if dialog.exec_() == QDialog.Accepted:
            self.load_users() # Reload user table if password was reset

    def delete_selected_user(self) -> None:
        """Deletes the selected user from the database."""
        selected_rows = self.user_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "Select User", "Please select a user to delete.")
            return

        row = selected_rows[0].row()
        user_id = int(self.user_table.item(row, 0).text())
        username_to_delete = self.user_table.item(row, 1).text()

        if username_to_delete == self.current_admin_username:
            QMessageBox.warning(self, "Action Not Allowed", "You cannot delete your own admin account.")
            return

        confirm = QMessageBox.question(self, "Confirm Deletion",
                                       f"Are you sure you want to delete user '{username_to_delete}'?",
                                       QMessageBox.Yes | QMessageBox.No)
        if confirm == QMessageBox.Yes:
            auth_dialog = ContraseñaAuthDialog(self.current_admin_username, self)
            if auth_dialog.exec_() == QDialog.Accepted:
                success, message = eliminar_usuario(user_id)
                if success:
                    QMessageBox.information(self, "Success", f"User '{username_to_delete}' deleted successfully.")
                    self.load_users()
                else:
                    QMessageBox.warning(self, "Eliminar Usuario Error", message)
            else:
                QMessageBox.warning(self, "Authorization Failed", "Not authorized to delete users.")


class MainWindow(QMainWindow):
    """
    Main application window that manages different pages
    and application flow.
    """
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Purchase Order Management System")
        self.setGeometry(100, 100, 1200, 800) # Adjusted initial size
        self.user_role: str | None = None
        self.username_logged_in: str | None = None
        self.init_db_and_admin()
        self.show_login_dialog()

    def init_db_and_admin(self) -> None:
        """Initializes the database and creates the default admin user if it does not exist."""
        inicializar_bd()
        success, message = crear_usuario(ConfiguracionAplicacion.USUARIO_ADMIN_POR_DEFECTO, ConfiguracionAplicacion.CONTRASENA_ADMIN_POR_DEFECTO, 'admin')
        if not success and "already exists" not in message: # Adjusted message for string comparison
            logging.error(f"Failed to secure default admin user: {message}")

    def show_login_dialog(self) -> None:
        """Shows the login dialog."""
        login_dialog = DialogoInicioSesion()
        if login_dialog.exec_() == QDialog.Accepted:
            self.user_role = login_dialog.rol_usuario
            self.username_logged_in = login_dialog.username_logged_in
            self.init_main_ui()
            self.showMaximized() # Maximize main window on login
        else:
            QMessageBox.critical(self, "Iniciar Sesión Error", "You must log in to use the application.")
            sys.exit()

    def init_main_ui(self) -> None:
        """Initializes the main user interface after successful login."""
        self.central_widget = QWidget()
        self.setCentralWidget(self.central_widget)
        self.main_layout = QHBoxLayout(self.central_widget)

        self.sidebar_layout = QVBoxLayout()
        self.stacked_widget = QStackedWidget()

        # Navigation buttons
        self.read_oc_button = QPushButton("Leer Órdenes Recibidas")
        self.read_oc_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(0))
        self.sidebar_layout.addWidget(self.read_oc_button)

        self.generate_oc_button = QPushButton("Generar Orden")
        self.generate_oc_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(1))
        self.sidebar_layout.addWidget(self.generate_oc_button)
        
        self.history_button = QPushButton("Ver Historial de Órdenes")
        self.history_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(2))
        self.sidebar_layout.addWidget(self.history_button)

        # NEW: Gestionar Productos Button
        self.manage_products_button = QPushButton("Gestionar Productos")
        self.manage_products_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(3))
        self.sidebar_layout.addWidget(self.manage_products_button)

        self.admin_users_button = QPushButton("Gestionar Usuarios")
        self.admin_users_button.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(4))
        self.sidebar_layout.addWidget(self.admin_users_button)
        
        self.change_password_button = QPushButton("Cambiar mi Contraseña")
        self.change_password_button.clicked.connect(self.open_change_password_dialog)
        self.sidebar_layout.addWidget(self.change_password_button)

        self.logout_button = QPushButton("Cerrar Sesión")
        self.logout_button.clicked.connect(self.logout)
        self.sidebar_layout.addWidget(self.logout_button)

        # Adjustment so navigation buttons take necessary space and don't stretch
        self.sidebar_layout.addStretch() 
        
        # Pages
        self.read_oc_page = LeerOCRecibidasPage(self)
        self.generate_oc_page = GenerarOCPage(self)
        self.history_page = VerHistorialOrdenesPage(self)
        self.manage_products_page = GestionarProductosPage(self) # New instance
        self.admin_users_page = AdminUsersPage(self)

        self.stacked_widget.addWidget(self.read_oc_page)
        self.stacked_widget.addWidget(self.generate_oc_page)
        self.stacked_widget.addWidget(self.history_page)
        self.stacked_widget.addWidget(self.manage_products_page) # Add new page
        self.stacked_widget.addWidget(self.admin_users_page)

        self.main_layout.addLayout(self.sidebar_layout, 1) # Sidebar takes 1/5 of width
        self.main_layout.addWidget(self.stacked_widget, 4) # Stacked widget takes 4/5 of width

        self.apply_main_window_styles()
        self.update_ui_for_role() # Apply initial role-based visibility

    def apply_main_window_styles(self) -> None:
        """Applies CSS styles to the main window and its elements."""
        self.setStyleSheet("""
            QMainWindow {
                background-color: #222222;
                color: #F0F0F0;
                font-family: Arial, sans-serif;
            }
            QPushButton {
                background-color: #555555;
                color: #F0F0F0;
                border: 1px solid #666666;
                border-radius: 5px;
                padding: 10px;
                margin: 5px;
                font-size: 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #666666;
            }
            QStackedWidget {
                background-color: #2e2e2e;
                border: 1px solid #444444;
                border-radius: 8px;
                padding: 10px;
            }
        """)

    def update_ui_for_role(self) -> None:
        """Updates the visibility of navigation buttons based on user role."""
        if self.user_role == 'admin':
            self.admin_users_button.setVisible(True)
            self.manage_products_button.setVisible(True) # Admins can manage products
        else:
            self.admin_users_button.setVisible(False)
            self.manage_products_button.setVisible(False) # Regular users cannot manage products
            # If a non-admin user somehow ended up on an admin page, redirect them
            if self.stacked_widget.currentWidget() in [self.admin_users_page, self.manage_products_page]:
                self.stacked_widget.setCurrentIndex(0) # Redirect to the first page (Leer Órdenes Recibidas)

    def open_change_password_dialog(self) -> None:
        """Opens the dialog for the user to change their own password."""
        if not self.username_logged_in:
            QMessageBox.critical(self, "Error", "No active user session to change password.")
            logging.error("Attempt to change password without logged in user.")
            return

        user_data = obtener_usuario_por_nombre(self.username_logged_in)
        if user_data:
            user_id = user_data["id"]
            dialog = ChangeContraseñaDialog(user_id, self.username_logged_in, self)
            dialog.exec_()
        else:
            QMessageBox.critical(self, "Error", "Could not get your user data.")
            logging.error(f"No user data found for '{self.username_logged_in}' when trying to change password.")


    def logout(self) -> None:
        """Logs out the user and returns to the login dialog."""
        QMessageBox.information(self, "Cerrar Sesión", "Session closed successfully.")
        self.user_role = None
        self.username_logged_in = None
        self.hide() # Hide main window
        self.show_login_dialog() # Show login dialog again


if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    inicializar_bd() 
    crear_usuario(ConfiguracionAplicacion.USUARIO_ADMIN_POR_DEFECTO, ConfiguracionAplicacion.CONTRASENA_ADMIN_POR_DEFECTO, 'admin')
    
    main_window = MainWindow()
    
    sys.exit(app.exec_())



    
    def auto_rellenar_producto_por_edp(self, row):
        edp_item = self.tabla_productos.item(row, 1)
        if not edp_item:
            return

        edp = edp_item.text().strip()
        if not edp:
            return

        try:
            import sqlite3
            conn = sqlite3.connect("data/compras.db")
            cursor = conn.cursor()
            cursor.execute("SELECT parte_cliente, descripcion, precio_venta FROM productos WHERE edp = ?", (edp,))
            resultado = cursor.fetchone()
            conn.close()
        except Exception as e:
            print("Error al consultar producto:", e)
            return

        if resultado:
            parte_cliente, descripcion, precio_venta = resultado

            self.tabla_productos.setItem(row, 2, QTableWidgetItem(str(parte_cliente)))  # Parte del Cliente No.
            self.tabla_productos.setItem(row, 3, QTableWidgetItem(str(descripcion)))    # Descripción
            self.tabla_productos.setItem(row, 5, QTableWidgetItem(str(precio_venta)))   # Precio Unitario (venta)

            cantidad_item = self.tabla_productos.item(row, 4)
            if cantidad_item:
                try:
                    cantidad = float(cantidad_item.text())
                    total = cantidad * float(precio_venta)
                    self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
                except:
                    pass

    
def revisar_entrada_tabla(self, item):
    row = item.row()
    column = item.column()
    if column == 1:  # EDP
        self.auto_rellenar_producto_por_edp(row)
    elif column == 4:  # Cantidad
        try:
            precio_item = self.tabla_productos.item(row, 5)
            if precio_item:
                precio = float(precio_item.text())
                cantidad = float(item.text())
                total = precio * cantidad
                self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
        except:
            pass
    elif column == 5:  # Precio Unitario
        try:
            cantidad_item = self.tabla_productos.item(row, 4)
            if cantidad_item:
                cantidad = float(cantidad_item.text())
                precio = float(item.text())
                total = precio * cantidad
                self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
        except:
            pass


    
def revisar_entrada_tabla(self, item):
    row = item.row()
    column = item.column()
    if column == 1:  # EDP
        self.auto_rellenar_producto_por_edp(row)
    elif column == 4:  # Cantidad
        try:
            precio_item = self.tabla_productos.item(row, 5)
            if precio_item:
                precio = float(precio_item.text())
                cantidad = float(item.text())
                total = precio * cantidad
                self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
        except:
            pass
    elif column == 5:  # Precio Unitario
        try:
            cantidad_item = self.tabla_productos.item(row, 4)
            if cantidad_item:
                cantidad = float(cantidad_item.text())
                precio = float(item.text())
                total = precio * cantidad
                self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
        except:
            pass

        row = item.row()
        column = item.column()
        if column == 1:  # EDP
            self.auto_rellenar_producto_por_edp(row)
        elif column == 4:  # Cantidad
            try:
                precio_item = self.tabla_productos.item(row, 5)
                if precio_item:
                    precio = float(precio_item.text())
                    cantidad = float(item.text())
                    total = precio * cantidad
                    self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
            except:
                pass
        elif column == 5:  # Precio Unitario
            try:
                cantidad_item = self.tabla_productos.item(row, 4)
                if cantidad_item:
                    cantidad = float(cantidad_item.text())
                    precio = float(item.text())
                    total = precio * cantidad
                    self.tabla_productos.setItem(row, 6, QTableWidgetItem(f"{total:.2f}"))
            except:
                pass
    

    def obtener_siguiente_numero_orden(self):
        try:
            import sqlite3
            conn = sqlite3.connect("data/compras.db")
            cursor = conn.cursor()
            cursor.execute("SELECT MAX(numero_orden) FROM ordenes")
            resultado = cursor.fetchone()
            conn.close()
            if resultado and resultado[0]:
                return str(int(resultado[0]) + 1)
            else:
                return "1"
        except Exception as e:
            print("Error al obtener el siguiente número de orden:", e)
            return "1"
    
    def bloquear_columnas_no_editables(self, _=None):
        for row in range(self.tabla_productos.rowCount()):
            for col in range(self.tabla_productos.columnCount()):
                item = self.tabla_productos.item(row, col)
                if not item:
                    item = QTableWidgetItem("")
                    self.tabla_productos.setItem(row, col, item)
                if col not in [1, 4, 5]:  # Solo EDP, Cantidad y Precio Unitario son editables
                    item.setFlags(item.flags() & ~Qt.ItemIsEditable)


    def validar_datos_orden(self):
        if self.tabla_productos.rowCount() == 0:
            QMessageBox.warning(self, "Validación", "Debe agregar al menos un producto.")
            return False

        for row in range(self.tabla_productos.rowCount()):
            edp_item = self.tabla_productos.item(row, 1)
            cantidad_item = self.tabla_productos.item(row, 4)
            precio_item = self.tabla_productos.item(row, 5)

            if not edp_item or not edp_item.text().strip():
                QMessageBox.warning(self, "Validación", f"EDP vacío en la fila {row+1}")
                return False
            try:
                cantidad = float(cantidad_item.text())
                precio = float(precio_item.text())
                if cantidad <= 0 or precio <= 0:
                    QMessageBox.warning(self, "Validación", f"Cantidad o precio inválido en la fila {row+1}")
                    return False
            except:
                QMessageBox.warning(self, "Validación", f"Cantidad o precio no numérico en la fila {row+1}")
                return False

        return True

class DialogoMejoras(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Mejoras de la Aplicación")
        self.setMinimumWidth(400)

        layout = QVBoxLayout()

        self.lista_mejoras = QListWidget()
        self.mejoras = [
            "Bloqueo de columnas no editables",
            "Validación antes de guardar orden",
            "Evitar productos duplicados (por EDP)",
            "Búsqueda por descripción o parte cliente",
            "Exportar orden a Excel"
        ]

        for mejora in self.mejoras:
            item = QListWidgetItem(f"🔧 {mejora} (pendiente)")
            self.lista_mejoras.addItem(item)

        self.btn_cerrar = QPushButton("Cerrar")
        self.btn_cerrar.clicked.connect(self.close)

        layout.addWidget(QLabel("Mejoras disponibles:"))
        layout.addWidget(self.lista_mejoras)
        layout.addWidget(self.btn_cerrar)

        self.setLayout(layout)

    def abrir_dialogo_mejoras(self):
        dialogo = DialogoMejoras(self)
        dialogo.exec_()
